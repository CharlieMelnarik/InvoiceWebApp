{% extends "base.html" %}
{% block content %}
<style>
  .btn .btn-loading-spinner {
    width: 0.95rem;
    height: 0.95rem;
    border-width: 0.14em;
    vertical-align: -0.1em;
  }
</style>

<div class="page-header">
  <div>
    <h1 class="h3 fw-bold mb-1">Billing</h1>
    <div class="subtitle">Manage your Basic and Pro subscriptions, trials, and payment details.</div>
  </div>
  <div class="action-group">
    {% if billing_status %}
      <span class="badge text-bg-light border">
        {{ billing_status }} - {{ (tier or subscription_tier or "basic")|upper }}
      </span>
    {% endif %}
    <a class="btn btn-outline-secondary" href="{{ url_for('settings') }}">
      Back to settings
    </a>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    {% if is_subscribed %}
      <p class="mb-3">
        Your subscription is <strong>{{ billing_status }}</strong> on the <strong>{{ (tier or subscription_tier or "basic")|capitalize }}</strong> plan.
      </p>
      <form method="post" action="{{ url_for('billing_portal') }}" class="d-inline js-stripe-loading-form">
        <button class="btn btn-primary">
          Manage billing
        </button>
      </form>
      {% if (tier or subscription_tier or "basic") == "basic" and pro_price_configured %}
        <form method="post" action="{{ url_for('billing_upgrade_pro') }}" class="d-inline ms-2 js-stripe-loading-form">
          <button class="btn btn-success">
            Upgrade to Pro
          </button>
        </form>
      {% elif (tier or subscription_tier or "basic") == "pro" and basic_price_configured %}
        <form method="post" action="{{ url_for('billing_downgrade_basic') }}" class="d-inline ms-2 js-stripe-loading-form" onsubmit="return confirm('Are you sure you want to downgrade to Basic? Stripe may apply prorated credits or charges now.');">
          <button class="btn btn-outline-warning">
            Downgrade to Basic
          </button>
        </form>
      {% endif %}
      <div class="mt-2 small-muted">
        Use Stripe billing to switch plans, update card details, or cancel.
      </div>
    {% else %}
      <p class="mb-2">Your account does not have an active subscription.</p>
    {% endif %}

    <hr class="my-4" />

    <div class="row g-3">
      <div class="col-12 col-lg-6">
        <div class="border rounded p-3 h-100">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <div class="fw-semibold">Basic Plan</div>
            <span class="badge text-bg-light border">$9.99/mo</span>
          </div>
          <div class="small-muted mb-2">Core InvoiceRunner tools.</div>
          <ul class="small-muted mb-3">
            <li>Invoices, estimates, PDF downloads, and customer portal view link</li>
            <li>No online card payment button in the customer portal</li>
            <li>No employee management tools</li>
          </ul>
          {% if not basic_price_configured %}
            <div class="small-muted">Basic plan is not configured yet.</div>
          {% elif is_subscribed %}
            <div class="small-muted">Already subscribed. Switch plans in Stripe billing.</div>
          {% else %}
            <form method="post" action="{{ url_for('billing_checkout') }}" class="js-stripe-loading-form">
              <input type="hidden" name="plan" value="basic">
              <button class="btn btn-outline-primary" type="submit">
                {% if basic_trial_used %}
                  Subscribe Basic
                {% else %}
                  Start Basic 7-day trial
                {% endif %}
              </button>
            </form>
          {% endif %}
        </div>
      </div>
      <div class="col-12 col-lg-6">
        <div class="border rounded p-3 h-100">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <div class="fw-semibold">Pro Plan</div>
            <span class="badge text-bg-light border">$24.99/mo</span>
          </div>
          <div class="small-muted mb-2">Advanced features for growing teams.</div>
          <ul class="small-muted mb-3">
            <li>Everything in Basic</li>
            <li>Customer online payment button in portal (Stripe Connect required)</li>
            <li>Employee invites, roles, and employee scheduler controls</li>
          </ul>
          {% if not pro_price_configured %}
            <div class="small-muted">Pro plan is not configured yet.</div>
          {% elif is_subscribed %}
            <div class="small-muted">Already subscribed. Switch plans in Stripe billing.</div>
          {% else %}
            <form method="post" action="{{ url_for('billing_checkout') }}" class="js-stripe-loading-form">
              <input type="hidden" name="plan" value="pro">
              <button class="btn btn-primary" type="submit">
                {% if pro_trial_used %}
                  Subscribe Pro
                {% else %}
                  Start Pro 7-day trial
                {% endif %}
              </button>
            </form>
          {% endif %}
        </div>
      </div>
    </div>

  </div>
</div>

<div class="card shadow-sm mt-3">
  <div class="card-body">
    <h5 class="mb-2">Referral Program</h5>
    <p class="small-muted mb-3">
      Share your referral link. When a referred user becomes a paid subscriber and stays active long enough,
      you earn one month of account credit.
    </p>
    <div class="row g-3 align-items-end mb-2">
      <div class="col-12 col-md-4">
        <label class="form-label small-muted mb-1">Your Referral Code</label>
        <input class="form-control form-control-sm mono" type="text" value="{{ referral_code or '' }}" readonly>
      </div>
      <div class="col-12 col-md-8">
        <label class="form-label small-muted mb-1">Your Referral Link</label>
        <div class="input-group input-group-sm">
          <input id="referralLinkInput" class="form-control mono" type="text" value="{{ referral_link or '' }}" readonly>
          <button class="btn btn-outline-secondary" type="button" id="copyReferralBtn">Copy</button>
        </div>
      </div>
    </div>

    <div class="row g-2 mt-1">
      <div class="col-6 col-md-2">
        <div class="small-muted">Pending</div>
        <div class="fw-semibold">{{ referral_pending_count or 0 }}</div>
      </div>
      <div class="col-6 col-md-2">
        <div class="small-muted">Confirmed</div>
        <div class="fw-semibold">{{ referral_confirmed_count or 0 }}</div>
      </div>
      <div class="col-6 col-md-2">
        <div class="small-muted">Blocked</div>
        <div class="fw-semibold">{{ referral_blocked_count or 0 }}</div>
      </div>
      <div class="col-6 col-md-2">
        <div class="small-muted">Earned</div>
        <div class="fw-semibold">${{ '%.2f'|format((referral_credit_earned_cents or 0) / 100.0) }}</div>
      </div>
      <div class="col-6 col-md-2">
        <div class="small-muted">Applied</div>
        <div class="fw-semibold">${{ '%.2f'|format((referral_credit_applied_cents or 0) / 100.0) }}</div>
      </div>
      <div class="col-6 col-md-2">
        <div class="small-muted">Pending Credit</div>
        <div class="fw-semibold">${{ '%.2f'|format((referral_credit_pending_cents or 0) / 100.0) }}</div>
      </div>
    </div>
  </div>
</div>

{% if pro_features_enabled %}
  <div class="card shadow-sm mt-3">
    <div class="card-body">
      <h5 class="mb-2">Customer Payments (Stripe Connect)</h5>
      <p class="small-muted mb-3">
        Connect your Stripe account so your customers can pay invoices and estimates from the customer portal.
        Payments go directly to your connected Stripe account.
      </p>

      {% if connect_account_id %}
        <div class="mb-3">
          <div class="small-muted">Connected Account</div>
          <div class="mono">{{ connect_account_id }}</div>
        </div>

        <div class="d-flex flex-wrap gap-2 mb-2">
          <span class="badge {{ 'text-bg-success' if connect_charges_enabled else 'text-bg-secondary' }}">
            Charges {{ 'enabled' if connect_charges_enabled else 'pending' }}
          </span>
          <span class="badge {{ 'text-bg-success' if connect_payouts_enabled else 'text-bg-secondary' }}">
            Payouts {{ 'enabled' if connect_payouts_enabled else 'pending' }}
          </span>
          <span class="badge {{ 'text-bg-success' if connect_details_submitted else 'text-bg-secondary' }}">
            Details {{ 'submitted' if connect_details_submitted else 'required' }}
          </span>
        </div>

        {% if connect_message %}
          <div class="small-muted mb-3">{{ connect_message }}</div>
        {% endif %}

        <div class="d-flex flex-wrap gap-2">
          <form method="post" action="{{ url_for('billing_connect_start') }}" class="d-inline js-stripe-loading-form">
            <button class="btn btn-outline-primary">
              {% if connect_ready %}Update Connect setup{% else %}Finish Connect setup{% endif %}
            </button>
          </form>
          <form method="post" action="{{ url_for('billing_connect_dashboard') }}" class="d-inline js-stripe-loading-form">
            <button class="btn btn-outline-secondary">Open Stripe Dashboard</button>
          </form>
        </div>
      {% else %}
        <form method="post" action="{{ url_for('billing_connect_start') }}" class="d-inline js-stripe-loading-form">
          <button class="btn btn-primary">Connect Stripe Account</button>
        </form>
        {% if connect_message %}
          <div class="small-muted mt-2">{{ connect_message }}</div>
        {% endif %}
      {% endif %}
    </div>
  </div>
{% endif %}

<script>
  (function () {
    const forms = document.querySelectorAll(".js-stripe-loading-form");
    forms.forEach((form) => {
      form.addEventListener("submit", function (event) {
        if (event.defaultPrevented) return;
        const btn = form.querySelector("button[type='submit'], button:not([type])");
        if (!btn || btn.dataset.loadingApplied === "1") return;
        btn.dataset.loadingApplied = "1";
        btn.disabled = true;
        const original = btn.innerHTML;
        btn.dataset.originalHtml = original;
        btn.innerHTML =
          '<span class="spinner-border spinner-border-sm btn-loading-spinner me-2" role="status" aria-hidden="true"></span>Loading...';
      });
    });
  })();
  (function () {
    const copyBtn = document.getElementById("copyReferralBtn");
    const input = document.getElementById("referralLinkInput");
    if (!copyBtn || !input) return;
    copyBtn.addEventListener("click", async function () {
      const val = (input.value || "").trim();
      if (!val) return;
      try {
        await navigator.clipboard.writeText(val);
        const old = copyBtn.textContent;
        copyBtn.textContent = "Copied!";
        setTimeout(() => { copyBtn.textContent = old; }, 1200);
      } catch (_e) {
        input.focus();
        input.select();
      }
    });
  })();
</script>
{% endblock %}
