{% extends "base.html" %}
{% set title = "Customer Portal" %}

{% block content %}
{% set total = inv.invoice_total() %}
{% set amount_due = effective_amount_due if effective_amount_due is defined else inv.amount_due() %}
{% set is_paid = amount_due <= 0.01 %}
{% set is_estimate = inv.is_estimate %}

<div class="row justify-content-center">
  <div class="col-12 col-lg-9 col-xl-8">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-3">
          <div>
            <div class="small-muted">{{ business_name }}</div>
            <h1 class="h4 mb-1">
              {% if is_estimate %}Estimate{% else %}Invoice{% endif %}
              <span class="mono">{{ doc_number }}</span>
            </h1>
            {% if customer %}
              <div class="small-muted">Customer: {{ customer.name }}</div>
            {% endif %}
            {% if inv.date_in %}
              <div class="small-muted">Date: {{ inv.date_in }}</div>
            {% endif %}
          </div>
          <div class="text-lg-end">
            {% if is_estimate %}
              <span class="badge text-bg-info">Estimate</span>
            {% elif is_paid %}
              <span class="badge text-bg-success">Paid</span>
            {% else %}
              <span class="badge text-bg-warning">Payment Due</span>
            {% endif %}
          </div>
        </div>

        {% if payment_message %}
          <div class="alert alert-success">{{ payment_message }}</div>
        {% endif %}
        {% if payment_error %}
          <div class="alert alert-danger">{{ payment_error }}</div>
        {% endif %}

        <div class="row g-3 mb-3">
          <div class="col-12 col-md-4">
            <div class="border rounded p-3 h-100">
              <div class="small-muted mb-1">Invoice Amount</div>
              <div class="h5 mb-0 mono">${{ "%.2f"|format(total) }}</div>
            </div>
          </div>
          <div class="col-12 col-md-4">
            <div class="border rounded p-3 h-100">
              <div class="small-muted mb-1">Paid</div>
              <div class="h5 mb-0 mono">${{ "%.2f"|format(paid_display if paid_display is defined else (inv.paid or 0)) }}</div>
            </div>
          </div>
          <div class="col-12 col-md-4">
            <div class="border rounded p-3 h-100">
              <div class="small-muted mb-1">Amount Due</div>
              <div class="h5 mb-0 mono">${{ "%.2f"|format(amount_due_display if amount_due_display is defined else amount_due) }}</div>
              {% if late_fee_amount is defined and late_fee_amount > 0 %}
                <div class="small-muted mt-1">Includes late fees: ${{ "%.2f"|format(late_fee_amount) }}</div>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="d-flex flex-wrap gap-2 mb-4">
          <a class="btn btn-outline-secondary" href="{{ pdf_url_base }}">Download Invoice PDF</a>
          {% if has_paid_online_receipt %}
            <a class="btn btn-outline-primary" href="{{ pdf_url_paid }}">Download Paid Receipt PDF (includes processing fee)</a>
          {% endif %}
          {% if can_pay_online %}
            <form method="post" action="{{ pay_url }}">
              <button class="btn btn-success" type="submit">
                Pay Now (${{ "%.2f"|format(pay_total) }})
              </button>
            </form>
          {% endif %}
        </div>
        {% if can_pay_online and not has_paid_online_receipt %}
          <div class="small-muted mb-2">
            If you download the PDF before online payment, it will not include the card processing fee.
            After payment, download it again for the paid invoice total.
          </div>
        {% endif %}
        {% if has_paid_online_receipt %}
          <div class="small-muted mb-2">
            This paid invoice PDF includes the card processing fee paid at checkout.
          </div>
        {% endif %}
        {% if can_pay_online and convenience_fee and convenience_fee > 0 %}
          <div class="small-muted mb-2">
            Credit Card Processing Fee: ${{ "%.2f"|format(convenience_fee) }}
          </div>
          <div class="small-muted mb-4">
            Online payment total: ${{ "%.2f"|format(pay_total) }}
          </div>
        {% endif %}
        {% if payment_unavailable_reason %}
          <div class="small-muted mb-4">{{ payment_unavailable_reason }}</div>
        {% endif %}

        {% if inv.parts and inv.parts|length > 0 %}
          <div class="fw-semibold mb-2">Items</div>
          <ul class="list-group mb-3">
            {% for p in inv.parts %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>{{ p.part_name }}</span>
                <span class="mono">${{ "%.2f"|format(inv.part_price_with_markup(p.part_price or 0)) }}</span>
              </li>
            {% endfor %}
          </ul>
        {% endif %}

        {% if inv.notes %}
          <div class="fw-semibold mb-2">Notes</div>
          <div class="border rounded p-3 bg-light" style="white-space: pre-wrap;">{{ inv.notes }}</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
