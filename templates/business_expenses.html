{% extends "base.html" %}
{% set title = "Business Expenses" %}

{% block content %}
<style>
  .expense-card .card-body { padding: 0.75rem; }
  .expense-item-input { padding-top: 0.35rem; padding-bottom: 0.35rem; }
</style>
<script>
  function confirmCustomCategoryDelete(formEl) {
    const rowDelete = formEl.querySelector('input[name^="custom_delete_"]');
    if (!rowDelete || !rowDelete.checked) return true;
    const categoryLabel = formEl.getAttribute("data-category-label") || "";
    const label = (categoryLabel || "this category").trim();
    return window.confirm(
      `Delete "${label}"?\n\nThis will permanently delete the category and ALL items/splits inside it.`
    );
  }
</script>

<div class="page-header">
  <div>
    <h1 class="h3 fw-bold mb-1">Business Expenses</h1>
    <div class="small-muted">Quick-add by category. Entries are stored, and totals update automatically.</div>
  </div>
</div>

<div class="card shadow-sm mb-3">
  <div class="card-body py-2">
    <div class="row g-2 align-items-end">
      <div class="col-12 col-md-8">
        <label class="form-label mb-1">New Custom Category</label>
        <form method="post" class="d-flex gap-2">
          <input type="hidden" name="action" value="add_category">
          <input class="form-control form-control-sm" name="new_category_label" placeholder="ex. Shop Consumables">
          <button class="btn btn-sm btn-outline-primary" type="submit">Add Category</button>
        </form>
      </div>
      <div class="col-12 col-md-4">
        <div class="small-muted">Total Business Expenses</div>
        <div class="h5 fw-bold mb-0">${{ '%.2f'|format(total_expenses or 0) }}</div>
        <div class="small-muted mt-2">Total Manual Income</div>
        <div class="h6 fw-bold mb-0 text-success">${{ '%.2f'|format(total_manual_income or 0) }}</div>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm mb-3">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-2">
      <div>
        <div class="fw-semibold">Manual Income Entries</div>
        <div class="small-muted">Add Other Income and Interest Income for Financial Summary and Profit &amp; Loss.</div>
      </div>
      <div class="text-end">
        <div class="small-muted">Other Income: <span class="mono text-success">${{ '%.2f'|format(total_other_income or 0) }}</span></div>
        <div class="small-muted">Interest Income: <span class="mono text-success">${{ '%.2f'|format(total_interest_income or 0) }}</span></div>
      </div>
    </div>
    <form method="post" class="row g-2 align-items-end mb-3">
      <input type="hidden" name="action" value="add_income_entry">
      <div class="col-12 col-md-2">
        <label class="form-label small-muted mb-1">Type</label>
        <select class="form-select form-select-sm" name="income_type" required>
          <option value="other">Other Income</option>
          <option value="interest">Interest Income</option>
        </select>
      </div>
      <div class="col-12 col-md-5">
        <label class="form-label small-muted mb-1">Description</label>
        <input class="form-control form-control-sm" name="income_desc" placeholder="ex. Insurance rebate" required>
      </div>
      <div class="col-6 col-md-2">
        <label class="form-label small-muted mb-1">Amount ($)</label>
        <input class="form-control form-control-sm" name="income_amount" inputmode="decimal" placeholder="ex. 125.00" required>
      </div>
      <div class="col-6 col-md-2">
        <label class="form-label small-muted mb-1">Date</label>
        <input class="form-control form-control-sm" type="date" name="income_date">
      </div>
      <div class="col-12 col-md-1 d-grid">
        <button class="btn btn-sm btn-success" type="submit">Add</button>
      </div>
    </form>
    <div class="table-responsive">
      <table class="table table-sm align-middle mb-0">
        <thead>
          <tr>
            <th style="width: 130px;">Type</th>
            <th>Description</th>
            <th style="width: 140px;">Date</th>
            <th class="text-end" style="width: 120px;">Amount</th>
            <th class="text-end" style="width: 90px;"></th>
          </tr>
        </thead>
        <tbody>
          {% if income_rows and income_rows|length > 0 %}
            {% for r in income_rows %}
              <tr>
                <td>
                  {% if (r.income_type or '') == 'interest' %}
                    <span class="badge text-bg-info">Interest</span>
                  {% else %}
                    <span class="badge text-bg-secondary">Other</span>
                  {% endif %}
                </td>
                <td>{{ r.item_desc }}</td>
                <td class="mono">{{ r.income_date.strftime("%Y-%m-%d") if r.income_date else "â€”" }}</td>
                <td class="text-end mono text-success">${{ '%.2f'|format(r.amount or 0) }}</td>
                <td class="text-end">
                  <form method="post" class="d-inline" onsubmit="return confirm('Delete this income entry?');">
                    <input type="hidden" name="action" value="delete_income_entry">
                    <input type="hidden" name="income_id" value="{{ r.id }}">
                    <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="5" class="small-muted">No manual income entries yet.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="card shadow-sm mb-3">
  <div class="card-body py-2">
    <form method="get" class="row g-2 align-items-end">
      <div class="col-12 col-md-9">
        <label class="form-label mb-1">Search Categories, Items, and Splits</label>
        <input
          class="form-control form-control-sm"
          type="text"
          name="q"
          value="{{ search_query or '' }}"
          placeholder="ex. Wiper blade, Supplies, Oil filter"
        >
      </div>
      <div class="col-6 col-md-1 d-grid">
        <button class="btn btn-sm btn-primary" type="submit">Search</button>
      </div>
      <div class="col-6 col-md-2 d-grid">
        <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('business_expenses') }}">Clear</a>
      </div>
    </form>
  </div>
</div>

{% if search_query %}
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="fw-semibold">Search Results</div>
        <div class="small-muted">{{ (search_results or [])|length }} match(es)</div>
      </div>
      {% if search_results %}
        <div class="list-group list-group-flush">
          {% for r in search_results %}
            <div class="list-group-item px-0 py-2 d-flex justify-content-between align-items-center gap-2">
              <div>
                <div class="fw-semibold">{{ r.title }}</div>
                <div class="small-muted">{{ r.subtitle }}</div>
              </div>
              <a class="btn btn-sm btn-outline-primary" href="{{ r.href }}">{{ r.action_label }}</a>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="small-muted">No matches found for "{{ search_query }}".</div>
      {% endif %}
    </div>
  </div>
{% endif %}

<div class="row g-2">
  {% set example_by_category = {
    "advertising": "ex. Facebook ad campaign",
    "wages/salary": "ex. Weekly payroll",
    "interest expense": "ex. Business credit card interest",
    "utilities": "ex. Shop electricity bill",
    "software expenses": "ex. InvoiceRunner monthly plan",
    "dues and subscriptions": "ex. Trade association membership",
    "small tools and equipment": "ex. Torque wrench",
    "rent": "ex. Shop rent payment",
    "supplies": "ex. Paper towels and gloves",
    "repairs and maintenance": "ex. Lift service repair",
    "car and truck expenses": "ex. Work truck fuel",
    "commissions and fees": "ex. Stripe processing fees",
    "contract labor": "ex. Subcontractor payment",
    "employee benefit programs": "ex. Health insurance contribution",
    "insurance": "ex. General liability premium",
    "legal and professional services": "ex. CPA bookkeeping service",
    "taxes and licenses": "ex. State business license renewal",
    "travel": "ex. Hotel for training trip",
    "meals": "ex. Client lunch",
  } %}
  {% for row in default_rows + custom_rows %}
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm expense-card h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center gap-2 mb-2">
            <div class="fw-semibold">{{ row.label }}</div>
            <div class="d-flex align-items-center gap-2">
              <div class="mono fw-semibold">${{ '%.2f'|format(row.amount or 0) }}</div>
              <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('business_expense_category', expense_id=row.id) }}">View Items</a>
            </div>
          </div>

          <form method="post" class="row g-2 align-items-end mb-1">
            <input type="hidden" name="action" value="add_entry">
            <input type="hidden" name="expense_id" value="{{ row.id }}">
            <div class="col-12 col-md-6">
              <label class="form-label small-muted mb-1">Item</label>
              <input
                class="form-control form-control-sm expense-item-input"
                name="item_desc"
                placeholder="{{ example_by_category.get((row.label or '')|lower|trim, 'ex. Business expense item') }}"
                required
              >
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label small-muted mb-1">Amount ($)</label>
              <input class="form-control form-control-sm expense-item-input" name="item_amount" inputmode="decimal" placeholder="ex. 12.00" required>
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label small-muted mb-1">Date (optional)</label>
              <input class="form-control form-control-sm expense-item-input" type="date" name="item_date">
            </div>
            <div class="col-12 d-grid">
              <button class="btn btn-sm btn-primary" type="submit">Save Entry</button>
            </div>
          </form>

          {% if row.is_custom %}
            <form
              method="post"
              class="row g-2 align-items-end mt-1"
              data-category-label="{{ row.label or '' }}"
              onsubmit="return confirmCustomCategoryDelete(this);"
            >
              <input type="hidden" name="action" value="save_categories">
              <div class="col-8">
                <label class="form-label small-muted mb-1">Custom Category Name</label>
                <input class="form-control form-control-sm" name="custom_label_{{ row.id }}" value="{{ row.label }}" required>
              </div>
              <div class="col-2">
                <label class="form-label small-muted mb-1 d-block">Delete</label>
                <input class="form-check-input mt-2" type="checkbox" id="customDelete{{ row.id }}" name="custom_delete_{{ row.id }}" value="1">
              </div>
              <div class="col-2 d-grid">
                <button class="btn btn-sm btn-outline-secondary" type="submit">Save</button>
              </div>
            </form>
          {% endif %}
        </div>
      </div>
    </div>
  {% endfor %}
</div>
{% endblock %}
