{% extends "base.html" %}
{% set doc_number = inv.display_number or inv.invoice_number %}
{% set title = "Invoice " ~ doc_number %}

{% block content %}

{# profession-aware labels #}
{% set _tmpl = tmpl if tmpl is defined and tmpl else {} %}
{% set job_label = _tmpl.get('job_label', 'Vehicle') %}
{% set labor_title = _tmpl.get('labor_title', 'Labor') %}
{% set labor_desc_label = _tmpl.get('labor_desc_label', 'Labor Description') %}
{% set parts_title = _tmpl.get('parts_title', 'Parts') %}
{% set parts_name_label = _tmpl.get('parts_name_label', 'Part Name') %}
{% set shop_supplies_label = _tmpl.get('shop_supplies_label', 'Shop Supplies') %}
{% set show_job = _tmpl.get('show_job', True) %}
{% set show_labor = _tmpl.get('show_labor', True) %}
{% set show_parts = _tmpl.get('show_parts', True) %}
{% set show_shop_supplies = _tmpl.get('show_shop_supplies', True) %}

{% set total = inv.invoice_total() %}
{% set tax_amount = inv.tax_amount() %}
{% set tmpl_key = inv.invoice_template or "auto_repair" %}
{% set fully_paid = (inv.paid or 0) + 0.01 >= total %}

<style>
  .doc-shell {
    --doc-border: #d2d7df;
    --doc-border-strong: #c3cad4;
    --doc-muted: #5f6670;
    --doc-bg: #f3f5f7;
    --doc-shadow: 0 8px 20px rgba(16, 24, 40, 0.08);
  }
  .doc-grid {
    display: grid;
    grid-template-columns: minmax(300px, 360px) minmax(0, 1fr);
    gap: 16px;
  }
  .doc-col-left {
    display: flex;
    flex-direction: column;
    gap: 14px;
  }
  .doc-card {
    border: 1px solid var(--doc-border);
    border-radius: 14px;
    background: linear-gradient(180deg, #ffffff 0%, #f4f6f8 100%);
    box-shadow: var(--doc-shadow);
  }
  .doc-card-body {
    padding: 14px;
  }
  .doc-card-title {
    margin: 0 0 10px;
    font-size: 0.96rem;
    font-weight: 700;
    color: #2f3742;
  }
  .doc-summary-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }
  .doc-stat {
    border: 1px solid var(--doc-border);
    border-radius: 10px;
    background: var(--doc-bg);
    padding: 9px 10px;
  }
  .doc-stat .label {
    font-size: 0.76rem;
    color: var(--doc-muted);
    margin-bottom: 2px;
  }
  .doc-stat .value {
    font-size: 0.98rem;
    font-weight: 700;
  }
  .doc-kicker {
    color: var(--doc-muted);
    font-size: 0.86rem;
  }
  .doc-info-grid {
    display: grid;
    grid-template-columns: repeat(4, minmax(0, 1fr));
    gap: 8px;
  }
  .doc-info-card {
    border: 1px solid var(--doc-border);
    border-radius: 10px;
    background: #f5f6f8;
    padding: 8px 10px;
  }
  .doc-info-card-wide {
    grid-column: span 2;
  }
  .doc-info-card .label {
    color: var(--doc-muted);
    font-size: 0.75rem;
    margin-bottom: 2px;
  }
  .doc-info-card .value {
    font-weight: 700;
  }
  .doc-subsection {
    padding-top: 14px;
    margin-top: 14px;
    border-top: 1px solid #d9dde3;
  }
  .doc-subtitle {
    margin: 0 0 10px;
    font-size: 0.9rem;
    font-weight: 700;
    color: #303744;
  }
  .doc-action-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 10px;
    border: 1px solid var(--doc-border);
    border-radius: 12px;
    background: linear-gradient(180deg, #f7f8fa 0%, #f1f3f5 100%);
  }
  .doc-action-grid form {
    margin: 0;
  }
  .doc-action-grid .btn {
    min-height: 38px;
    border-radius: 10px;
    font-weight: 600;
    letter-spacing: 0.01em;
    padding: 0.45rem 0.78rem;
  }
  .doc-action-grid .btn-outline-primary {
    border-color: #255aa7;
    color: #194786;
    background: #eaf3ff;
  }
  .doc-action-grid .btn-outline-primary:hover {
    background: #dbe9ff;
  }
  .doc-action-grid .btn-outline-secondary {
    border-color: #8ea8cf;
    color: #27476f;
    background: #edf4ff;
  }
  .doc-action-grid .btn-outline-secondary:hover {
    background: #dbe8fc;
  }
  .doc-action-grid .btn-outline-success {
    border-color: #0e7f6f;
    color: #0c6b5e;
    background: #def4ef;
  }
  .doc-action-grid .btn-outline-success:hover {
    background: #cdece4;
  }
  .doc-action-grid .btn-outline-danger {
    border-color: #c97575;
    color: #a93f3f;
    background: #fff7f7;
  }
  .doc-action-grid .btn-outline-danger:hover {
    background: #feecec;
  }
  .pdf-live-preview-frame {
    width: 100%;
    height: 620px;
    border: 1px solid #d0d8e5;
    border-radius: 10px;
    background: #fff;
  }
  @media (max-width: 1200px) {
    .doc-info-grid {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }
  }
  @media (max-width: 991px) {
    .doc-grid {
      grid-template-columns: 1fr;
    }
    .pdf-live-preview-frame {
      height: 540px;
    }
    .doc-info-grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }
  @media (max-width: 575px) {
    .doc-summary-grid,
    .doc-info-grid {
      grid-template-columns: 1fr;
    }
    .doc-info-card-wide {
      grid-column: auto;
    }
    .doc-action-grid .btn,
    .doc-action-grid form,
    .doc-action-grid form .btn {
      width: 100%;
    }
  }
</style>

<div class="page-header">
  <div>
    <h1 class="h3 fw-bold mb-1">
      Invoice <span class="mono">{{ doc_number }}</span>
      {% if fully_paid %}
        <span class="badge text-bg-success ms-2">Paid</span>
      {% else %}
        <span class="badge text-bg-warning ms-2">Unpaid</span>
      {% endif %}
      {% if inv.converted_from_estimate %}
        <span class="badge text-bg-info ms-2">Converted from Estimate</span>
      {% endif %}
    </h1>

    <div class="small-muted">
      {% if customer %}
        Customer:
        <a href="{{ url_for('customer_view', customer_id=customer.id) }}" class="text-decoration-none fw-semibold">
          {{ customer.name }}
        </a>
      {% else %}
        Customer: <span class="text-danger">Missing</span>
      {% endif %}
      {% if inv.date_in %} · Date: <span class="mono">{{ inv.date_in }}</span>{% endif %}
    </div>
  </div>

  <div class="action-group">
    <a class="btn btn-outline-secondary" href="{{ url_for('customers_list') }}">Customers</a>
    {% if customer %}
      <a class="btn btn-outline-secondary" href="{{ url_for('customer_view', customer_id=customer.id) }}">Back to Customer</a>
    {% endif %}

    <form method="post" action="{{ url_for('invoice_duplicate', invoice_id=inv.id) }}">
      <button class="btn btn-outline-primary" type="submit">Duplicate</button>
    </form>

    {% if can_edit_document %}
      <a class="btn btn-outline-primary" href="{{ url_for('invoice_edit', invoice_id=inv.id) }}">Edit</a>
    {% endif %}
  </div>
</div>

<div class="doc-shell">
<div class="doc-grid">

  <div class="doc-col-left">
    <div class="doc-card">
      <div class="doc-card-body">
        <h2 class="doc-card-title">Invoice Summary</h2>
        {% if show_job %}
          <div class="doc-kicker mb-2">{{ job_label }}</div>
          <div class="fw-semibold mb-3">{{ inv.vehicle or "—" }}</div>
        {% endif %}
        <div class="doc-summary-grid">
          <div class="doc-stat">
            <div class="label">Total</div>
            <div class="value mono">${{ "%.2f"|format(total) }}</div>
          </div>
          <div class="doc-stat">
            <div class="label">Paid</div>
            <div class="value mono">${{ "%.2f"|format(inv.paid or 0) }}</div>
          </div>
          <div class="doc-stat">
            <div class="label">Amount Due</div>
            <div class="value mono">${{ "%.2f"|format(inv.amount_due()) }}</div>
          </div>
          <div class="doc-stat">
            <div class="label">Tax</div>
            <div class="value mono">${{ "%.2f"|format(tax_amount or 0) }}</div>
          </div>
        </div>
        {% if pro_features_enabled %}
          <div class="doc-subsection">
            <h3 class="doc-subtitle">Late Payment Fees</h3>
            <div class="doc-summary-grid">
              <div class="doc-stat">
                <div class="label">Due Date</div>
                <div class="value">{{ due_date_display }}</div>
              </div>
              <div class="doc-stat">
                <div class="label">Late Fees Accrued</div>
                <div class="value mono">${{ "%.2f"|format(late_fee_amount or 0) }}</div>
              </div>
              <div class="doc-stat">
                <div class="label">Invoice Amount Due</div>
                <div class="value mono">${{ "%.2f"|format(inv.amount_due() or 0) }}</div>
              </div>
              <div class="doc-stat">
                <div class="label">Due Including Late Fees</div>
                <div class="value mono">${{ "%.2f"|format(due_with_late_fee or 0) }}</div>
              </div>
            </div>
          </div>
        {% endif %}
      </div>
    </div>

    <div class="doc-card">
      <div class="doc-card-body">
        <h2 class="doc-card-title">Live PDF Preview</h2>
        <div class="doc-kicker mb-2">Exact PDF layout for this invoice.</div>
        <iframe
          class="pdf-live-preview-frame"
          src="{{ url_for('invoice_pdf_preview', invoice_id=inv.id) }}"
          title="Invoice PDF Preview"
        ></iframe>
      </div>
    </div>

    {% if pro_features_enabled %}
      <div class="doc-card">
        <div class="doc-card-body">
          <h2 class="doc-card-title">Example Payout Preview</h2>
          <div class="doc-kicker mb-3">
            Based on this invoice{% if inv.amount_due() > 0 %} amount due{% else %} total{% endif %}.
          </div>
          <div class="row g-3">
            <div class="col-12 col-md-6">
              <label class="form-label">Invoice Amount ($)</label>
              <input
                type="text"
                class="form-control"
                id="invoicePayoutBaseAmount"
                inputmode="decimal"
                value="{{ '%.2f'|format((inv.amount_due() if inv.amount_due() > 0 else inv.invoice_total()) or 0) }}"
              >
            </div>
            <div class="col-12">
              <div class="small-muted mb-1" id="invoicePayoutModeLabel"></div>
              <div class="small-muted mb-1" id="invoicePayoutConvenienceFee"></div>
              <div class="small-muted mb-1" id="invoicePayoutCustomerTotal"></div>
              <div class="small-muted mb-1" id="invoicePayoutStripeFee"></div>
              <div class="small-muted fw-semibold" id="invoicePayoutNet"></div>
            </div>
          </div>
        </div>
      </div>
    {% endif %}
  </div>

  <div class="doc-card">
    <div class="doc-card-body">
      <h2 class="doc-card-title">Invoice Details</h2>

      <div class="doc-subsection" style="padding-top:0; margin-top:0; border-top:0; margin-bottom:12px;">
        <h3 class="doc-subtitle">Actions</h3>
        <div class="doc-action-grid">
          {% if owner_pro_enabled %}
            <a class="btn btn-outline-primary" href="{{ customer_portal_url }}" target="_blank" rel="noopener noreferrer">
              Customer Portal
            </a>
          {% endif %}

          <a class="btn btn-outline-secondary" href="{{ url_for('invoice_pdf_download', invoice_id=inv.id) }}">
            Download PDF
          </a>

          <form method="post" action="{{ url_for('invoice_send', invoice_id=inv.id) }}">
            <button class="btn btn-outline-success" type="submit">Email PDF</button>
          </form>

          {% if pro_features_enabled and inv.amount_due() > 0 %}
            <form method="post" action="{{ url_for('invoice_send_reminder', invoice_id=inv.id) }}"
                  onsubmit="return confirm('Send a payment reminder email to this customer now?');">
              <button class="btn btn-outline-warning" type="submit">Send Payment Reminder</button>
            </form>
          {% endif %}

          <form method="post" action="{{ url_for('invoice_text', invoice_id=inv.id) }}" class="d-none">
            <button class="btn btn-outline-success" type="submit">Text PDF</button>
          </form>

          <form method="post" action="{{ url_for('invoice_convert', invoice_id=inv.id) }}">
            <button class="btn btn-outline-primary" type="submit">Convert to Estimate</button>
          </form>

          <form method="post" action="{{ url_for('invoice_mark_paid', invoice_id=inv.id) }}">
            <button class="btn btn-outline-success" type="submit">Mark Paid</button>
          </form>

          {% if not is_employee_account %}
            <form method="post" action="{{ url_for('invoice_delete', invoice_id=inv.id) }}"
                  onsubmit="return confirm('Delete this invoice? This cannot be undone.');">
              <button class="btn btn-outline-danger" type="submit">Delete</button>
            </form>
          {% endif %}
        </div>
      </div>

      <div class="doc-info-grid">
        <div class="doc-info-card doc-info-card-wide">
          <div class="label">Customer Email</div>
          <div class="value mono">{{ inv.customer_email or (customer.email if customer else "—") }}</div>
        </div>
        <div class="doc-info-card">
          <div class="label">Customer Phone</div>
          <div class="value mono">{{ format_phone(inv.customer_phone or (customer.phone if customer else "")) or "—" }}</div>
        </div>
        {% if tmpl_key == "flipping_items" %}
          <div class="doc-info-card">
            <div class="label">Profit</div>
            <div class="value mono">${{ "%.2f"|format(inv.labor_total()) }}</div>
          </div>
          <div class="doc-info-card">
            <div class="label">Sold For</div>
            <div class="value mono">${{ "%.2f"|format(inv.paid or 0) }}</div>
          </div>
          <div class="doc-info-card">
            <div class="label">Parts Markup</div>
            <div class="value mono">{{ "%.2f"|format(inv.parts_markup_percent or 0) }}%</div>
          </div>
          <div class="doc-info-card">
            <div class="label">Total Profit</div>
            <div class="value mono">${{ "%.2f"|format(inv.labor_total() + inv.parts_markup_amount()) }}</div>
          </div>
        {% else %}
          <div class="doc-info-card">
            <div class="label">Hours</div>
            <div class="value mono">{{ "%.2f"|format(inv.hours or 0) }}</div>
          </div>
          <div class="doc-info-card">
            <div class="label">Rate / Hour</div>
            <div class="value mono">${{ "%.2f"|format(inv.price_per_hour or 0) }}</div>
          </div>
          {% if show_shop_supplies %}
          <div class="doc-info-card">
            <div class="label">{{ shop_supplies_label }}</div>
            <div class="value mono">${{ "%.2f"|format(inv.shop_supplies or 0) }}</div>
          </div>
          {% endif %}
          <div class="doc-info-card">
            <div class="label">Parts Markup</div>
            <div class="value mono">
              {{ "%.2f"|format(inv.parts_markup_percent or 0) }}%
              <span class="small-muted">(${{ "%.2f"|format(inv.parts_markup_amount()) }})</span>
            </div>
          </div>
          <div class="doc-info-card">
            <div class="label">Total Profit</div>
            <div class="value mono">${{ "%.2f"|format(inv.labor_total() + inv.parts_markup_amount()) }}</div>
          </div>
        {% endif %}
      </div>

      <div class="doc-subsection">
        <div class="row g-3">
          {% if show_parts %}
          <div class="col-12 col-xl-6">
            <h3 class="doc-subtitle">{{ parts_title }}</h3>
            <div class="small-muted mb-2">Parts markup: {{ "%.2f"|format(inv.parts_markup_percent or 0) }}%</div>
            {% if inv.parts and inv.parts|length > 0 %}
              <ul class="list-group">
                {% for p in inv.parts %}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>{{ p.part_name }}</div>
                    <div class="mono">${{ "%.2f"|format(inv.part_price_with_markup(p.part_price or 0)) }}</div>
                  </li>
                {% endfor %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div class="fw-semibold">Parts Total</div>
                  <div class="mono fw-semibold">${{ "%.2f"|format(inv.parts_total()) }}</div>
                </li>
              </ul>
            {% else %}
              <div class="small-muted">No {{ parts_title|lower }}.</div>
            {% endif %}
          </div>
          {% endif %}

          {% if tmpl_key != "flipping_items" and show_labor %}
            <div class="col-12 col-xl-6">
              <h3 class="doc-subtitle">{{ labor_title }}</h3>
              {% if inv.labor_items and inv.labor_items|length > 0 %}
                <ul class="list-group">
                  {% for li in inv.labor_items %}
                    <li class="list-group-item">
                      <div class="fw-semibold">{{ li.labor_desc }}</div>
                      <div class="small-muted mono">{{ "%.2f"|format(li.labor_time_hours or 0) }} hrs</div>
                    </li>
                  {% endfor %}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div class="fw-semibold">Labor Total</div>
                    <div class="mono fw-semibold">${{ "%.2f"|format(inv.labor_total()) }}</div>
                  </li>
                </ul>
              {% else %}
                <div class="small-muted">No {{ labor_title|lower }} items.</div>
              {% endif %}
            </div>
          {% endif %}
        </div>
      </div>

      <div class="doc-subsection">
        <h3 class="doc-subtitle">Notes</h3>
        {% if inv.notes %}
          <div class="border rounded p-3 bg-light" style="white-space: pre-wrap;">{{ inv.notes }}</div>
        {% else %}
          <div class="small-muted">No notes.</div>
        {% endif %}
      </div>

      <div class="doc-subsection">
        <h3 class="doc-subtitle">Useful Information</h3>
        {% if inv.useful_info %}
          <div
            class="border rounded p-3 bg-light"
            id="usefulInfoText"
            data-text="{{ inv.useful_info|e }}"
            style="white-space: pre-wrap;"
          ></div>
        {% else %}
          <div class="small-muted">No useful information.</div>
        {% endif %}
      </div>

    </div>
  </div>

</div>
</div>

{% endblock %}

{% block scripts %}
<script>
  (function () {
    const baseInput = document.getElementById("invoicePayoutBaseAmount");
    if (!baseInput) return;

    const modeLabel = document.getElementById("invoicePayoutModeLabel");
    const feeLabel = document.getElementById("invoicePayoutConvenienceFee");
    const totalLabel = document.getElementById("invoicePayoutCustomerTotal");
    const stripeFeeLabel = document.getElementById("invoicePayoutStripeFee");
    const netLabel = document.getElementById("invoicePayoutNet");

    const autoEnabled = {{ "true" if owner_fee_auto_enabled else "false" }};
    const manualPct = {{ "%.6f"|format(owner_fee_percent or 0.0) }};
    const manualFixed = {{ "%.6f"|format(owner_fee_fixed or 0.0) }};
    const stripePct = {{ "%.6f"|format(owner_stripe_fee_percent or 2.9) }};
    const stripeFixed = {{ "%.6f"|format(owner_stripe_fee_fixed or 0.30) }};

    function parseMoney(v, d = 0) {
      const n = parseFloat(String(v || "").replace(/[$,\s]/g, ""));
      return Number.isFinite(n) ? n : d;
    }
    function round2(v) { return Math.round((Number(v) || 0) * 100) / 100; }
    function ceil2(v) { return Math.ceil((Number(v) || 0) * 100) / 100; }
    function money(v) { return `$${round2(v).toFixed(2)}`; }

    function updatePayoutPreview() {
      const base = Math.max(0, parseMoney(baseInput.value, 0));
      let convenienceFee = 0;
      if (autoEnabled) {
        const rate = stripePct / 100.0;
        if (rate < 0.99) {
          const gross = (base + stripeFixed) / (1 - rate);
          convenienceFee = Math.max(0, ceil2(gross - base));
        }
      } else {
        convenienceFee = Math.max(0, round2(base * (manualPct / 100.0) + manualFixed));
      }
      const customerTotal = round2(base + convenienceFee);
      const stripeFee = round2(customerTotal * (stripePct / 100.0) + stripeFixed);
      const netPayout = round2(customerTotal - stripeFee);

      if (modeLabel) {
        modeLabel.textContent = autoEnabled
          ? `Mode: Auto (Stripe ${stripePct.toFixed(2)}% + ${money(stripeFixed)})`
          : `Mode: Manual (${manualPct.toFixed(2)}% + ${money(manualFixed)})`;
      }
      if (feeLabel) feeLabel.textContent = `Credit Card Processing Fee added: ${money(convenienceFee)}`;
      if (totalLabel) totalLabel.textContent = `Customer checkout total: ${money(customerTotal)}`;
      if (stripeFeeLabel) stripeFeeLabel.textContent = `Estimated Stripe fee: ${money(stripeFee)}`;
      if (netLabel) netLabel.textContent = `Estimated net payout: ${money(netPayout)}`;
    }

    baseInput.addEventListener("input", updatePayoutPreview);
    updatePayoutPreview();
  })();

  (function () {
    const textEl = document.getElementById("usefulInfoText");
    if (!textEl) return;

    const raw = textEl.dataset.text || "";

    function escapeHtml(value) {
      return value
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function normalizeUrl(value) {
      const trimmed = value.trim();
      if (!trimmed) return null;
      if (/^https?:\/\//i.test(trimmed)) return trimmed;
      if (/^www\./i.test(trimmed)) return `https://${trimmed}`;
      return null;
    }

    const escaped = escapeHtml(raw);
    textEl.innerHTML = escaped.replace(
      /\b(https?:\/\/[^\s]+|www\.[^\s]+)\b/gi,
      (match) => {
        const url = normalizeUrl(match);
        if (!url) return match;
        const safeUrl = escapeHtml(url);
        const safeText = escapeHtml(match);
        return `<a href="${safeUrl}" target="_blank" rel="noopener noreferrer">${safeText}</a>`;
      }
    );
  })();
</script>
{% endblock %}
