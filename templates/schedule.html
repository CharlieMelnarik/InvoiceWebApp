{% extends "base.html" %}
{% set title = "Scheduler" %}

{% block content %}
<style>
  .cal-toolbar { display:flex; gap:.5rem; align-items:center; justify-content:space-between; flex-wrap:wrap; }
  .cal-grid { background:#fff; border-radius:12px; padding:12px; box-shadow:0 1px 6px rgba(0,0,0,.06); }
  .month-scroll { overflow-x:auto; }
  .month-grid { display:grid; grid-template-columns: repeat(7, 1fr); gap:8px; }
  .dow { font-weight:600; color:#6c757d; font-size:.85rem; padding:4px 6px; }
  .day-cell { border:1px solid #e6e8ec; border-radius:10px; padding:8px; height:130px; cursor:pointer; background:#fff; overflow:hidden; }
  .day-head { display:flex; align-items:center; justify-content:space-between; }
  .day-cell.muted { background:#fafbfc; color:#9aa0a6; }
  .day-cell.today { background:#f1f3f5; border-color:#d7dbe0; }
  .day-num { font-weight:700; font-size:.9rem; }
  .day-indicator {
    display:inline-flex;
    align-items:center;
    justify-content:center;
    min-width:18px;
    height:18px;
    border-radius:999px;
    padding:0 5px;
    font-size:.68rem;
    font-weight:700;
    color:#1d4ed8;
    background:rgba(37, 99, 235, 0.14);
    border:1px solid rgba(37, 99, 235, 0.25);
  }
  .evt-pill {
    display:inline-flex;
    align-items:center;
    font-size:.75rem;
    margin-top:6px;
    padding:3px 8px;
    border-radius:999px;
    background:#f1f3f5;
    max-width:100%;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .evt-pill .evt-name { overflow:hidden; text-overflow:ellipsis; }
  .evt-pill.cancelled { opacity:.5; text-decoration:line-through; }
  .evt-full { display:block; font-size:.8rem; margin-top:6px; padding:4px 6px; border-radius:8px; background:#f1f3f5; white-space:normal; overflow-wrap:anywhere; }

  .day-cell.compact .evt-full { display:none; }
  .day-cell.compact .evt-pill { display:inline-flex; }
  .day-cell .evt-pill { display:none; }

  .evt-popover {
    position:fixed;
    z-index:1080;
    background:#fff;
    border:1px solid #dee2e6;
    border-radius:10px;
    padding:8px 10px;
    box-shadow:0 6px 20px rgba(0,0,0,.12);
    max-width:280px;
    font-size:.8rem;
  }

  .day-wrap { display:flex; gap:16px; }
  .time-col { width:70px; color:#6c757d; font-size:.85rem; }
  .time-row { height:48px; display:flex; align-items:flex-start; justify-content:flex-end; padding-top:2px; }
  .timeline { position:relative; flex:1; border-left:1px solid #e6e8ec; }
  .slot { height:48px; border-bottom:1px solid #f0f1f3; }
  .event-block {
    position:absolute;
    left:10px;
    right:10px;
    border-radius:10px;
    padding:8px;
    background:#0d6efd14;
    border:1px solid #0d6efd33;
    overflow:hidden;
    cursor:pointer;
  }
  .event-block.block {
    background:#f8f9fa;
    border-color:#adb5bd;
  }
  .event-actions {
    position:absolute;
    top:6px;
    right:6px;
    display:flex;
    gap:4px;
  }
  .event-action-btn {
    border:none;
    background:#fff;
    border-radius:999px;
    width:22px;
    height:22px;
    font-size:.75rem;
    line-height:1;
    box-shadow:0 1px 4px rgba(0,0,0,.12);
    cursor:pointer;
  }
  .event-action-btn.complete { color:#198754; }
  .event-action-btn.cancel { color:#dc3545; }
  .event-title { font-weight:700; font-size:.9rem; }
  .event-sub { font-size:.8rem; color:#6c757d; }
  .event-link { display:inline-block; margin-top:4px; font-size:.75rem; color:#0d6efd; text-decoration:none; }
  .event-link:hover { text-decoration:underline; }
  .evt-pill.block,
  .evt-full.block {
    background:#f8f9fa;
    border:1px solid #ced4da;
  }

  @media (max-width: 992px) {
    .day-wrap { flex-direction:column; }
    .time-col { width:100%; display:flex; flex-wrap:wrap; gap:10px; }
    .time-row { height:auto; }
  }

  @media (max-width: 768px) {
    .month-scroll { margin: 0; padding: 0; overflow-x: hidden; }
    .month-grid { min-width: 0; gap: 4px; }
    .dow { font-size: .72rem; padding: 2px 1px; text-align: center; }
    .day-cell { min-height: 72px; height: 72px; padding: 4px; border-radius: 8px; }
    .day-num { font-size: .78rem; }
    .evt-full { display: none; }
    .evt-pill { display: inline-flex; font-size: .66rem; margin-top: 3px; padding: 2px 5px; line-height: 1.15; }

    /* Keep Day view timeline readable on phones (times on the left, not stacked on top). */
    .day-wrap { flex-direction: row; gap: 8px; }
    .time-col { width: 54px; display: block; flex-wrap: nowrap; font-size: .72rem; }
    .time-row { height: 44px; justify-content: flex-end; padding-top: 1px; }
    .timeline { flex: 1; min-width: 0; }
    .slot { height: 44px; }
    .event-block { left: 6px; right: 6px; padding: 6px; }
    .event-title { font-size: .82rem; }
    .event-sub { font-size: .72rem; }
  }
</style>

<div class="form-panel cal-toolbar mb-3">
  <div class="d-flex align-items-center gap-2">
    <button class="btn btn-outline-secondary btn-sm" id="btnPrev">‹</button>
    <button class="btn btn-outline-secondary btn-sm" id="btnToday">Today</button>
    <button class="btn btn-outline-secondary btn-sm" id="btnNext">›</button>
    <span class="ms-2 fw-bold" id="labelRange"></span>
  </div>

  <div class="d-flex align-items-center gap-2">
    <button class="btn btn-outline-secondary btn-sm" id="btnMonth">Month</button>
    <button class="btn btn-outline-secondary btn-sm" id="btnDay">Day</button>
    <button class="btn btn-primary btn-sm" id="btnNew">+ Appointment</button>
    <button class="btn btn-outline-secondary btn-sm" id="btnBlock">+ Block Time</button>
  </div>
</div>

<div class="cal-grid">
  <div id="viewMonth"></div>
  <div id="viewDay" style="display:none;"></div>
</div>

<!-- Modal -->
<div class="modal fade" id="eventModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Appointment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" id="blockTime">
          <label class="form-check-label" for="blockTime">
            Block off time (no customer)
          </label>
        </div>

        <div id="customerFields">
        <div class="mb-2">
          <label class="form-label">Customer</label>
          <input class="form-control" id="custSearch" placeholder="Type a customer name..." autocomplete="off">
          <div class="list-group mt-1" id="custResults" style="max-height:180px; overflow:auto; display:none;"></div>
          <input type="hidden" id="customerId">
          <div class="small-muted mt-1" id="custHint" style="display:none;">
            Tip: press <span class="mono">Enter</span> to pick the first match.
          </div>
        </div>

        <div class="mb-2">
          <label class="form-label">Related Invoice / Estimate (optional)</label>
          <select class="form-select" id="invoiceSelect" disabled>
            <option value="">Select a customer first</option>
          </select>
          <div class="small-muted mt-1">
            <a href="#" id="invoiceLink" class="text-decoration-none" style="display:none;" target="_blank" rel="noopener">
              View selected document
            </a>
          </div>
        </div>
        </div>

        <div class="mb-2">
          <label class="form-label">Title (optional)</label>
          <input class="form-control" id="title">
        </div>

        <div class="row g-2 mb-2">
          <div class="col-6">
            <label class="form-label">Start</label>
            <input class="form-control" id="start" type="datetime-local">
          </div>
          <div class="col-6">
            <label class="form-label">End</label>
            <input class="form-control" id="end" type="datetime-local">
          </div>
        </div>

        <div class="mb-2">
          <label class="form-label">Notes</label>
          <textarea class="form-control" id="notes" rows="3"></textarea>
        </div>

        <div id="recurringSection">
        <hr class="my-3">

        <div class="mb-2">
          <div class="fw-semibold">Recurring Schedule (optional)</div>
          <div class="small-muted">Creates recurring appointments for this customer from the start time.</div>
        </div>

        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" id="recurringEnabled">
          <label class="form-check-label" for="recurringEnabled">
            Enable recurring schedule for this customer
          </label>
        </div>

        <div id="recurringFields" style="display:none;">
          <div class="row g-2 mb-2">
            <div class="col-6">
              <label class="form-label">Repeat every (days)</label>
              <input class="form-control" id="recurringIntervalDays" type="number" min="1" step="1" placeholder="7">
            </div>
            <div class="col-6">
              <label class="form-label">Default duration (minutes)</label>
              <input class="form-control" id="recurringDurationMinutes" type="number" min="15" step="15" placeholder="60">
            </div>
          </div>

          <div class="row g-2 mb-2">
            <div class="col-6">
              <label class="form-label">Schedule out for</label>
              <select class="form-select" id="recurringHorizonMonths">
                <option value="1">1 month</option>
                <option value="2">2 months</option>
                <option value="3">3 months</option>
                <option value="6">6 months</option>
              </select>
            </div>
            <div class="col-6">
              <label class="form-label">Default title (optional)</label>
              <input class="form-control" id="recurringTitle" placeholder="Use appointment title">
            </div>
          </div>

          <div class="mb-2">
            <label class="form-label">Default notes (optional)</label>
            <textarea class="form-control" id="recurringNotes" rows="2" placeholder="Use appointment notes"></textarea>
          </div>
        </div>
        </div>

        <div class="small-muted" id="modalHint"></div>
        <div class="small-muted mt-2" id="recurringHint"></div>
        <input type="hidden" id="eventId">

      </div>

      <div class="modal-footer">
        <button class="btn btn-outline-secondary" id="btnGoCustomer" style="display:none;">Go to Customer</button>
        <button class="btn btn-success" id="btnComplete" style="display:none;">Mark Completed</button>
        <button class="btn btn-outline-warning" id="btnCancel" style="display:none;">Cancelled</button>
        <button class="btn btn-outline-danger" id="btnStopRecurring" style="display:none;">Stop Recurring</button>
        <button class="btn btn-outline-danger" id="btnDelete" style="display:none;">Delete</button>
        <button class="btn btn-primary" id="btnSave">Save</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const DOW = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];

  const state = {
    view: "month",
    cursor: new Date(),   // current month/day pointer
    events: [],
    selectedDay: null,
  };

  const elMonth = document.getElementById("viewMonth");
  const elDay = document.getElementById("viewDay");
  const labelRange = document.getElementById("labelRange");

  const modalEl = document.getElementById("eventModal");
  const modal = new bootstrap.Modal(modalEl);
  const startInput = document.getElementById("start");
  const endInput = document.getElementById("end");
  const blockToggle = document.getElementById("blockTime");
  const customerFields = document.getElementById("customerFields");
  const recurringSection = document.getElementById("recurringSection");
  const recurringEnabled = document.getElementById("recurringEnabled");
  const recurringFields = document.getElementById("recurringFields");
  const recurringIntervalDays = document.getElementById("recurringIntervalDays");
  const recurringDurationMinutes = document.getElementById("recurringDurationMinutes");
  const recurringHorizonMonths = document.getElementById("recurringHorizonMonths");
  const recurringTitle = document.getElementById("recurringTitle");
  const recurringNotes = document.getElementById("recurringNotes");
  const recurringHint = document.getElementById("recurringHint");
  const stopRecurringBtn = document.getElementById("btnStopRecurring");
  const goCustomerBtn = document.getElementById("btnGoCustomer");
  const completeBtn = document.getElementById("btnComplete");
  const cancelBtn = document.getElementById("btnCancel");
  const invoiceSelect = document.getElementById("invoiceSelect");
  const invoiceLink = document.getElementById("invoiceLink");
  let endWasEdited = false;

  // URL deep-links (optional):
  //   /schedule?customer_id=123&date=2026-01-20
  const URLP = new URLSearchParams(window.location.search);
  const PRESELECT_CUSTOMER_ID = (URLP.get("customer_id") || "").trim();
  const PRESELECT_CUSTOMER_NAME = (URLP.get("customer_name") || "").trim();
  const PRESELECT_OPEN_NEW = (URLP.get("open_new") || "").trim();
  const PRESELECT_DATE = (URLP.get("date") || "").trim(); // YYYY-MM-DD

  function pad2(n){ return String(n).padStart(2,"0"); }
  function toISODate(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }

  function toLocalInputValue(d){
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}T${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  }

  function parseISO(s){ return new Date(s); }

  function _parseInputDate(value){
    if (!value) return null;
    const parsed = new Date(value);
    return Number.isNaN(parsed.getTime()) ? null : parsed;
  }

  function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
  function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 1); }

  function startOfDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
  function endOfDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()+1); }

  function escapeHTML(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function updateInvoiceLink(){
    if (!invoiceSelect || !invoiceLink) return;
    const selected = invoiceSelect.options[invoiceSelect.selectedIndex];
    const url = selected ? selected.dataset.url : "";
    if (url) {
      invoiceLink.href = url;
      invoiceLink.style.display = "";
    } else {
      invoiceLink.href = "#";
      invoiceLink.style.display = "none";
    }
  }

  function resetInvoiceSelect(message){
    if (!invoiceSelect) return;
    invoiceSelect.innerHTML = `<option value="">${message}</option>`;
    invoiceSelect.value = "";
    invoiceSelect.disabled = true;
    updateInvoiceLink();
  }

  async function loadCustomerDocuments(customerId, selectedId = ""){
    if (!invoiceSelect) return;
    if (!customerId) {
      resetInvoiceSelect("Select a customer first");
      return;
    }
    invoiceSelect.disabled = true;
    invoiceSelect.innerHTML = `<option value="">Loading...</option>`;
    updateInvoiceLink();
    const res = await fetch(`/api/customers/${customerId}/documents`);
    const rows = await res.json().catch(() => ([]));
    const docs = Array.isArray(rows) ? rows : [];
    if (!docs.length) {
      resetInvoiceSelect("No invoices or estimates found");
      return;
    }
    const options = [`<option value="">None</option>`];
    docs.forEach(doc => {
      const typeLabel = doc.is_estimate ? "Estimate" : "Invoice";
      const parts = [`${typeLabel} ${doc.invoice_number || ""}`.trim()];
      if (doc.vehicle) parts.push(doc.vehicle);
      if (doc.date_in) parts.push(doc.date_in);
      const label = parts.filter(Boolean).join(" • ");
      const url = doc.is_estimate ? `/estimates/${doc.id}` : `/invoices/${doc.id}`;
      options.push(`<option value="${doc.id}" data-url="${url}">${escapeHTML(label)}</option>`);
    });
    invoiceSelect.innerHTML = options.join("");
    invoiceSelect.disabled = false;
    if (selectedId) {
      invoiceSelect.value = String(selectedId);
    }
    updateInvoiceLink();
  }

  function eventDisplayLabel(e){
    if (e.event_type === "block") {
      return (e.title || "Blocked time").trim() || "Blocked time";
    }
    const baseTitle = (e.title || "Appointment").trim();
    const customerName = (e.customer_name || "").trim();
    let label = "";
    if (!customerName) {
      label = baseTitle || "Appointment";
    } else if (!baseTitle) {
      label = customerName;
    } else if (baseTitle.toLowerCase() === customerName.toLowerCase()) {
      label = baseTitle;
    } else {
      label = `${baseTitle} - ${customerName}`;
    }

    if (e.status === "completed") {
      return `✓ ${label}`;
    }
    if (e.status === "cancelled") {
      return `Cancelled: ${label}`;
    }
    return label;
  }

  function eventShortLabel(e){
    if (e.event_type === "block") {
      const title = (e.title || "Blocked").trim();
      return title.split(/\s+/)[0] || "Blocked";
    }
    const customerName = (e.customer_name || "").trim();
    if (customerName) {
      const shortName = customerName.split(/\s+/)[0];
      if (e.status === "completed") return `✓ ${shortName}`;
      if (e.status === "cancelled") return `Cancelled`;
      return shortName;
    }
    const title = (e.title || "Appointment").trim();
    const shortTitle = title.split(/\s+/)[0] || "Appt";
    if (e.status === "completed") return `✓ ${shortTitle}`;
    if (e.status === "cancelled") return `Cancelled`;
    return shortTitle;
  }

  function getPopover(){
    let popover = document.getElementById("evtPopover");
    if (!popover){
      popover = document.createElement("div");
      popover.id = "evtPopover";
      popover.className = "evt-popover";
      popover.style.display = "none";
      document.body.appendChild(popover);
    }
    return popover;
  }

  function positionPopover(event){
    const popover = getPopover();
    const pad = 12;
    const maxX = window.innerWidth - popover.offsetWidth - pad;
    const maxY = window.innerHeight - popover.offsetHeight - pad;
    const x = Math.min(event.clientX + pad, maxX);
    const y = Math.min(event.clientY + pad, maxY);
    popover.style.left = `${Math.max(pad, x)}px`;
    popover.style.top = `${Math.max(pad, y)}px`;
  }

  async function loadEvents(rangeStart, rangeEnd){
    const qs = new URLSearchParams({ start: toISODate(rangeStart), end: toISODate(rangeEnd) });
    const res = await fetch(`/api/schedule/events?${qs.toString()}`);
    state.events = await res.json();
  }

  function setLabel(){
    if (state.view === "month"){
      const d = state.cursor;
      labelRange.textContent = d.toLocaleString(undefined, { month:"long", year:"numeric" });
    } else {
      const d = state.selectedDay || state.cursor;
      labelRange.textContent = d.toLocaleDateString(undefined, { weekday:"long", month:"long", day:"numeric", year:"numeric" });
    }
  }

  function renderMonth(){
    setLabel();
    elMonth.style.display = "";
    elDay.style.display = "none";

    const base = startOfMonth(state.cursor);
    const todayIso = toISODate(new Date());
    const gridStart = new Date(base);
    gridStart.setDate(base.getDate() - base.getDay()); // back to Sunday

    // header row
    let html = `<div class="month-scroll"><div class="month-grid mb-2">`;
    for (const h of DOW){
      html += `<div class="dow">${h}</div>`;
    }
    html += `</div>`;

    // 6 weeks grid
    html += `<div class="month-grid">`;
    for (let i=0;i<42;i++){
      const d = new Date(gridStart);
      d.setDate(gridStart.getDate() + i);

      const inMonth = d.getMonth() === state.cursor.getMonth();
      const iso = toISODate(d);
      const isToday = iso === todayIso;

      // events that touch this day
      const evts = state.events
        .filter(e => e.start.slice(0,10) <= iso && e.end.slice(0,10) >= iso)
        .slice(0,3);

      const startsCount = state.events.filter(e => e.start.slice(0,10) === iso).length;
      html += `<div class="day-cell ${inMonth ? "" : "muted"}${isToday ? " today" : ""}" data-day="${iso}">
        <div class="day-head">
          <div class="day-num">${d.getDate()}</div>
          ${startsCount > 0 ? `<span class="day-indicator">${startsCount}</span>` : ""}
        </div>`;

      evts.forEach(e => {
        const isBlock = e.event_type === "block";
        const pillCls = e.status === "cancelled" ? "evt-pill cancelled" : "evt-pill";
        const fullCls = e.status === "cancelled" ? "evt-full cancelled" : "evt-full";
        const label = eventDisplayLabel(e);
        const shortLabel = eventShortLabel(e);
        const safeTitle = escapeHTML(label);
        const blockClass = isBlock ? " block" : "";
        html += `
          <span class="${fullCls}${blockClass}">${safeTitle}</span>
          <span class="${pillCls}${blockClass}" data-full-label="${safeTitle}">
            <span class="evt-name">${escapeHTML(shortLabel)}</span>
          </span>
        `;
      });

      if (startsCount > 3){
        html += `<div class="small-muted mt-1">+ more</div>`;
      }

      html += `</div>`;
    }
    html += `</div></div>`;

    elMonth.innerHTML = html;

    const popover = getPopover();
    elMonth.querySelectorAll(".day-cell").forEach(cell => {
      if (cell.scrollHeight > cell.clientHeight){
        cell.classList.add("compact");
      }
    });

    elMonth.querySelectorAll(".day-cell").forEach(cell => {
      cell.addEventListener("click", () => {
        const iso = cell.getAttribute("data-day");
        const [y,m,dd] = iso.split("-").map(Number);
        state.selectedDay = new Date(y, m-1, dd);
        state.view = "day";
        renderDay();
      });
    });

    elMonth.querySelectorAll(".evt-pill").forEach(pill => {
      pill.addEventListener("mouseenter", (e) => {
        const label = pill.getAttribute("data-full-label");
        if (!label) return;
        popover.textContent = label;
        popover.style.display = "block";
        positionPopover(e);
      });
      pill.addEventListener("mousemove", (e) => positionPopover(e));
      pill.addEventListener("mouseleave", () => {
        popover.style.display = "none";
      });
    });
  }

  function renderDay(){
    setLabel();
    elMonth.style.display = "none";
    elDay.style.display = "";

    const day = state.selectedDay || state.cursor;
    const dayStart = startOfDay(day);
    const dayEnd = endOfDay(day);

    // hours shown
    const hourStart = 6;   // 6am
    const hourEnd = 20;    // 8pm
    const pxPerMin = 48 / 60; // 48px per hour

    // left column times + timeline slots
    let times = "";
    let slots = "";
    for (let h=hourStart; h<=hourEnd; h++){
      const label = new Date(dayStart);
      label.setHours(h,0,0,0);
      times += `<div class="time-row">${label.toLocaleTimeString([], {hour:"numeric"})}</div>`;
      slots += `<div class="slot" data-hour="${h}"></div>`;
    }

    elDay.innerHTML = `
      <div class="day-wrap">
        <div class="time-col">${times}</div>
        <div class="timeline" id="timeline">
          ${slots}
        </div>
      </div>
    `;

    const timeline = document.getElementById("timeline");

    // events on this day
    const isoDay = toISODate(dayStart);
    const dayEvents = state.events.filter(e => {
      const s = parseISO(e.start);
      const en = parseISO(e.end);
      return s < dayEnd && en > dayStart;
    });

    dayEvents.forEach(e => {
      const s = parseISO(e.start);
      const en = parseISO(e.end);
      const blockStart = s < dayStart ? dayStart : s;
      const blockEnd = en > dayEnd ? dayEnd : en;
      const now = new Date();
      const isBlock = e.event_type === "block";
      const canUpdateStatus = !isBlock && now > en && e.status === "scheduled";

      const minutesFromStart = (blockStart.getHours() - hourStart) * 60 + blockStart.getMinutes();
      const durMin = Math.max(15, (blockEnd - blockStart) / 60000);

      const top = Math.max(0, minutesFromStart * pxPerMin);
      const height = Math.max(18, durMin * pxPerMin);

      const block = document.createElement("div");
      block.className = `event-block${isBlock ? " block" : ""}`;
      block.style.top = `${top}px`;
      block.style.height = `${height}px`;
      block.dataset.id = e.id;

      const titleLabel = eventDisplayLabel(e);
      const statusActions = canUpdateStatus ? `
        <div class="event-actions">
          <button type="button" class="event-action-btn complete" data-action="complete" title="Mark completed">✓</button>
          <button type="button" class="event-action-btn cancel" data-action="cancel" title="Cancelled">✕</button>
        </div>
      ` : "";
      const invoiceLabel = e.invoice_is_estimate ? "Estimate" : "Invoice";
      const invoiceLink = e.invoice_url ? `
        <a class="event-link" href="${e.invoice_url}" target="_blank" rel="noopener">
          View ${invoiceLabel} ${escapeHTML(e.invoice_number || "")}
        </a>
      ` : "";

      block.innerHTML = `
        ${statusActions}
        <div class="event-title">${escapeHTML(titleLabel)}</div>
        <div class="event-sub">${blockStart.toLocaleTimeString([], {hour:"numeric", minute:"2-digit"})} - ${blockEnd.toLocaleTimeString([], {hour:"numeric", minute:"2-digit"})}</div>
        ${invoiceLink}
      `;

      block.addEventListener("click", (ev) => {
        ev.stopPropagation();
        openModalForEdit(e);
      });

      if (canUpdateStatus){
        block.querySelectorAll("button[data-action]").forEach(btn => {
          btn.addEventListener("click", async (ev) => {
            ev.stopPropagation();
            const action = btn.getAttribute("data-action");
            const status = action === "complete" ? "completed" : "cancelled";
            await updateEventStatus(e.id, status);
          });
        });
      }

      timeline.appendChild(block);
    });

    // click on timeline to create an event
    timeline.addEventListener("click", (ev) => {
      const rect = timeline.getBoundingClientRect();
      const y = ev.clientY - rect.top;
      const mins = Math.max(0, Math.round(y / pxPerMin / 15) * 15); // snap 15 mins
      const start = new Date(dayStart);
      start.setHours(hourStart, 0, 0, 0);
      start.setMinutes(start.getMinutes() + mins);

      const end = new Date(start);
      end.setMinutes(end.getMinutes() + 60);

      openModalForCreate(start, end);
    });
  }

  function getDefaultStartForView(){
    const baseDay = state.selectedDay || state.cursor || new Date();
    const now = new Date();
    const start = new Date(baseDay);
    start.setHours(now.getHours(), now.getMinutes(), 0, 0);
    return start;
  }

  function setEndFromStart(startDt){
    if (!startDt) return;
    const end = new Date(startDt);
    end.setMinutes(end.getMinutes() + 60);
    endInput.value = toLocalInputValue(end);
  }

  function syncRecurringVisibility(){
    const enabled = !!recurringEnabled.checked;
    recurringFields.style.display = enabled ? "" : "none";
    recurringHint.textContent = enabled
      ? "Recurring settings apply to this customer and schedule future appointments."
      : "";
    if (enabled && !recurringDurationMinutes.value){
      const startDt = _parseInputDate(startInput.value);
      const endDt = _parseInputDate(endInput.value);
      if (startDt && endDt){
        const minutes = Math.max(15, Math.round((endDt - startDt) / 60000));
        recurringDurationMinutes.value = String(minutes);
      }
    }
  }

  function resetRecurringFields(){
    recurringEnabled.checked = false;
    recurringIntervalDays.value = "";
    recurringDurationMinutes.value = "";
    recurringHorizonMonths.value = "1";
    recurringTitle.value = "";
    recurringNotes.value = "";
    recurringHint.textContent = "";
    recurringFields.style.display = "none";
    stopRecurringBtn.style.display = "none";
  }

  function setBlockMode(isBlock){
    if (blockToggle){
      blockToggle.checked = isBlock;
    }
    if (customerFields){
      customerFields.style.display = isBlock ? "none" : "";
    }
    if (recurringSection){
      recurringSection.style.display = isBlock ? "none" : "";
    }
    if (isBlock){
      document.getElementById("customerId").value = "";
      document.getElementById("custSearch").value = "";
      hideCustResults();
      resetInvoiceSelect("Blocked time has no documents");
      resetRecurringFields();
      const titleInput = document.getElementById("title");
      if (titleInput && !(titleInput.value || "").trim()){
        titleInput.value = "Blocked time";
      }
    }
    updateGoToCustomerButton();
  }

  if (blockToggle){
    blockToggle.addEventListener("change", () => {
      setBlockMode(blockToggle.checked);
    });
  }

  if (recurringEnabled){
    recurringEnabled.addEventListener("change", syncRecurringVisibility);
  }

  if (startInput && endInput){
    startInput.addEventListener("change", () => {
      const startDt = _parseInputDate(startInput.value);
      if (!endWasEdited){
        setEndFromStart(startDt);
      }
    });
    endInput.addEventListener("change", () => {
      endWasEdited = true;
    });
  }

  function updateGoToCustomerButton(){
    if (!goCustomerBtn) return;
    const customerId = document.getElementById("customerId").value;
    if (customerId && !blockToggle.checked) {
      goCustomerBtn.style.display = "";
      goCustomerBtn.dataset.customerId = customerId;
    } else {
      goCustomerBtn.style.display = "none";
      goCustomerBtn.dataset.customerId = "";
    }
  }

  function _applyPreselectedCustomerIfAny(){
    // If we have a customer_id in the URL, set it so saves link correctly.
    // If customer_name is provided, prefill the search box for convenience.
    if (PRESELECT_CUSTOMER_ID && /^\d+$/.test(PRESELECT_CUSTOMER_ID) && !blockToggle.checked){
      document.getElementById("customerId").value = PRESELECT_CUSTOMER_ID;
      if (PRESELECT_CUSTOMER_NAME){
        document.getElementById("custSearch").value = PRESELECT_CUSTOMER_NAME;
      }
      loadCustomerDocuments(PRESELECT_CUSTOMER_ID);
      // If user starts typing and selects someone else, this will be replaced.
    }
  }

  function openModalForCreate(start, end, isBlock = false){
    document.getElementById("modalTitle").textContent = isBlock ? "New Blocked Time" : "New Appointment";
    document.getElementById("eventId").value = "";
    document.getElementById("btnDelete").style.display = "none";

    document.getElementById("customerId").value = "";
    document.getElementById("custSearch").value = "";
    resetInvoiceSelect("Select a customer first");
    document.getElementById("title").value = "";
    document.getElementById("notes").value = "";
    setBlockMode(isBlock);

    endWasEdited = false;
    startInput.value = toLocalInputValue(start);
    endInput.value = toLocalInputValue(end);
    document.getElementById("modalHint").textContent = "Tip: click a time slot in Day view to auto-fill start/end.";

    custResults.style.display = "none";
    custHint.style.display = "none";
    custActiveIndex = -1;

    if (!isBlock){
      resetRecurringFields();
      _applyPreselectedCustomerIfAny();
    }
    updateGoToCustomerButton();
    modal.show();

    // if a customer_id was deep-linked, keep title blank unless user fills it
    // (optional: you can set title to customer name once you add a customer lookup endpoint)
  }

  function openModalForEdit(e){
    const isBlock = e.event_type === "block";
    document.getElementById("modalTitle").textContent = isBlock ? "Edit Blocked Time" : "Edit Appointment";
    document.getElementById("eventId").value = e.id;
    document.getElementById("btnDelete").style.display = "";

    document.getElementById("customerId").value = e.customer_id || "";
    document.getElementById("custSearch").value = e.customer_name || "";
    if (!isBlock && e.customer_id) {
      loadCustomerDocuments(e.customer_id, e.invoice_id || "");
    } else {
      resetInvoiceSelect(isBlock ? "Blocked time has no documents" : "Select a customer first");
    }

    document.getElementById("title").value = e.title || "";
    document.getElementById("notes").value = e.notes || "";
    setBlockMode(isBlock);
    endWasEdited = false;
    startInput.value = toLocalInputValue(parseISO(e.start));
    endInput.value = toLocalInputValue(parseISO(e.end));
    document.getElementById("modalHint").textContent = "";

    custResults.style.display = "none";
    custHint.style.display = "none";
    custActiveIndex = -1;

    resetRecurringFields();
    updateGoToCustomerButton();
    if (!isBlock && e.customer_recurring) {
      const rec = e.customer_recurring;
      if (rec.interval_days) {
        stopRecurringBtn.style.display = "";
        recurringHint.textContent = "Recurring schedule already exists for this customer.";
      }
      recurringIntervalDays.value = rec.interval_days || "";
      recurringDurationMinutes.value = rec.default_minutes || "";
      recurringTitle.value = rec.title || "";
      recurringNotes.value = rec.notes || "";
    }

    const now = new Date();
    const endDt = parseISO(e.end);
    const canUpdateStatus = !isBlock && now > endDt && e.status === "scheduled";
    if (completeBtn && cancelBtn){
      if (canUpdateStatus){
        completeBtn.style.display = "";
        cancelBtn.style.display = "";
        completeBtn.onclick = async (ev) => {
          ev.preventDefault();
          await updateEventStatus(e.id, "completed");
          modal.hide();
        };
        cancelBtn.onclick = async (ev) => {
          ev.preventDefault();
          await updateEventStatus(e.id, "cancelled");
          modal.hide();
        };
      } else {
        completeBtn.style.display = "none";
        cancelBtn.style.display = "none";
        completeBtn.onclick = null;
        cancelBtn.onclick = null;
      }
    }

    modal.show();
  }

  async function refresh(){
    if (state.view === "month"){
      const a = startOfMonth(state.cursor);
      const b = endOfMonth(state.cursor);
      await loadEvents(a, b);
      renderMonth();
    } else {
      const d = state.selectedDay || state.cursor;
      const a = startOfDay(d);
      const b = endOfDay(d);
      await loadEvents(a, b);
      renderDay();
    }
  }

  // Toolbar buttons
  document.getElementById("btnMonth").addEventListener("click", async () => {
    state.view = "month";
    await refresh();
    document.getElementById("btnMonth").className = "btn btn-outline-dark btn-sm";
    document.getElementById("btnDay").className = "btn btn-outline-dark btn-sm";
  });

  document.getElementById("btnDay").addEventListener("click", async () => {
    state.view = "day";
    state.selectedDay = state.selectedDay || new Date(state.cursor);
    await refresh();
    document.getElementById("btnDay").className = "btn btn-outline-dark btn-sm";
    document.getElementById("btnMonth").className = "btn btn-outline-dark btn-sm";
  });

  document.getElementById("btnPrev").addEventListener("click", async () => {
    if (state.view === "month"){
      state.cursor = new Date(state.cursor.getFullYear(), state.cursor.getMonth()-1, 1);
    } else {
      state.selectedDay = new Date((state.selectedDay || state.cursor).getTime() - 86400000);
    }
    await refresh();
  });

  document.getElementById("btnNext").addEventListener("click", async () => {
    if (state.view === "month"){
      state.cursor = new Date(state.cursor.getFullYear(), state.cursor.getMonth()+1, 1);
    } else {
      state.selectedDay = new Date((state.selectedDay || state.cursor).getTime() + 86400000);
    }
    await refresh();
  });

  document.getElementById("btnToday").addEventListener("click", async () => {
    state.cursor = new Date();
    state.selectedDay = new Date();
    await refresh();
  });

  document.getElementById("btnNew").addEventListener("click", () => {
    const start = getDefaultStartForView();
    const end = new Date(start);
    end.setMinutes(end.getMinutes() + 60);
    openModalForCreate(start, end);
  });

  document.getElementById("btnBlock").addEventListener("click", () => {
    const start = getDefaultStartForView();
    const end = new Date(start);
    end.setMinutes(end.getMinutes() + 60);
    openModalForCreate(start, end, true);
  });

  // Save/Delete
  document.getElementById("btnSave").addEventListener("click", async () => {
    const id = document.getElementById("eventId").value;
    const isRecurring = !!recurringEnabled.checked;
    const isBlock = !!blockToggle.checked;
    const customerId = isBlock ? null : (document.getElementById("customerId").value || null);
    const invoiceId = isBlock ? null : (invoiceSelect ? (invoiceSelect.value || null) : null);
    const payload = {
      customer_id: customerId,
      invoice_id: invoiceId,
      title: document.getElementById("title").value,
      notes: document.getElementById("notes").value,
      start: startInput.value,
      end: endInput.value,
      event_type: isBlock ? "block" : "appointment",
    };

    if (isRecurring){
      if (isBlock){
        alert("Blocked time cannot be saved as recurring.");
        return;
      }
      if (!customerId){
        alert("Please select a customer before enabling recurring scheduling.");
        return;
      }
      payload.recurring_enabled = true;
      payload.recurring_interval_days = recurringIntervalDays.value;
      payload.recurring_duration_minutes = recurringDurationMinutes.value;
      payload.recurring_horizon_months = recurringHorizonMonths.value;
      payload.recurring_title = recurringTitle.value;
      payload.recurring_notes = recurringNotes.value;
    }

    const res = await fetch(id ? `/api/schedule/events/${id}` : "/api/schedule/events", {
      method: id ? "PUT" : "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });

    if (!res.ok){
      const j = await res.json().catch(() => ({}));
      alert(j.error || "Error saving event");
      return;
    }

    modal.hide();
    await refresh();
  });

  document.getElementById("btnDelete").addEventListener("click", async () => {
    const id = document.getElementById("eventId").value;
    if (!id) return;
    const isBlock = !!blockToggle.checked;
    if (!confirm(isBlock ? "Delete this blocked time?" : "Delete this appointment?")) return;

    const res = await fetch(`/api/schedule/events/${id}`, { method:"DELETE" });
    if (!res.ok){
      const j = await res.json().catch(() => ({}));
      alert(j.error || "Error deleting event");
      return;
    }
    modal.hide();
    await refresh();
  });

  stopRecurringBtn.addEventListener("click", async () => {
    const customerId = document.getElementById("customerId").value;
    if (!customerId){
      alert("Select a customer to stop recurring scheduling.");
      return;
    }
    if (!confirm("Disable recurring scheduling for this customer and delete future recurring appointments?")) {
      return;
    }
    const res = await fetch(`/customers/${customerId}/recurring/disable`, { method:"POST" });
    if (!res.ok){
      alert("Error disabling recurring schedule.");
      return;
    }
    resetRecurringFields();
    stopRecurringBtn.style.display = "none";
    await refresh();
  });

  if (goCustomerBtn){
    goCustomerBtn.addEventListener("click", (e) => {
      e.preventDefault();
      const customerId = goCustomerBtn.dataset.customerId;
      if (customerId){
        window.location.href = `/customers/${customerId}`;
      }
    });
  }

  if (invoiceSelect){
    invoiceSelect.addEventListener("change", updateInvoiceLink);
  }

  async function updateEventStatus(eventId, status){
    const res = await fetch(`/api/schedule/events/${eventId}`, {
      method: "PUT",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ status })
    });
    if (!res.ok){
      const j = await res.json().catch(() => ({}));
      alert(j.error || "Error updating appointment status");
      return;
    }
    await refresh();
  }

  // -----------------------------
  // Customer typeahead (with Enter + arrow nav)
  // -----------------------------
  const custSearch = document.getElementById("custSearch");
  const custResults = document.getElementById("custResults");
  const custHint = document.getElementById("custHint");

  let custTimer = null;
  let custRowsCache = [];
  let custActiveIndex = -1;

  function hideCustResults(){
    custResults.style.display = "none";
    custHint.style.display = "none";
    custActiveIndex = -1;
    custRowsCache = [];
  }

  function setActive(index){
    custActiveIndex = index;
    const btns = [...custResults.querySelectorAll("button")];
    btns.forEach((b, i) => {
      if (i === custActiveIndex) {
        b.classList.add("active");
        b.scrollIntoView({ block: "nearest" });
      } else {
        b.classList.remove("active");
      }
    });
  }

  function pickCustomerByIndex(index){
    const row = custRowsCache[index];
    if (!row) return false;

    document.getElementById("customerId").value = row.id;
    custSearch.value = row.name;
    hideCustResults();
    updateGoToCustomerButton();
    loadCustomerDocuments(row.id);

    // If title is blank, default it to customer name
    const t = document.getElementById("title");
    if (t && !(t.value || "").trim()){
      t.value = row.name;
    }
    return true;
  }

  custSearch.addEventListener("input", () => {
    const q = custSearch.value.trim();

    // whenever user types, clear selected id until they pick
    document.getElementById("customerId").value = "";
    resetInvoiceSelect("Select a customer first");
    updateGoToCustomerButton();
    if (custTimer) clearTimeout(custTimer);

    if (!q){
      hideCustResults();
      return;
    }

    custTimer = setTimeout(async () => {
      const res = await fetch(`/api/customers/search?q=${encodeURIComponent(q)}`);
      const rows = await res.json();
      custRowsCache = Array.isArray(rows) ? rows : [];
      custActiveIndex = -1;

      custResults.innerHTML = custRowsCache.map((r, idx) => `
        <button type="button" class="list-group-item list-group-item-action" data-idx="${idx}">
          <div class="fw-bold">${escapeHTML(r.name)}</div>
          <div class="small-muted">${escapeHTML([r.phone, r.email].filter(Boolean).join(" • "))}</div>
        </button>
      `).join("");

      if (custRowsCache.length){
        custResults.style.display = "";
        custHint.style.display = "";
        custResults.querySelectorAll("button").forEach(btn => {
          btn.addEventListener("click", () => {
            const idx = parseInt(btn.dataset.idx, 10);
            pickCustomerByIndex(idx);
          });
        });
      } else {
        hideCustResults();
      }
    }, 200);
  });

  custSearch.addEventListener("keydown", (e) => {
    if (custResults.style.display === "none") return;

    const count = custRowsCache.length;
    if (!count) return;

    if (e.key === "ArrowDown"){
      e.preventDefault();
      const next = Math.min(count - 1, custActiveIndex + 1);
      setActive(next);
    } else if (e.key === "ArrowUp"){
      e.preventDefault();
      const prev = Math.max(0, custActiveIndex - 1);
      setActive(prev);
    } else if (e.key === "Enter"){
      // Press Enter to choose highlighted; if none highlighted, choose first
      e.preventDefault();
      const idx = (custActiveIndex >= 0 ? custActiveIndex : 0);
      pickCustomerByIndex(idx);
    } else if (e.key === "Escape"){
      hideCustResults();
    }
  });

  document.addEventListener("click", (e) => {
    if (!custResults.contains(e.target) && e.target !== custSearch){
      hideCustResults();
    }
  });

  // -----------------------------
  // Initial load:
  // If a date=YYYY-MM-DD is provided, jump to that day in Day view.
  // -----------------------------
  (async () => {
    if (/^\d{4}-\d{2}-\d{2}$/.test(PRESELECT_DATE)){
      const [y,m,d] = PRESELECT_DATE.split("-").map(Number);
      const dt = new Date(y, m-1, d);
      state.cursor = dt;
      state.selectedDay = dt;
      state.view = "day";
      document.getElementById("btnDay").className = "btn btn-outline-dark btn-sm";
      document.getElementById("btnMonth").className = "btn btn-outline-dark btn-sm";
    }
    await refresh();
    if (PRESELECT_OPEN_NEW === "1" || PRESELECT_OPEN_NEW.toLowerCase() === "true"){
      const start = getDefaultStartForView();
      const end = new Date(start);
      end.setMinutes(end.getMinutes() + 60);
      openModalForCreate(start, end);
    }
  })();
</script>
{% endblock %}
