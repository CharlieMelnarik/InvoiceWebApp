{% extends "base.html" %}
{% set title = "Settings" %}

{% block content %}
<style>
  :root {
    --settings-border: #d6deeb;
    --settings-border-strong: #bfcde0;
    --settings-bg-soft: #f2f6fc;
    --settings-text-muted: #556a89;
    --settings-shadow: 0 16px 36px rgba(16, 38, 72, 0.12);
    --settings-shadow-soft: 0 8px 20px rgba(16, 38, 72, 0.08);
    --settings-premium: #c79a4b;
    --settings-premium-soft: #f4e5c8;
    --settings-navy: #12335f;
  }
  .settings-shell {
    max-width: 1240px;
    margin: 0 auto;
    padding-bottom: 18px;
    position: relative;
  }
  .settings-shell::before {
    content: "";
    position: absolute;
    inset: -18px -24px auto -24px;
    height: 240px;
    border-radius: 22px;
    background: radial-gradient(1200px 260px at 10% 0%, rgba(31, 88, 168, 0.12), transparent 58%),
                radial-gradient(900px 220px at 90% 8%, rgba(199, 154, 75, 0.14), transparent 60%);
    pointer-events: none;
    z-index: 0;
  }
  .settings-shell > * {
    position: relative;
    z-index: 1;
  }
  .settings-jump {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 16px;
    position: sticky;
    top: 10px;
    z-index: 5;
    background: linear-gradient(180deg, rgba(248, 251, 255, 0.98), rgba(246, 250, 255, 0.92));
    border: 1px solid var(--settings-border);
    border-radius: 12px;
    padding: 10px;
    backdrop-filter: blur(2px);
    box-shadow: var(--settings-shadow-soft);
  }
  .settings-jump-link {
    padding: 0.4rem 0.78rem;
    border: 1px solid var(--settings-border);
    border-radius: 999px;
    font-size: 0.85rem;
    font-weight: 600;
    color: #415a81;
    text-decoration: none;
    background: linear-gradient(180deg, #ffffff 0%, #f8fbff 100%);
    transition: all 0.18s ease;
  }
  .settings-jump-link:hover {
    color: #1b3f76;
    border-color: #acc4e6;
    background: linear-gradient(180deg, #f8fbff 0%, #edf4ff 100%);
    transform: translateY(-1px);
  }
  .settings-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 16px;
  }
  .settings-card {
    border: 1px solid #d4deed;
    border-radius: 16px;
    background: linear-gradient(180deg, #ffffff 0%, #fbfdff 100%);
    box-shadow: var(--settings-shadow);
    padding: 18px;
  }
  .settings-card h5 {
    margin: 0;
    font-size: 1.03rem;
    font-weight: 850;
    color: var(--settings-navy);
    letter-spacing: 0.01em;
    border-left: 3px solid #2a66b9;
    padding-left: 8px;
  }
  .settings-card-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
    border-bottom: 1px solid #e4ebf6;
    padding-bottom: 8px;
  }
  .settings-help {
    color: var(--settings-text-muted);
    font-size: 0.84rem;
    margin-bottom: 14px;
    line-height: 1.42;
  }
  .compact-label {
    font-size: 0.84rem;
    font-weight: 600;
    color: #324867;
    margin-bottom: 0.3rem;
  }
  .settings-shell .form-control,
  .settings-shell .form-select {
    border-color: #c6d3e5;
    border-radius: 10px;
    min-height: 40px;
    font-size: 0.95rem;
    box-shadow: none;
    background: linear-gradient(180deg, #ffffff 0%, #fbfdff 100%);
  }
  .settings-shell .form-control:focus,
  .settings-shell .form-select:focus {
    border-color: #7ca2d8;
    box-shadow: 0 0 0 0.22rem rgba(30, 86, 161, 0.14);
  }
  .settings-shell .small-muted {
    color: var(--settings-text-muted) !important;
  }
  .settings-shell .list-group-item {
    border-color: #e1e9f5;
    padding: 0.72rem 0.86rem;
  }
  .live-preview-wrap {
    border: 1px solid #d4deed;
    border-radius: 14px;
    background: linear-gradient(180deg, #f9fcff 0%, #f1f6ff 100%);
    padding: 12px;
    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.8);
  }
  .live-preview-title {
    font-size: 0.93rem;
    font-weight: 800;
    color: #233f63;
    margin-bottom: 8px;
  }
  .live-preview-frame {
    width: 100%;
    height: 560px;
    border: 1px solid #cad6ea;
    border-radius: 10px;
    background: #fff;
  }
  .save-row {
    position: sticky;
    bottom: 12px;
    z-index: 3;
    display: flex;
    justify-content: flex-end;
    margin-top: 12px;
  }
  .save-pill {
    box-shadow: 0 12px 28px rgba(10, 41, 84, 0.2);
    border-radius: 12px;
    padding-left: 1rem;
    padding-right: 1rem;
    border: 1px solid #0f3f7d;
    background: linear-gradient(180deg, #1f5fb5 0%, #174b93 100%);
  }
  .save-pill:hover {
    background: linear-gradient(180deg, #225fb1 0%, #133f7e 100%);
  }
  .settings-shell .badge.text-bg-light.border {
    background: linear-gradient(180deg, #fff8ec 0%, #f8ecd5 100%) !important;
    border-color: #edd8ad !important;
    color: #6b4a12 !important;
  }
  #section-employees .btn-outline-danger.btn-sm {
    padding: 0.2rem 0.56rem;
  }
  @media (min-width: 992px) {
    .settings-grid {
      grid-template-columns: 1fr 1fr;
    }
    .span-2 {
      grid-column: span 2;
    }
  }
</style>

<div class="settings-shell">
  <div class="page-header">
    <div>
      <h1 class="h3 fw-bold mb-1">Settings</h1>
      <div class="subtitle">Cleaner defaults, document styling, scheduler notifications, and account controls.</div>
    </div>
    <div class="action-group">
      {% if not is_employee_account %}
        <a href="{{ url_for('billing') }}" class="btn btn-outline-primary">Billing</a>
      {% endif %}
      <a href="{{ url_for('invoices') }}" class="btn btn-outline-secondary">Back to Invoices</a>
    </div>
  </div>

  <div class="settings-jump">
    <a class="settings-jump-link" href="#section-account">Account</a>
    <a class="settings-jump-link" href="#section-invoice">Invoice Defaults</a>
    <a class="settings-jump-link" href="#section-preview">PDF Preview</a>
    {% if pro_features_enabled %}
      <a class="settings-jump-link" href="#section-payments">Payments</a>
    {% endif %}
    <a class="settings-jump-link" href="#section-contact">Business Info</a>
    <a class="settings-jump-link" href="#section-scheduler">Scheduler</a>
    <a class="settings-jump-link" href="#section-logo">Logo</a>
    {% if not is_employee_account %}
      <a class="settings-jump-link" href="#section-employees">Employees</a>
    {% endif %}
  </div>

  <form method="post" enctype="multipart/form-data">
    <div class="settings-grid">

      <section class="settings-card" id="section-account">
        <div class="settings-card-head">
          <h5>Account</h5>
        </div>
        <div class="settings-help">Your login and top-level profile defaults.</div>
        <div class="mb-3">
          <label class="form-label compact-label req">Email Address</label>
          <input type="email" class="form-control" name="email" value="{{ u.email or '' }}" required>
          <div class="small-muted mt-1">Used for password resets.</div>
        </div>
        <div class="mb-0">
          <label class="form-label compact-label req">Business Type / Profession</label>
          <select class="form-select" id="invoiceTemplateSelect" name="invoice_template" required>
            {% for key, cfg in templates.items() %}
              <option value="{{ key }}" {% if (u.invoice_template or 'auto_repair') == key %}selected{% endif %}>{{ cfg.label }}</option>
            {% endfor %}
          </select>
          <div class="small-muted mt-1">New documents use this style. Existing documents keep their saved template.</div>
        </div>
      </section>

      <section class="settings-card" id="section-invoice">
        <div class="settings-card-head">
          <h5>Invoice Defaults</h5>
        </div>
        <div class="settings-help">Defaults applied to new invoices and estimates.</div>
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label compact-label">Default Tax (%)</label>
            <input type="text" class="form-control" name="tax_rate" inputmode="decimal" value="{{ u.tax_rate if u.tax_rate is not none else '0' }}" placeholder="0.0">
          </div>
          <div class="col-md-4">
            <label class="form-label compact-label">Default Hourly Rate</label>
            <input type="text" class="form-control" name="default_hourly_rate" inputmode="decimal" value="{{ u.default_hourly_rate if u.default_hourly_rate is not none else '0' }}" placeholder="0.00">
          </div>
          <div class="col-md-4">
            <label class="form-label compact-label">Default Parts Markup (%)</label>
            <input type="text" class="form-control" name="default_parts_markup" inputmode="decimal" value="{{ u.default_parts_markup if u.default_parts_markup is not none else '0' }}" placeholder="0.0">
          </div>
        </div>
      </section>

      <section class="settings-card span-2" id="customProfessionCard" style="display:none;">
        <div class="settings-card-head">
          <h5>Custom Profession Builder</h5>
        </div>
        <div class="settings-help">Define your own labels and show/hide sections for invoices and estimates.</div>
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label compact-label">Custom Profession Name</label>
            <input class="form-control" name="custom_profession_name" value="{{ u.custom_profession_name or '' }}" placeholder="e.g. Window Tinting">
          </div>
          <div class="col-md-4">
            <label class="form-label compact-label">Job Label</label>
            <input class="form-control" name="custom_job_label" value="{{ u.custom_job_label or '' }}" placeholder="e.g. Service Location">
          </div>
          <div class="col-md-4">
            <label class="form-label compact-label">Labor Section Title</label>
            <input class="form-control" name="custom_labor_title" value="{{ u.custom_labor_title or '' }}" placeholder="e.g. Services">
          </div>
          <div class="col-md-4">
            <label class="form-label compact-label">Labor Description Label</label>
            <input class="form-control" name="custom_labor_desc_label" value="{{ u.custom_labor_desc_label or '' }}" placeholder="e.g. Service Description">
          </div>
          <div class="col-md-4">
            <label class="form-label compact-label">Parts Section Title</label>
            <input class="form-control" name="custom_parts_title" value="{{ u.custom_parts_title or '' }}" placeholder="e.g. Materials">
          </div>
          <div class="col-md-4">
            <label class="form-label compact-label">Parts Item Label</label>
            <input class="form-control" name="custom_parts_name_label" value="{{ u.custom_parts_name_label or '' }}" placeholder="e.g. Material Name">
          </div>
          <div class="col-md-4">
            <label class="form-label compact-label">Additional Fees Label</label>
            <input class="form-control" name="custom_shop_supplies_label" value="{{ u.custom_shop_supplies_label or '' }}" placeholder="e.g. Travel Fee">
          </div>
          <div class="col-md-8">
            <label class="form-label compact-label">Show These Sections</label>
            <div class="d-flex flex-wrap gap-3 pt-1">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="customShowJob" name="custom_show_job" value="1" {% if u.custom_show_job is not defined or u.custom_show_job %}checked{% endif %}>
                <label class="form-check-label" for="customShowJob">Job</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="customShowLabor" name="custom_show_labor" value="1" {% if u.custom_show_labor is not defined or u.custom_show_labor %}checked{% endif %}>
                <label class="form-check-label" for="customShowLabor">Labor</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="customShowParts" name="custom_show_parts" value="1" {% if u.custom_show_parts is not defined or u.custom_show_parts %}checked{% endif %}>
                <label class="form-check-label" for="customShowParts">Parts</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="customShowFees" name="custom_show_shop_supplies" value="1" {% if u.custom_show_shop_supplies is not defined or u.custom_show_shop_supplies %}checked{% endif %}>
                <label class="form-check-label" for="customShowFees">Additional fees</label>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="settings-card span-2" id="section-preview">
        <div class="settings-card-head">
          <h5>Live PDF Preview & Layout</h5>
        </div>
        <div class="settings-help">Exact PDF rendering using your current settings.</div>
        <div class="live-preview-wrap mb-3">
          <div class="live-preview-title">Live Invoice Preview</div>
          <iframe id="livePdfPreview" class="live-preview-frame" src="{{ url_for('settings_preview_pdf') }}" title="Live PDF Preview"></iframe>
        </div>
        <div>
          <label class="form-label compact-label req">PDF Layout Template</label>
          <div class="row g-3">
            {% for key, cfg in pdf_templates.items() %}
              <div class="col-md-6 col-xl-3">
                <label class="pdf-template-card">
                  <input class="pdf-template-radio" type="radio" name="pdf_template" value="{{ key }}" {% if (u.pdf_template or 'classic') == key %}checked{% endif %} required>
                  <div class="pdf-template-body">
                    <div class="pdf-template-preview">
                      <img src="{{ url_for('static', filename=cfg.preview) }}" alt="{{ cfg.label }} preview">
                    </div>
                    <div class="pdf-template-title">{{ cfg.label }}</div>
                    <div class="pdf-template-desc">{{ cfg.desc }}</div>
                  </div>
                </label>
              </div>
            {% endfor %}
          </div>
          <div class="small-muted mt-2">Applies to all invoices and estimates downloaded after saving.</div>
        </div>
      </section>

      {% if pro_features_enabled %}
        <section class="settings-card span-2" id="section-payments">
          <div class="settings-card-head">
            <h5>Customer Payment Fee Rules (Pro)</h5>
          </div>
          <div class="settings-help">Used for customer portal card payments and payout calculations.</div>
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label compact-label">Convenience Fee (%)</label>
              <input type="text" class="form-control" name="payment_fee_percent" inputmode="decimal" value="{{ u.payment_fee_percent if u.payment_fee_percent is not none else '0' }}" placeholder="e.g. 3.00">
            </div>
            <div class="col-md-4">
              <label class="form-label compact-label">Convenience Fee (Fixed $)</label>
              <input type="text" class="form-control" name="payment_fee_fixed" inputmode="decimal" value="{{ u.payment_fee_fixed if u.payment_fee_fixed is not none else '0' }}" placeholder="e.g. 0.30">
            </div>
            <div class="col-md-4 d-flex align-items-end">
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="paymentFeeAutoEnabled" name="payment_fee_auto_enabled" value="1" {% if u.payment_fee_auto_enabled %}checked{% endif %}>
                <label class="form-check-label" for="paymentFeeAutoEnabled">Auto-calculate from Stripe fees</label>
              </div>
            </div>
          </div>
          <div id="stripeFeeSettingsWrap" class="mt-3">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label compact-label">Stripe Processing Fee (%)</label>
                <input type="text" class="form-control" name="stripe_fee_percent" inputmode="decimal" value="{{ u.stripe_fee_percent if u.stripe_fee_percent is not none else '2.9' }}" placeholder="e.g. 2.90">
              </div>
              <div class="col-md-6">
                <label class="form-label compact-label">Stripe Processing Fixed Fee ($)</label>
                <input type="text" class="form-control" name="stripe_fee_fixed" inputmode="decimal" value="{{ u.stripe_fee_fixed if u.stripe_fee_fixed is not none else '0.30' }}" placeholder="e.g. 0.30">
              </div>
            </div>
          </div>
        </section>
      {% endif %}

      <section class="settings-card" id="section-contact">
        <div class="settings-card-head">
          <h5>Business Information</h5>
        </div>
        <div class="settings-help">Shown on invoices and estimates.</div>
        <div class="mb-3">
          <label class="form-label compact-label">Business Name / Your Name</label>
          <input type="text" class="form-control" name="business_name" value="{{ u.business_name or '' }}" placeholder="e.g. Summit Auto Repair">
        </div>
        <div class="mb-3">
          <label class="form-label compact-label">Phone Number</label>
          <input type="text" class="form-control" name="phone" value="{{ u.phone or '' }}" placeholder="(406) 555-1234">
        </div>
        <div class="mb-0">
          <label class="form-label compact-label">Address</label>
          <textarea class="form-control" name="address" rows="3" placeholder="Street, City, State ZIP">{{ u.address or '' }}</textarea>
        </div>
      </section>

      <section class="settings-card" id="section-scheduler">
        <div class="settings-card-head">
          <h5>Scheduler Email Summaries</h5>
        </div>
        <div class="settings-help">Send recurring email summaries only when appointments exist in the selected window.</div>
        <div class="mb-3">
          <label class="form-label compact-label">Summary Frequency</label>
          <select class="form-select" name="schedule_summary_frequency">
            {% set freq = (u.schedule_summary_frequency or 'none') %}
            <option value="none" {% if freq == 'none' %}selected{% endif %}>None</option>
            <option value="day" {% if freq == 'day' %}selected{% endif %}>Day</option>
            <option value="week" {% if freq == 'week' %}selected{% endif %}>Week</option>
            <option value="month" {% if freq == 'month' %}selected{% endif %}>Month</option>
          </select>
        </div>
        <div class="mb-2">
          <label class="form-label compact-label">Summary Start Time (Local)</label>
          <input type="time" class="form-control" name="schedule_summary_time" value="{{ u.schedule_summary_time or '' }}">
        </div>
        <div class="small-muted" id="summaryTimezoneLabel"></div>
        <input type="hidden" name="schedule_summary_tz_offset_minutes" id="scheduleSummaryTzOffset" value="{{ u.schedule_summary_tz_offset_minutes or 0 }}">
      </section>

      <section class="settings-card span-2" id="section-logo">
        <div class="settings-card-head">
          <h5>Logo</h5>
        </div>
        <div class="settings-help">Recommended: transparent PNG around 600px wide.</div>
        <div class="row g-3 align-items-end">
          <div class="col-md-8">
            <label class="form-label compact-label">Logo (shown on invoices)</label>
            <input class="form-control" type="file" name="logo" accept=".png,.jpg,.jpeg">
          </div>
          {% if u.logo_path or u.logo_blob %}
            <div class="col-md-4">
              <div class="small-muted mb-1">Current logo:</div>
              {% if u.logo_blob %}
                <div class="mono small-muted">Stored in database (optimized image).</div>
              {% else %}
                <div class="mono small-muted">{{ u.logo_path }}</div>
              {% endif %}
              <div class="form-check mt-2">
                <input class="form-check-input" type="checkbox" value="1" id="remove_logo" name="remove_logo">
                <label class="form-check-label" for="remove_logo">Remove logo</label>
              </div>
            </div>
          {% endif %}
        </div>
      </section>

    </div>

    <div class="save-row">
      <button type="submit" class="btn btn-primary save-pill">Save Settings</button>
    </div>
  </form>

  {% if not is_employee_account %}
    <section class="settings-card mt-3" id="section-employees">
      <div class="settings-card-head">
        <h5>Employees</h5>
      </div>
      {% if employee_features_enabled %}
        <div class="settings-help">Invite and manage employee logins tied to your company account.</div>
        <form method="post" action="{{ url_for('employee_invite_send') }}" class="row g-2 align-items-end mb-3">
          <div class="col-md-8">
            <label class="form-label compact-label">Invite Employee by Email</label>
            <input class="form-control" type="email" name="employee_email" placeholder="employee@example.com" required>
          </div>
          <div class="col-md-4 d-grid">
            <button class="btn btn-outline-primary" type="submit">Send Invite</button>
          </div>
        </form>
        {% if employees and employees|length > 0 %}
          <div class="small-muted mb-1">Current Employees</div>
          <ul class="list-group">
            {% for e in employees %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>{{ e.username }} <span class="small-muted">({{ e.email or 'no email' }})</span></span>
                <div class="d-flex align-items-center gap-2">
                  <span class="badge text-bg-light border">Employee</span>
                  <form method="post" action="{{ url_for('employee_delete', employee_id=e.id) }}" onsubmit="return confirm('Delete this employee account? This removes their login permanently.');">
                    <button class="btn btn-outline-danger btn-sm" type="submit">Delete</button>
                  </form>
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="small-muted">No employees invited yet.</div>
        {% endif %}
      {% else %}
        <div class="small-muted">Employee accounts are available on the Pro plan. Upgrade in Billing to invite and manage employees.</div>
      {% endif %}
    </section>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
  const tzOffsetMinutes = -new Date().getTimezoneOffset();
  const tzInput = document.getElementById("scheduleSummaryTzOffset");
  if (tzInput) {
    tzInput.value = String(tzOffsetMinutes);
  }
  const label = document.getElementById("summaryTimezoneLabel");
  if (label) {
    const sign = tzOffsetMinutes >= 0 ? "+" : "-";
    const abs = Math.abs(tzOffsetMinutes);
    const hh = String(Math.floor(abs / 60)).padStart(2, "0");
    const mm = String(abs % 60).padStart(2, "0");
    label.textContent = `Local time (UTC${sign}${hh}:${mm}).`;
  }

  const templateSelect = document.getElementById("invoiceTemplateSelect");
  const customCard = document.getElementById("customProfessionCard");
  const paymentFeeAutoToggle = document.getElementById("paymentFeeAutoEnabled");
  const stripeFeeWrap = document.getElementById("stripeFeeSettingsWrap");
  function toggleCustomCard() {
    if (!templateSelect || !customCard) return;
    customCard.style.display = (templateSelect.value === "custom") ? "" : "none";
  }
  function toggleStripeFeeFields() {
    if (!paymentFeeAutoToggle || !stripeFeeWrap) return;
    stripeFeeWrap.style.display = paymentFeeAutoToggle.checked ? "" : "none";
  }
  if (templateSelect) {
    templateSelect.addEventListener("change", toggleCustomCard);
    toggleCustomCard();
  }
  if (paymentFeeAutoToggle) {
    paymentFeeAutoToggle.addEventListener("change", toggleStripeFeeFields);
    toggleStripeFeeFields();
  }

  function getInput(name) {
    return document.querySelector(`[name="${name}"]`);
  }

  function inputVal(name, fallback = "") {
    const el = getInput(name);
    return ((el && el.value) || "").trim() || fallback;
  }

  function checkboxVal(name, fallback = true) {
    const el = getInput(name);
    if (!el) return fallback;
    return !!el.checked;
  }

  function selectedPdfTemplate() {
    const checked = document.querySelector('input[name="pdf_template"]:checked');
    return (checked && checked.value) || "classic";
  }

  const livePdf = document.getElementById("livePdfPreview");
  let refreshTimer = null;
  function refreshPdfPreview() {
    if (!livePdf) return;
    const params = new URLSearchParams();
    params.set("invoice_template", (templateSelect && templateSelect.value) || "auto_repair");
    params.set("pdf_template", selectedPdfTemplate());
    params.set("custom_profession_name", inputVal("custom_profession_name"));
    params.set("custom_job_label", inputVal("custom_job_label"));
    params.set("custom_labor_title", inputVal("custom_labor_title"));
    params.set("custom_labor_desc_label", inputVal("custom_labor_desc_label"));
    params.set("custom_parts_title", inputVal("custom_parts_title"));
    params.set("custom_parts_name_label", inputVal("custom_parts_name_label"));
    params.set("custom_shop_supplies_label", inputVal("custom_shop_supplies_label"));
    params.set("custom_show_job", checkboxVal("custom_show_job", true) ? "1" : "0");
    params.set("custom_show_labor", checkboxVal("custom_show_labor", true) ? "1" : "0");
    params.set("custom_show_parts", checkboxVal("custom_show_parts", true) ? "1" : "0");
    params.set("custom_show_shop_supplies", checkboxVal("custom_show_shop_supplies", true) ? "1" : "0");
    params.set("_t", String(Date.now()));
    livePdf.src = `{{ url_for('settings_preview_pdf') }}?${params.toString()}`;
  }

  function schedulePreviewRefresh() {
    if (refreshTimer) clearTimeout(refreshTimer);
    refreshTimer = setTimeout(refreshPdfPreview, 300);
  }

  document.addEventListener("input", schedulePreviewRefresh);
  document.addEventListener("change", schedulePreviewRefresh);
  refreshPdfPreview();

  (function () {
    const phoneInput = document.querySelector('input[name="phone"]');
    if (!phoneInput) return;

    function formatPhone(value) {
      const digits = (value || "").replace(/\D/g, "").slice(0, 10);
      if (!digits) return "";
      let formatted = `(${digits.slice(0, Math.min(3, digits.length))}`;
      if (digits.length >= 4) {
        formatted += `) ${digits.slice(3, Math.min(6, digits.length))}`;
      }
      if (digits.length >= 7) {
        formatted += `-${digits.slice(6, 10)}`;
      }
      return formatted;
    }

    phoneInput.value = formatPhone(phoneInput.value);
    phoneInput.addEventListener("input", () => {
      phoneInput.value = formatPhone(phoneInput.value);
    });
  })();
</script>
{% endblock %}
