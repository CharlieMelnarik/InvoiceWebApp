{% extends "base.html" %}
{% set title = "Settings" %}

{% block content %}
<style>
  .live-preview-wrap {
    border: 1px solid #dbe3ee;
    border-radius: 14px;
    background: #f7f9fc;
    padding: 14px;
  }
  .live-preview-title {
    font-weight: 700;
    margin-bottom: 10px;
  }
  .live-preview-frame {
    width: 100%;
    height: 620px;
    border: 1px solid #cfd8e5;
    border-radius: 10px;
    background: #fff;
  }
</style>

<div class="page-header">
  <div>
    <h1 class="h3 fw-bold mb-1">Settings</h1>
    <div class="subtitle">Manage account, invoice defaults, and scheduler notifications.</div>
  </div>
  <div class="action-group">
    {% if not is_employee_account %}
      <a href="{{ url_for('billing') }}" class="btn btn-outline-primary">Billing</a>
    {% endif %}
    <a href="{{ url_for('invoices') }}" class="btn btn-outline-secondary">Back to Invoices</a>
  </div>
</div>

<div class="row justify-content-center">
  <div class="col-md-8 col-lg-6">

    <div class="card shadow-sm">
      <div class="card-body">

        <h4 class="card-title mb-3">Account & Invoice Settings</h4>

        <p class="text-muted small">
          Your email is used for login recovery. Business information appears at the top of your PDF invoices.
        </p>

        <!-- IMPORTANT: multipart for file upload -->
        <form method="post" enctype="multipart/form-data">

          <!-- Email (required) -->
          <div class="mb-3">
            <label class="form-label req">
              Email Address
            </label>
            <input
              type="email"
              class="form-control"
              name="email"
              value="{{ u.email or '' }}"
              required
            >
            <div class="small-muted mt-1">
              Used for password resets.
            </div>
          </div>

          <!-- Profession / Template -->
          <div class="mb-3">
            <label class="form-label req">Business Type / Profession</label>
            <select class="form-select" id="invoiceTemplateSelect" name="invoice_template" required>
              {% for key, cfg in templates.items() %}
                <option value="{{ key }}"
                  {% if (u.invoice_template or 'auto_repair') == key %}selected{% endif %}>
                  {{ cfg.label }}
                </option>
              {% endfor %}
            </select>
            <div class="small-muted mt-1">
              New invoices will use this style. Existing invoices keep the style they were created with.
            </div>
          </div>

          <div id="customProfessionCard" class="border rounded p-3 mb-3" style="display:none;">
            <div class="fw-semibold mb-2">Custom Profession Builder</div>
            <div class="small-muted mb-3">
              Create your own label set and control which sections appear on invoices/estimates.
            </div>

            <div class="mb-3">
              <label class="form-label">Custom Profession Name</label>
              <input class="form-control" name="custom_profession_name" value="{{ u.custom_profession_name or '' }}" placeholder="e.g. Window Tinting">
            </div>

            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Job Label</label>
                <input class="form-control" name="custom_job_label" value="{{ u.custom_job_label or '' }}" placeholder="e.g. Service Location">
              </div>
              <div class="col-md-6">
                <label class="form-label">Labor Section Title</label>
                <input class="form-control" name="custom_labor_title" value="{{ u.custom_labor_title or '' }}" placeholder="e.g. Services">
              </div>
              <div class="col-md-6">
                <label class="form-label">Labor Description Label</label>
                <input class="form-control" name="custom_labor_desc_label" value="{{ u.custom_labor_desc_label or '' }}" placeholder="e.g. Service Description">
              </div>
              <div class="col-md-6">
                <label class="form-label">Parts Section Title</label>
                <input class="form-control" name="custom_parts_title" value="{{ u.custom_parts_title or '' }}" placeholder="e.g. Materials">
              </div>
              <div class="col-md-6">
                <label class="form-label">Parts Item Label</label>
                <input class="form-control" name="custom_parts_name_label" value="{{ u.custom_parts_name_label or '' }}" placeholder="e.g. Material Name">
              </div>
              <div class="col-md-6">
                <label class="form-label">Additional Fees Label</label>
                <input class="form-control" name="custom_shop_supplies_label" value="{{ u.custom_shop_supplies_label or '' }}" placeholder="e.g. Travel Fee">
              </div>
            </div>

            <hr class="my-3" />
            <div class="fw-semibold mb-2">Show These Sections</div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="customShowJob" name="custom_show_job" value="1" {% if u.custom_show_job is not defined or u.custom_show_job %}checked{% endif %}>
              <label class="form-check-label" for="customShowJob">Job field on form and PDF</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="customShowLabor" name="custom_show_labor" value="1" {% if u.custom_show_labor is not defined or u.custom_show_labor %}checked{% endif %}>
              <label class="form-check-label" for="customShowLabor">Labor section</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="customShowParts" name="custom_show_parts" value="1" {% if u.custom_show_parts is not defined or u.custom_show_parts %}checked{% endif %}>
              <label class="form-check-label" for="customShowParts">Parts section</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="customShowFees" name="custom_show_shop_supplies" value="1" {% if u.custom_show_shop_supplies is not defined or u.custom_show_shop_supplies %}checked{% endif %}>
              <label class="form-check-label" for="customShowFees">Additional fees line (shop supplies)</label>
            </div>
          </div>

          <div class="live-preview-wrap mb-3">
            <div class="live-preview-title">Live Invoice Preview</div>
            <div class="small-muted mb-2">
              Exact PDF preview using the same renderer as your downloaded invoices.
            </div>
            <iframe id="livePdfPreview" class="live-preview-frame" src="{{ url_for('settings_preview_pdf') }}" title="Live PDF Preview"></iframe>
          </div>

          <!-- PDF Template -->
          <div class="mb-3">
            <label class="form-label req">PDF Layout Template</label>
            <div class="row g-3">
              {% for key, cfg in pdf_templates.items() %}
                <div class="col-md-6">
                  <label class="pdf-template-card">
                    <input
                      class="pdf-template-radio"
                      type="radio"
                      name="pdf_template"
                      value="{{ key }}"
                      {% if (u.pdf_template or 'classic') == key %}checked{% endif %}
                      required
                    >
                    <div class="pdf-template-body">
                      <div class="pdf-template-preview">
                        <img src="{{ url_for('static', filename=cfg.preview) }}" alt="{{ cfg.label }} preview">
                      </div>
                      <div class="pdf-template-title">{{ cfg.label }}</div>
                      <div class="pdf-template-desc">{{ cfg.desc }}</div>
                    </div>
                  </label>
                </div>
              {% endfor %}
            </div>
            <div class="small-muted mt-2">
              Applies to all invoices and estimates, new and existing, downloaded after this selection.
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Default Tax (%)</label>
            <input
              type="text"
              class="form-control"
              name="tax_rate"
              inputmode="decimal"
              value="{{ u.tax_rate if u.tax_rate is not none else '0' }}"
              placeholder="0.0"
            >
            <div class="small-muted mt-1">
              This tax rate is applied to invoices and estimates unless overridden.
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Default Hourly Rate</label>
            <input
              type="text"
              class="form-control"
              name="default_hourly_rate"
              inputmode="decimal"
              value="{{ u.default_hourly_rate if u.default_hourly_rate is not none else '0' }}"
              placeholder="0.00"
            >
            <div class="small-muted mt-1">
              This rate pre-fills new invoices and estimates.
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Default Parts Markup (%)</label>
            <input
              type="text"
              class="form-control"
              name="default_parts_markup"
              inputmode="decimal"
              value="{{ u.default_parts_markup if u.default_parts_markup is not none else '0' }}"
              placeholder="0.0"
            >
            <div class="small-muted mt-1">
              This markup pre-fills new invoices and estimates.
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Customer Payment Convenience Fee (%)</label>
            <input
              type="text"
              class="form-control"
              name="payment_fee_percent"
              inputmode="decimal"
              value="{{ u.payment_fee_percent if u.payment_fee_percent is not none else '0' }}"
              placeholder="e.g. 3.00"
            >
            <div class="small-muted mt-1">
              Added only when customer pays online through Stripe checkout.
            </div>
          </div>

          <div class="form-check mb-3">
            <input
              class="form-check-input"
              type="checkbox"
              id="paymentFeeAutoEnabled"
              name="payment_fee_auto_enabled"
              value="1"
              {% if u.payment_fee_auto_enabled %}checked{% endif %}
            >
            <label class="form-check-label" for="paymentFeeAutoEnabled">
              Auto-calculate convenience fee from Stripe fee settings
            </label>
            <div class="small-muted mt-1">
              Calculates fee so online payment approximately covers Stripe processing fees for each invoice amount.
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Customer Payment Convenience Fee (Fixed $)</label>
            <input
              type="text"
              class="form-control"
              name="payment_fee_fixed"
              inputmode="decimal"
              value="{{ u.payment_fee_fixed if u.payment_fee_fixed is not none else '0' }}"
              placeholder="e.g. 0.30"
            >
            <div class="small-muted mt-1">
              Fixed fee added to online customer checkout total.
            </div>
          </div>

          <div id="stripeFeeSettingsWrap">
            <div class="mb-3">
              <label class="form-label">Stripe Processing Fee (%)</label>
              <input
                type="text"
                class="form-control"
                name="stripe_fee_percent"
                inputmode="decimal"
                value="{{ u.stripe_fee_percent if u.stripe_fee_percent is not none else '2.9' }}"
                placeholder="e.g. 2.90"
              >
            </div>

            <div class="mb-3">
              <label class="form-label">Stripe Processing Fixed Fee ($)</label>
              <input
                type="text"
                class="form-control"
                name="stripe_fee_fixed"
                inputmode="decimal"
                value="{{ u.stripe_fee_fixed if u.stripe_fee_fixed is not none else '0.30' }}"
                placeholder="e.g. 0.30"
              >
              <div class="small-muted mt-1">
                Used only when auto-calculate is enabled.
              </div>
            </div>
          </div>

          <div class="border rounded p-3 mb-3" id="paymentPreviewCard">
            <div class="fw-semibold mb-2">Example Payout Preview</div>
            <div class="row g-3 align-items-end">
              <div class="col-md-8">
                <label class="form-label">Use Existing Invoice/Estimate Total</label>
                <select class="form-select" id="paymentPreviewDocSelect">
                  <option value="">Select invoice/estimate (optional)</option>
                  {% for d in docs_for_preview|default([]) %}
                    <option value="{{ "%.2f"|format(d.total) }}">
                      {% if d.is_estimate %}Estimate{% else %}Invoice{% endif %}
                      {{ d.number }}{% if d.customer_name %} · {{ d.customer_name }}{% endif %}{% if d.date_in %} · {{ d.date_in }}{% endif %}
                      · ${{ "%.2f"|format(d.total) }}
                    </option>
                  {% endfor %}
                </select>
                <div class="small-muted mt-1">
                  Selecting a document fills the example amount below.
                </div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Example Invoice Amount ($)</label>
                <input
                  type="text"
                  class="form-control"
                  id="paymentPreviewBaseAmount"
                  inputmode="decimal"
                  value="100.00"
                >
              </div>
              <div class="col-md-8">
                <div class="small-muted mb-1" id="paymentPreviewModeLabel"></div>
                <div class="small-muted mb-1" id="paymentPreviewConvenienceFee"></div>
                <div class="small-muted mb-1" id="paymentPreviewCustomerTotal"></div>
                <div class="small-muted mb-1" id="paymentPreviewStripeFee"></div>
                <div class="small-muted fw-semibold" id="paymentPreviewNetPayout"></div>
              </div>
            </div>
          </div>

          <hr class="my-4" />

          <!-- Business Name -->
          <div class="mb-3">
            <label class="form-label">
              Business Name / Your Name
            </label>
            <input
              type="text"
              class="form-control"
              name="business_name"
              value="{{ u.business_name or '' }}"
              placeholder="e.g. Summit Auto Repair"
            >
          </div>

          <!-- Phone -->
          <div class="mb-3">
            <label class="form-label">
              Phone Number
            </label>
            <input
              type="text"
              class="form-control"
              name="phone"
              value="{{ u.phone or '' }}"
              placeholder="(406) 555-1234"
            >
          </div>

          <!-- Address -->
          <div class="mb-3">
            <label class="form-label">
              Address
            </label>
            <textarea
              class="form-control"
              name="address"
              rows="3"
              placeholder="Street, City, State ZIP"
            >{{ u.address or '' }}</textarea>
          </div>

          <hr class="my-4" />

          <div class="mb-3">
            <h6 class="mb-2">Scheduler Email Summaries</h6>
            <div class="small-muted">
              Choose how often to receive an email with upcoming appointments. Emails only send when there are
              scheduled appointments in the selected window.
            </div>
          </div>

          <div class="row g-3 align-items-end mb-3">
            <div class="col-md-6">
              <label class="form-label">Summary Frequency</label>
              <select class="form-select" name="schedule_summary_frequency">
                {% set freq = (u.schedule_summary_frequency or 'none') %}
                <option value="none" {% if freq == 'none' %}selected{% endif %}>None</option>
                <option value="day" {% if freq == 'day' %}selected{% endif %}>Day</option>
                <option value="week" {% if freq == 'week' %}selected{% endif %}>Week</option>
                <option value="month" {% if freq == 'month' %}selected{% endif %}>Month</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Summary Start Time (Local)</label>
              <input
                type="time"
                class="form-control"
                name="schedule_summary_time"
                value="{{ u.schedule_summary_time or '' }}"
              >
              <div class="small-muted mt-1">
                Appointments within the next day/week/month starting at this time are included.
              </div>
              <div class="small-muted mt-1" id="summaryTimezoneLabel"></div>
            </div>
          </div>
          <input
            type="hidden"
            name="schedule_summary_tz_offset_minutes"
            id="scheduleSummaryTzOffset"
            value="{{ u.schedule_summary_tz_offset_minutes or 0 }}"
          >
          <hr class="my-4" />

          <!-- Logo Upload -->
          <div class="mb-3">
            <label class="form-label">
              Logo (shown on invoices)
            </label>
            <input
              class="form-control"
              type="file"
              name="logo"
              accept=".png,.jpg,.jpeg"
            >

            <div class="small-muted mt-1">
              Recommended: transparent PNG, about 600px wide. It will be scaled down on the invoice.
            </div>

            {% if u.logo_path or u.logo_blob %}
              <div class="mt-2">
                <div class="small-muted">Current logo:</div>
                {% if u.logo_blob %}
                  <div class="mono">Stored in database (optimized image).</div>
                {% else %}
                  <div class="mono">{{ u.logo_path }}</div>
                {% endif %}
              </div>

              <div class="form-check mt-2">
                <input
                  class="form-check-input"
                  type="checkbox"
                  value="1"
                  id="remove_logo"
                  name="remove_logo"
                >
                <label class="form-check-label" for="remove_logo">
                  Remove logo
                </label>
              </div>
            {% endif %}
          </div>

          <div class="d-flex justify-content-between align-items-center mt-4">
            <button type="submit" class="btn btn-primary">
              Save Settings
            </button>
          </div>

        </form>

        <hr class="my-4" />
        <h5 class="mb-3">Employees</h5>
        {% if employee_features_enabled %}
          <form method="post" action="{{ url_for('employee_invite_send') }}" class="row g-2 align-items-end mb-3">
            <div class="col-md-8">
              <label class="form-label">Invite Employee by Email</label>
              <input class="form-control" type="email" name="employee_email" placeholder="employee@example.com" required>
            </div>
            <div class="col-md-4 d-grid">
              <button class="btn btn-outline-primary" type="submit">Send Invite</button>
            </div>
          </form>
          {% if employees and employees|length > 0 %}
            <div class="small-muted mb-1">Current Employees</div>
            <ul class="list-group">
              {% for e in employees %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <span>{{ e.username }} <span class="small-muted">({{ e.email or 'no email' }})</span></span>
                  <div class="d-flex align-items-center gap-2">
                    <span class="badge text-bg-light border">Employee</span>
                    <form method="post" action="{{ url_for('employee_delete', employee_id=e.id) }}" onsubmit="return confirm('Delete this employee account? This removes their login permanently.');">
                      <button class="btn btn-outline-danger btn-sm" type="submit">Delete</button>
                    </form>
                  </div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="small-muted">No employees invited yet.</div>
          {% endif %}
        {% else %}
          <div class="small-muted">
            Employee accounts are available on the Pro plan. Upgrade in Billing to invite and manage employees.
          </div>
        {% endif %}

      </div>
    </div>

  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  const tzOffsetMinutes = -new Date().getTimezoneOffset();
  const tzInput = document.getElementById("scheduleSummaryTzOffset");
  if (tzInput) {
    tzInput.value = String(tzOffsetMinutes);
  }
  const label = document.getElementById("summaryTimezoneLabel");
  if (label) {
    const sign = tzOffsetMinutes >= 0 ? "+" : "-";
    const abs = Math.abs(tzOffsetMinutes);
    const hh = String(Math.floor(abs / 60)).padStart(2, "0");
    const mm = String(abs % 60).padStart(2, "0");
    label.textContent = `Local time (UTC${sign}${hh}:${mm}).`;
  }

  const templateSelect = document.getElementById("invoiceTemplateSelect");
  const customCard = document.getElementById("customProfessionCard");
  const paymentFeeAutoToggle = document.getElementById("paymentFeeAutoEnabled");
  const stripeFeeWrap = document.getElementById("stripeFeeSettingsWrap");
  function toggleCustomCard() {
    if (!templateSelect || !customCard) return;
    customCard.style.display = (templateSelect.value === "custom") ? "" : "none";
  }
  function toggleStripeFeeFields() {
    if (!paymentFeeAutoToggle || !stripeFeeWrap) return;
    stripeFeeWrap.style.display = paymentFeeAutoToggle.checked ? "" : "none";
  }
  if (templateSelect) {
    templateSelect.addEventListener("change", toggleCustomCard);
    toggleCustomCard();
  }
  if (paymentFeeAutoToggle) {
    paymentFeeAutoToggle.addEventListener("change", toggleStripeFeeFields);
    toggleStripeFeeFields();
  }

  function getInput(name) {
    return document.querySelector(`[name="${name}"]`);
  }

  function parseMoneyInput(value, fallback = 0) {
    const raw = String(value || "").replace(/[$,\s]/g, "");
    const n = parseFloat(raw);
    return Number.isFinite(n) ? n : fallback;
  }

  function round2(value) {
    return Math.round((Number(value) || 0) * 100) / 100;
  }

  function ceil2(value) {
    return Math.ceil((Number(value) || 0) * 100) / 100;
  }

  function fmtMoney(value) {
    return `$${round2(value).toFixed(2)}`;
  }

  const paymentPreviewBaseInput = document.getElementById("paymentPreviewBaseAmount");
  const paymentPreviewDocSelect = document.getElementById("paymentPreviewDocSelect");
  const paymentPreviewModeLabel = document.getElementById("paymentPreviewModeLabel");
  const paymentPreviewConvenienceFee = document.getElementById("paymentPreviewConvenienceFee");
  const paymentPreviewCustomerTotal = document.getElementById("paymentPreviewCustomerTotal");
  const paymentPreviewStripeFee = document.getElementById("paymentPreviewStripeFee");
  const paymentPreviewNetPayout = document.getElementById("paymentPreviewNetPayout");

  function updatePaymentPreview() {
    if (!paymentPreviewBaseInput) return;

    const base = Math.max(0, parseMoneyInput(paymentPreviewBaseInput.value, 100));
    const autoEnabled = !!(paymentFeeAutoToggle && paymentFeeAutoToggle.checked);
    const manualPct = Math.max(0, parseMoneyInput(inputVal("payment_fee_percent", "0"), 0));
    const manualFixed = Math.max(0, parseMoneyInput(inputVal("payment_fee_fixed", "0"), 0));
    const stripePct = Math.max(0, parseMoneyInput(inputVal("stripe_fee_percent", "2.9"), 2.9));
    const stripeFixed = Math.max(0, parseMoneyInput(inputVal("stripe_fee_fixed", "0.30"), 0.30));

    let convenienceFee = 0;
    if (autoEnabled) {
      const rate = stripePct / 100;
      if (rate < 0.99) {
        const gross = (base + stripeFixed) / (1 - rate);
        convenienceFee = Math.max(0, ceil2(gross - base));
      }
    } else {
      convenienceFee = Math.max(0, round2(base * (manualPct / 100) + manualFixed));
    }

    const customerTotal = round2(base + convenienceFee);
    const stripeFeeEstimate = round2(customerTotal * (stripePct / 100) + stripeFixed);
    const netPayout = round2(customerTotal - stripeFeeEstimate);

    if (paymentPreviewModeLabel) {
      paymentPreviewModeLabel.textContent = autoEnabled
        ? `Mode: Auto (Stripe ${stripePct.toFixed(2)}% + ${fmtMoney(stripeFixed)})`
        : `Mode: Manual (${manualPct.toFixed(2)}% + ${fmtMoney(manualFixed)})`;
    }
    if (paymentPreviewConvenienceFee) {
      paymentPreviewConvenienceFee.textContent = `Convenience fee added: ${fmtMoney(convenienceFee)}`;
    }
    if (paymentPreviewCustomerTotal) {
      paymentPreviewCustomerTotal.textContent = `Customer checkout total: ${fmtMoney(customerTotal)}`;
    }
    if (paymentPreviewStripeFee) {
      paymentPreviewStripeFee.textContent = `Estimated Stripe fee: ${fmtMoney(stripeFeeEstimate)}`;
    }
    if (paymentPreviewNetPayout) {
      paymentPreviewNetPayout.textContent = `Estimated net payout: ${fmtMoney(netPayout)}`;
    }
  }

  if (paymentPreviewDocSelect && paymentPreviewBaseInput) {
    paymentPreviewDocSelect.addEventListener("change", () => {
      const selected = (paymentPreviewDocSelect.value || "").trim();
      if (selected) {
        paymentPreviewBaseInput.value = selected;
      }
      updatePaymentPreview();
    });
  }

  function inputVal(name, fallback = "") {
    const el = getInput(name);
    return ((el && el.value) || "").trim() || fallback;
  }

  function checkboxVal(name, fallback = true) {
    const el = getInput(name);
    if (!el) return fallback;
    return !!el.checked;
  }

  function selectedPdfTemplate() {
    const checked = document.querySelector('input[name="pdf_template"]:checked');
    return (checked && checked.value) || "classic";
  }

  const livePdf = document.getElementById("livePdfPreview");
  let refreshTimer = null;
  function refreshPdfPreview() {
    if (!livePdf) return;
    const params = new URLSearchParams();
    params.set("invoice_template", (templateSelect && templateSelect.value) || "auto_repair");
    params.set("pdf_template", selectedPdfTemplate());
    params.set("custom_profession_name", inputVal("custom_profession_name"));
    params.set("custom_job_label", inputVal("custom_job_label"));
    params.set("custom_labor_title", inputVal("custom_labor_title"));
    params.set("custom_labor_desc_label", inputVal("custom_labor_desc_label"));
    params.set("custom_parts_title", inputVal("custom_parts_title"));
    params.set("custom_parts_name_label", inputVal("custom_parts_name_label"));
    params.set("custom_shop_supplies_label", inputVal("custom_shop_supplies_label"));
    params.set("custom_show_job", checkboxVal("custom_show_job", true) ? "1" : "0");
    params.set("custom_show_labor", checkboxVal("custom_show_labor", true) ? "1" : "0");
    params.set("custom_show_parts", checkboxVal("custom_show_parts", true) ? "1" : "0");
    params.set("custom_show_shop_supplies", checkboxVal("custom_show_shop_supplies", true) ? "1" : "0");
    params.set("_t", String(Date.now()));
    livePdf.src = `{{ url_for('settings_preview_pdf') }}?${params.toString()}`;
  }

  function schedulePreviewRefresh() {
    if (refreshTimer) clearTimeout(refreshTimer);
    refreshTimer = setTimeout(refreshPdfPreview, 300);
    updatePaymentPreview();
  }

  document.addEventListener("input", schedulePreviewRefresh);
  document.addEventListener("change", schedulePreviewRefresh);
  refreshPdfPreview();
  updatePaymentPreview();

  (function () {
    const phoneInput = document.querySelector('input[name="phone"]');
    if (!phoneInput) return;

    function formatPhone(value) {
      const digits = (value || "").replace(/\D/g, "").slice(0, 10);
      if (!digits) return "";
      let formatted = `(${digits.slice(0, Math.min(3, digits.length))}`;
      if (digits.length >= 4) {
        formatted += `) ${digits.slice(3, Math.min(6, digits.length))}`;
      }
      if (digits.length >= 7) {
        formatted += `-${digits.slice(6, 10)}`;
      }
      return formatted;
    }

    phoneInput.value = formatPhone(phoneInput.value);
    phoneInput.addEventListener("input", () => {
      phoneInput.value = formatPhone(phoneInput.value);
    });
  })();
</script>
{% endblock %}
