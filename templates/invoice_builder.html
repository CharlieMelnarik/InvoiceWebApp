{% extends "base.html" %}
{% set title = "Invoice Builder" %}

{% block content %}
<style>
  .builder-shell { max-width: 1380px; margin: 0 auto; }
  .builder-layout { display: grid; grid-template-columns: 300px 1fr 280px; gap: 14px; }
  .builder-panel {
    border: 1px solid #b6cae8;
    border-radius: 14px;
    background: linear-gradient(180deg, #ffffff 0%, #edf4ff 100%);
    box-shadow: 0 10px 26px rgba(12, 34, 73, 0.12);
    padding: 12px;
  }
  .builder-panel h5 { margin: 0 0 8px; color: #123a71; font-weight: 800; }
  .builder-canvas-wrap {
    border: 1px solid #a7bfdf;
    border-radius: 14px;
    padding: 10px;
    background: linear-gradient(180deg, #d8e4f7 0%, #cad8ee 100%);
    overflow: auto;
  }
  .builder-canvas {
    position: relative;
    width: 816px;
    height: 1056px;
    margin: 0 auto;
    background: #fff;
    border: 1px solid #a9bedd;
    box-shadow: 0 12px 30px rgba(15, 23, 42, 0.2);
  }
  .canvas-guide {
    position: absolute;
    inset: 16px;
    border: 1px dashed rgba(30, 99, 198, 0.22);
    pointer-events: none;
  }
  .node {
    position: absolute;
    cursor: move;
    user-select: none;
    border: 1px dashed transparent;
    overflow: hidden;
    white-space: pre-wrap;
  }
  .node.selected { border-color: #1e63c6; background: rgba(30, 99, 198, 0.06); }
  .node.box { background: #fff; }
  .node .resize {
    position: absolute;
    width: 10px;
    height: 10px;
    right: 0;
    bottom: 0;
    cursor: nwse-resize;
    background: #1e63c6;
  }
  .tool-btn { width: 100%; margin-bottom: 6px; text-align: left; }
  .tool-group-title {
    font-size: 0.8rem;
    font-weight: 800;
    letter-spacing: 0.03em;
    color: #2a4d7f;
    margin: 8px 0 6px;
    text-transform: uppercase;
  }
  .helper-callout {
    border: 1px solid #b9cdea;
    border-radius: 10px;
    background: #f5f9ff;
    padding: 8px;
    font-size: 0.85rem;
    color: #395a88;
    margin-bottom: 8px;
  }
  .token-list {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }
  .token-btn {
    border: 1px solid #b9cdea;
    border-radius: 999px;
    background: #f6f9ff;
    padding: 2px 8px;
    font-size: 0.77rem;
    color: #1f4f94;
    cursor: pointer;
  }
  .token-btn:hover { background: #e7f0ff; }
  .template-list { max-height: 280px; overflow: auto; }
  .template-row {
    border: 1px solid #bdd0ea;
    border-radius: 10px;
    padding: 8px;
    background: #fff;
    margin-bottom: 8px;
  }
  .template-row.active { border-color: #1f58ab; box-shadow: 0 0 0 2px rgba(31, 88, 171, 0.15); }
  @media (max-width: 1200px) { .builder-layout { grid-template-columns: 1fr; } }
</style>

<div class="builder-shell">
  <div class="page-header">
    <div>
      <h1 class="h3 fw-bold mb-1">Invoice Builder</h1>
      <div class="subtitle">Drag, resize, and style invoice elements. Save unlimited templates and set one active.</div>
    </div>
    <div class="action-group">
      <a class="btn btn-outline-secondary" href="{{ url_for('settings') }}">Back to Settings</a>
      <button id="saveActiveBtn" class="btn btn-primary" type="button">Save Active Template</button>
      <span id="saveStatus" class="badge text-bg-light border align-self-center"></span>
    </div>
  </div>

  <div class="builder-layout">
    <section class="builder-panel">
      <h5>Easy Builder</h5>
      <div class="helper-callout">
        1) Pick a quick-start layout<br>
        2) Add sections you want<br>
        3) Drag sections where you want them<br>
        4) Save template
      </div>
      <div class="tool-group-title">Quick Start</div>
      <button class="btn btn-primary tool-btn" data-quick="pdf_like">Use PDF-Like Starter (Recommended)</button>
      <button class="btn btn-outline-primary tool-btn" data-quick="standard">Use Standard Starter</button>
      <button class="btn btn-outline-primary tool-btn" data-quick="minimal">Use Minimal Starter</button>
      <button class="btn btn-outline-primary tool-btn" data-quick="service">Use Service Starter</button>
      <div class="tool-group-title">Add Sections</div>
      <button class="btn btn-outline-primary tool-btn" data-add="header">+ Header (Title + Date + Number)</button>
      <button class="btn btn-outline-primary tool-btn" data-add="business">+ Business Details Section</button>
      <button class="btn btn-outline-primary tool-btn" data-add="bill">+ Bill To Section</button>
      <button class="btn btn-outline-primary tool-btn" data-add="job">+ Job Details Section</button>
      <button class="btn btn-outline-primary tool-btn" data-add="labor">+ Labor Section</button>
      <button class="btn btn-outline-primary tool-btn" data-add="parts">+ Parts Section</button>
      <button class="btn btn-outline-primary tool-btn" data-add="notes">+ Notes Section</button>
      <button class="btn btn-outline-primary tool-btn" data-add="summary">+ Summary Section</button>
      <button class="btn btn-outline-secondary tool-btn" data-add="text">+ Free Text</button>
      <button class="btn btn-outline-secondary tool-btn" data-add="box">+ Empty Box</button>
      <hr>
      <label class="form-label compact-label">Canvas Background</label>
      <input id="canvasBg" class="form-control form-control-color" type="color" value="#ffffff">
      <div class="form-check mt-2">
        <input class="form-check-input" type="checkbox" id="showSampleData" checked>
        <label class="form-check-label" for="showSampleData">Show sample data in builder preview</label>
      </div>
      <div class="small text-muted mt-2">Tip: click a section, then edit text on the right. Drag to move. Pull corner to resize.</div>
    </section>

    <section class="builder-canvas-wrap">
      <div id="canvas" class="builder-canvas">
        <div class="canvas-guide"></div>
      </div>
    </section>

    <section class="builder-panel">
      <h5>Properties</h5>
      <div class="mb-2">
        <label class="form-label compact-label">Template Name</label>
        <input id="templateName" class="form-control" type="text" placeholder="My Custom Layout">
      </div>
      <div class="d-grid gap-2 mb-3">
        <button id="saveAsNewBtn" class="btn btn-outline-primary" type="button">Save As New Template</button>
        <button id="setActiveBtn" class="btn btn-outline-success" type="button">Set Selected Active</button>
      </div>
      <hr>
      <div id="propEditor">
        <div class="small text-muted">Select an element to edit.</div>
      </div>
      <hr>
      <h5>Templates</h5>
      <div id="templateList" class="template-list"></div>
    </section>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(() => {
  const saveUrl = "{{ url_for('api_invoice_builder_save') }}";
  const activateBase = "/api/invoice-builder/template/";
  const templates = {{ templates_payload|tojson }};
  let currentTemplateId = {{ active_template_id|tojson }};

  const canvas = document.getElementById("canvas");
  const canvasBg = document.getElementById("canvasBg");
  const templateName = document.getElementById("templateName");
  const templateList = document.getElementById("templateList");
  const propEditor = document.getElementById("propEditor");
  const saveAsNewBtn = document.getElementById("saveAsNewBtn");
  const saveActiveBtn = document.getElementById("saveActiveBtn");
  const setActiveBtn = document.getElementById("setActiveBtn");
  const saveStatus = document.getElementById("saveStatus");
  const showSampleData = document.getElementById("showSampleData");

  let state = { canvas: { width: 816, height: 1056, bg: "#ffffff" }, elements: [] };
  let selectedId = null;
  let drag = null;
  const SNAP = 4;
  const TOKENS = [
    "doc_label","invoice_number","date","due_date","business_name","business_phone","business_address",
    "customer_name","customer_email","customer_phone","job","rate","hours",
    "labor_lines","parts_lines","notes_text","labor_table","parts_table",
    "parts_total","labor_total","tax","total","paid","amount_due"
  ];
  const tok = (name) => "{" + "{" + name + "}" + "}";
  function setStatus(msg, kind = "info") {
    if (!saveStatus) return;
    saveStatus.textContent = msg || "";
    saveStatus.className = "badge border align-self-center";
    if (kind === "ok") {
      saveStatus.classList.add("text-bg-success");
    } else if (kind === "error") {
      saveStatus.classList.add("text-bg-danger");
    } else {
      saveStatus.classList.add("text-bg-light");
    }
  }
  const SAMPLE_VALUES = {
    doc_label: "INVOICE",
    invoice_number: "2026-0001",
    date: "February 18, 2026",
    due_date: "March 20, 2026",
    business_name: "Summit Auto Repair",
    business_phone: "(406) 555-0147",
    business_address: "123 Work St\nSomewhere, MT 59840",
    customer_name: "John Sample",
    customer_email: "john.sample@email.com",
    customer_phone: "(406) 555-1234",
    job: "2018 Ford F-150",
    rate: "$100.00",
    hours: "2.5",
    labor_lines: "Oil change service - 1.0 hr - $100.00\nBrake inspection - 1.5 hr - $150.00",
    parts_lines: "Oil Filter - $18.99\nEngine Oil - $37.95\nAir Filter - $27.99",
    notes_text: "Thank you for your business.\nRecommended: tire rotation in 5,000 miles.",
    labor_table: "Service Description            Time        Line Total\nSample labor item             1.5 hrs     $150.00",
    parts_table: "Part / Material                Price\nSample part                   $18.99",
    parts_total: "$182.00",
    labor_total: "$250.00",
    tax: "$34.56",
    total: "$466.56",
    paid: "$100.00",
    amount_due: "$366.56",
  };

  function activeTemplate() {
    return templates.find(t => Number(t.id) === Number(currentTemplateId)) || templates[0];
  }

  function nodeById(id) {
    return state.elements.find(e => String(e.id) === String(id));
  }

  function normalizeDesign(design) {
    const safe = JSON.parse(JSON.stringify(design || { canvas: { width: 816, height: 1056, bg: "#fff" }, elements: [] }));
    if (!safe.canvas) safe.canvas = { width: 816, height: 1056, bg: "#fff" };
    if (!Array.isArray(safe.elements)) safe.elements = [];
    safe.elements = safe.elements.map((el) => {
      if (!el || typeof el !== "object") return el;
      const copy = { ...el };
      if (typeof copy.text === "string") {
        let txt = copy.text;
        for (let i = 0; i < 5; i += 1) {
          if (!txt.includes("\\n")) break;
          txt = txt.replace(/\\n/g, "\n");
        }
        copy.text = txt;
      }
      if (typeof copy.richText === "string") {
        let rich = copy.richText;
        for (let i = 0; i < 5; i += 1) {
          if (!rich.includes("\\n")) break;
          rich = rich.replace(/\\n/g, "\n");
        }
        copy.richText = rich;
      }
      return copy;
    });
    return safe;
  }

  function escapeHtml(text) {
    return String(text || "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
  }

  function plainTextToHtml(text) {
    return escapeHtml(String(text || "").replace(/\\n/g, "\n")).replace(/\n/g, "<br>");
  }

  function richHtmlToPlain(html) {
    const tmp = document.createElement("div");
    tmp.innerHTML = String(html || "")
      .replace(/<\/?(div|p)[^>]*>/gi, "\n")
      .replace(/<br\s*\/?>/gi, "\n");
    return (tmp.textContent || tmp.innerText || "").replace(/\r/g, "");
  }

  function renderedNodeHtml(el) {
    const rawHtml = String(el.richText || plainTextToHtml(el.text || ""));
    if (!(showSampleData && showSampleData.checked)) return rawHtml;
    return rawHtml.replace(/\{\{\s*([a-z_]+)\s*\}\}/gi, (_m, key) => SAMPLE_VALUES[key] ?? tok(key));
  }

  function updateSelectedNodeText() {
    if (!selectedId) return;
    const el = nodeById(selectedId);
    if (!el || String(el.type || "text").toLowerCase() === "box") return;
    const node = canvas.querySelector(`.node[data-id="${CSS.escape(String(selectedId))}"]`);
    if (!node) return;
    const resize = node.querySelector(".resize");
    node.innerHTML = renderedNodeHtml(el);
    if (resize) node.appendChild(resize);
  }

  function insertTokenAtCaret(editor, token) {
    editor.focus();
    try {
      const ok = document.execCommand("insertText", false, token);
      if (ok) return;
    } catch (_e) {}
    const sel = window.getSelection();
    if (!sel || !sel.rangeCount) {
      editor.innerHTML += escapeHtml(token);
      return;
    }
    const range = sel.getRangeAt(0);
    range.deleteContents();
    range.insertNode(document.createTextNode(token));
    range.collapse(false);
    sel.removeAllRanges();
    sel.addRange(range);
  }

  function applyInlineSpanStyle(editor, styles) {
    const sel = window.getSelection();
    if (!sel || !sel.rangeCount) return false;
    const range = sel.getRangeAt(0);
    if (!editor.contains(range.commonAncestorContainer) || range.collapsed) return false;
    const span = document.createElement("span");
    Object.entries(styles || {}).forEach(([k, v]) => {
      if (v !== null && v !== undefined && String(v).trim() !== "") span.style[k] = String(v);
    });
    const frag = range.extractContents();
    span.appendChild(frag);
    range.insertNode(span);
    const newRange = document.createRange();
    newRange.selectNodeContents(span);
    newRange.collapse(false);
    sel.removeAllRanges();
    sel.addRange(newRange);
    return true;
  }

  function renderTemplateList() {
    templateList.innerHTML = "";
    templates.forEach(t => {
      const row = document.createElement("div");
      row.className = "template-row" + (Number(t.id) === Number(currentTemplateId) ? " active" : "");
      row.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
          <strong>${t.name}</strong>
          ${t.is_active ? '<span class="badge text-bg-success">Active</span>' : ""}
        </div>
        <div class="d-flex gap-1 mt-2">
          <button class="btn btn-outline-primary btn-sm" data-load="${t.id}">Load</button>
          <button class="btn btn-outline-success btn-sm" data-activate="${t.id}">Activate</button>
          <button class="btn btn-outline-danger btn-sm" data-delete="${t.id}">Delete</button>
        </div>
      `;
      templateList.appendChild(row);
    });
  }

  function renderCanvas() {
    canvas.style.background = state.canvas.bg || "#fff";
    canvas.innerHTML = '<div class="canvas-guide"></div>';
    state.elements.forEach(el => {
      const node = document.createElement("div");
      node.className = "node " + (el.type === "box" ? "box " : "") + (String(el.id) === String(selectedId) ? "selected" : "");
      node.dataset.id = String(el.id);
      node.style.left = `${el.x || 0}px`;
      node.style.top = `${el.y || 0}px`;
      node.style.width = `${Math.max(30, el.w || 80)}px`;
      node.style.height = `${Math.max(24, el.h || 30)}px`;
      node.style.color = el.color || "#111827";
      node.style.fontSize = `${el.fontSize || 14}px`;
      node.style.fontWeight = String(el.fontWeight || 500);
      const fontFamily = String(el.fontFamily || "Helvetica");
      node.style.fontFamily =
        fontFamily === "Times-Roman" ? "Georgia, 'Times New Roman', serif" :
        fontFamily === "Courier" ? "'Courier New', Courier, monospace" :
        "'Helvetica Neue', Helvetica, Arial, sans-serif";
      node.style.fontStyle = (String(el.fontStyle || "normal").toLowerCase() === "italic") ? "italic" : "normal";
      node.style.textAlign = String(el.textAlign || "left").toLowerCase();
      node.style.textDecoration = (el.underline ? "underline" : "none");
      node.style.borderColor = el.borderColor || "transparent";
      node.style.backgroundColor = el.fillColor || "transparent";
      node.style.borderRadius = `${el.radius || 0}px`;
      node.innerHTML = renderedNodeHtml(el);
      const resize = document.createElement("div");
      resize.className = "resize";
      node.appendChild(resize);
      canvas.appendChild(node);
      if (el.type !== "box" && (el.autoGrow || /\{\{\s*(labor_table|parts_table|labor_lines|parts_lines)\s*\}\}/i.test(String(el.text || "") + " " + String(el.richText || "")))) {
        const baseMin = Math.max(24, Number(el.minH || 30));
        node.style.height = "auto";
        const needed = Math.max(baseMin, Math.ceil(node.scrollHeight + 8));
        node.style.height = `${needed}px`;
        if (Number(el.h || 0) !== needed) el.h = needed;
      }
    });
    renderPropertyEditor();
  }

  function renderPropertyEditor() {
    const el = nodeById(selectedId);
    if (!el) {
      propEditor.innerHTML = '<div class="small text-muted">Select an element to edit.</div>';
      return;
    }
    if (el.type === "box") {
      propEditor.innerHTML = `
        <div class="mb-2 small text-muted">Box shape selected.</div>
        <div class="row g-2">
          <div class="col-6">
            <label class="form-label compact-label">Border Color</label>
            <input id="propBorder" class="form-control form-control-color" type="color" value="${(el.borderColor && el.borderColor.startsWith("#")) ? el.borderColor : "#111827"}">
          </div>
          <div class="col-6">
            <label class="form-label compact-label">Fill Color</label>
            <input id="propFill" class="form-control form-control-color" type="color" value="${(el.fillColor && el.fillColor.startsWith("#")) ? el.fillColor : "#ffffff"}">
          </div>
          <div class="col-6">
            <label class="form-label compact-label">Corner Radius</label>
            <input id="propRadius" class="form-control" type="number" min="0" max="40" value="${el.radius || 0}">
          </div>
        </div>
        <div class="d-grid gap-2 mt-2">
          <button id="duplicateBtn" class="btn btn-outline-primary btn-sm" type="button">Duplicate Element</button>
          <button id="removeBtn" class="btn btn-outline-danger btn-sm" type="button">Delete Element</button>
        </div>
      `;
      document.getElementById("propBorder").addEventListener("input", (e) => { el.borderColor = e.target.value; renderCanvas(); });
      document.getElementById("propFill").addEventListener("input", (e) => { el.fillColor = e.target.value; renderCanvas(); });
      document.getElementById("propRadius").addEventListener("input", (e) => { el.radius = Number(e.target.value || 0); renderCanvas(); });
    } else {
      const isBold = Number(el.fontWeight || 500) >= 600;
      const isItalic = String(el.fontStyle || "normal").toLowerCase() === "italic";
      const isUnderline = !!el.underline;
      const textAlign = String(el.textAlign || "left").toLowerCase();
      propEditor.innerHTML = `
        <div class="mb-2">
          <label class="form-label compact-label">Text</label>
          <div class="btn-toolbar mb-2 gap-2" role="toolbar" aria-label="Inline text style">
            <div class="btn-group btn-group-sm" role="group">
              <button id="inlineBold" type="button" class="btn btn-outline-secondary"><strong>B</strong></button>
              <button id="inlineItalic" type="button" class="btn btn-outline-secondary"><em>I</em></button>
              <button id="inlineUnderline" type="button" class="btn btn-outline-secondary"><span style="text-decoration: underline;">U</span></button>
            </div>
            <select id="inlineFontFamily" class="form-select form-select-sm" style="max-width: 220px;">
              <option value="Helvetica">Inline Sans (Helvetica)</option>
              <option value="Times-Roman">Inline Serif (Times)</option>
              <option value="Courier">Inline Mono (Courier)</option>
            </select>
            <select id="inlineFontSize" class="form-select form-select-sm" style="max-width: 140px;">
              <option value="">Inline Size</option>
              <option value="10">10 pt</option>
              <option value="12">12 pt</option>
              <option value="14">14 pt</option>
              <option value="16">16 pt</option>
              <option value="18">18 pt</option>
              <option value="20">20 pt</option>
              <option value="24">24 pt</option>
              <option value="28">28 pt</option>
              <option value="32">32 pt</option>
            </select>
          </div>
          <div id="propTextRich" class="form-control" contenteditable="true" style="min-height: 130px; white-space: pre-wrap; overflow: auto;"></div>
          <div class="small text-muted mt-1">Tip: highlight specific words and use the inline toolbar above for mixed formatting in one box.</div>
        </div>
        <div class="mb-2">
          <div class="small text-muted mb-1">Click to insert data fields:</div>
          <div class="token-list" id="tokenList"></div>
        </div>
        <div class="mb-2">
          <label class="form-label compact-label">Sample Preview</label>
          <div class="helper-callout" id="samplePreview"></div>
        </div>
        <div class="row g-2">
          <div class="col-6">
            <label class="form-label compact-label">Font Size</label>
            <input id="propFontSize" class="form-control" type="number" min="8" max="80" value="${el.fontSize || 14}">
          </div>
          <div class="col-6">
            <label class="form-label compact-label">Font Family</label>
            <select id="propFontFamily" class="form-select">
              <option value="Helvetica" ${String(el.fontFamily || "Helvetica") === "Helvetica" ? "selected" : ""}>Sans Serif (Helvetica)</option>
              <option value="Times-Roman" ${String(el.fontFamily || "Helvetica") === "Times-Roman" ? "selected" : ""}>Serif (Times)</option>
              <option value="Courier" ${String(el.fontFamily || "Helvetica") === "Courier" ? "selected" : ""}>Monospace (Courier)</option>
            </select>
          </div>
          <div class="col-6">
            <label class="form-label compact-label">Text Color</label>
            <input id="propColor" class="form-control form-control-color" type="color" value="${el.color || "#111827"}">
          </div>
          <div class="col-6">
            <label class="form-label compact-label">Style</label>
            <div class="btn-group w-100" role="group" aria-label="Text style controls">
              <button id="propBold" class="btn btn-sm ${isBold ? "btn-primary" : "btn-outline-primary"}" type="button"><strong>B</strong></button>
              <button id="propItalic" class="btn btn-sm ${isItalic ? "btn-primary" : "btn-outline-primary"}" type="button"><em>I</em></button>
              <button id="propUnderline" class="btn btn-sm ${isUnderline ? "btn-primary" : "btn-outline-primary"}" type="button"><span style="text-decoration: underline;">U</span></button>
            </div>
          </div>
          <div class="col-12">
            <label class="form-label compact-label">Alignment</label>
            <div class="btn-group w-100" role="group" aria-label="Text alignment">
              <button id="propAlignLeft" class="btn btn-sm ${textAlign === "left" ? "btn-primary" : "btn-outline-primary"}" type="button">Left</button>
              <button id="propAlignCenter" class="btn btn-sm ${textAlign === "center" ? "btn-primary" : "btn-outline-primary"}" type="button">Center</button>
              <button id="propAlignRight" class="btn btn-sm ${textAlign === "right" ? "btn-primary" : "btn-outline-primary"}" type="button">Right</button>
            </div>
          </div>
        </div>
        <div class="d-grid gap-2 mt-2">
          <button id="duplicateBtn" class="btn btn-outline-primary btn-sm" type="button">Duplicate Element</button>
          <button id="removeBtn" class="btn btn-outline-danger btn-sm" type="button">Delete Element</button>
        </div>
      `;
      const textEditor = document.getElementById("propTextRich");
      const samplePreview = document.getElementById("samplePreview");
      textEditor.innerHTML = String(el.richText || plainTextToHtml(el.text || ""));
      try { document.execCommand("styleWithCSS", false, false); } catch (_e) {}

      const syncEditorToElement = () => {
        el.richText = textEditor.innerHTML || "";
        el.text = richHtmlToPlain(el.richText);
      };
      const renderSamplePreview = () => {
        const raw = richHtmlToPlain(String(el.richText || plainTextToHtml(el.text || "")));
        samplePreview.textContent = raw.replace(/\{\{\s*([a-z_]+)\s*\}\}/gi, (_m, key) => SAMPLE_VALUES[key] ?? tok(key));
      };
      renderSamplePreview();
      textEditor.addEventListener("input", () => {
        syncEditorToElement();
        renderSamplePreview();
        updateSelectedNodeText();
      });
      textEditor.addEventListener("keyup", syncEditorToElement);
      textEditor.addEventListener("blur", syncEditorToElement);
      document.getElementById("propFontSize").addEventListener("input", (e) => { el.fontSize = Number(e.target.value || 14); renderCanvas(); });
      document.getElementById("propFontFamily").addEventListener("change", (e) => { el.fontFamily = e.target.value || "Helvetica"; renderCanvas(); });
      document.getElementById("propColor").addEventListener("input", (e) => { el.color = e.target.value; renderCanvas(); });
      document.getElementById("propBold").addEventListener("click", () => {
        const currentlyBold = Number(el.fontWeight || 500) >= 600;
        el.fontWeight = currentlyBold ? 500 : 700;
        renderCanvas();
      });
      document.getElementById("propItalic").addEventListener("click", () => {
        const currentlyItalic = String(el.fontStyle || "normal").toLowerCase() === "italic";
        el.fontStyle = currentlyItalic ? "normal" : "italic";
        renderCanvas();
      });
      document.getElementById("propUnderline").addEventListener("click", () => {
        el.underline = !el.underline;
        renderCanvas();
      });
      document.getElementById("propAlignLeft").addEventListener("click", () => {
        el.textAlign = "left";
        renderCanvas();
      });
      document.getElementById("propAlignCenter").addEventListener("click", () => {
        el.textAlign = "center";
        renderCanvas();
      });
      document.getElementById("propAlignRight").addEventListener("click", () => {
        el.textAlign = "right";
        renderCanvas();
      });
      const inlineFontFamily = document.getElementById("inlineFontFamily");
      const inlineFontSize = document.getElementById("inlineFontSize");
      document.getElementById("inlineBold").addEventListener("click", () => {
        textEditor.focus();
        document.execCommand("bold", false, null);
        syncEditorToElement();
        updateSelectedNodeText();
      });
      document.getElementById("inlineItalic").addEventListener("click", () => {
        textEditor.focus();
        document.execCommand("italic", false, null);
        syncEditorToElement();
        updateSelectedNodeText();
      });
      document.getElementById("inlineUnderline").addEventListener("click", () => {
        textEditor.focus();
        document.execCommand("underline", false, null);
        syncEditorToElement();
        updateSelectedNodeText();
      });
      inlineFontFamily.addEventListener("change", () => {
        textEditor.focus();
        document.execCommand("fontName", false, inlineFontFamily.value || "Helvetica");
        syncEditorToElement();
        updateSelectedNodeText();
      });
      inlineFontSize.addEventListener("change", () => {
        const sz = (inlineFontSize.value || "").trim();
        if (!sz) return;
        textEditor.focus();
        const ok = applyInlineSpanStyle(textEditor, { fontSize: `${sz}px` });
        if (!ok) return;
        syncEditorToElement();
        updateSelectedNodeText();
      });
      const tokenList = document.getElementById("tokenList");
      TOKENS.forEach((t) => {
        const b = document.createElement("button");
        b.type = "button";
        b.className = "token-btn";
        b.textContent = tok(t);
        b.addEventListener("click", () => {
          const token = tok(t);
          insertTokenAtCaret(textEditor, token);
          syncEditorToElement();
          renderSamplePreview();
          updateSelectedNodeText();
        });
        tokenList.appendChild(b);
      });
    }
    document.getElementById("duplicateBtn").addEventListener("click", () => {
      const copy = JSON.parse(JSON.stringify(el));
      copy.id = `el_${Date.now()}`;
      copy.x = (copy.x || 0) + 18;
      copy.y = (copy.y || 0) + 18;
      state.elements.push(copy);
      selectedId = copy.id;
      renderCanvas();
    });
    document.getElementById("removeBtn").addEventListener("click", () => {
      state.elements = state.elements.filter(x => String(x.id) !== String(el.id));
      selectedId = null;
      renderCanvas();
    });
  }

  function loadTemplate(id) {
    const t = templates.find(x => Number(x.id) === Number(id));
    if (!t) return;
    currentTemplateId = Number(t.id);
    templateName.value = t.name || "";
    state = normalizeDesign(t.design || { canvas: { width: 816, height: 1056, bg: "#fff" }, elements: [] });
    canvasBg.value = state.canvas.bg || "#ffffff";
    selectedId = null;
    renderTemplateList();
    renderCanvas();
  }

  function addPreset(type) {
    const createText = (opts = {}) => ({
      id: `el_${Date.now()}_${Math.random().toString(16).slice(2, 6)}`,
      type: "text",
      x: opts.x ?? 80,
      y: opts.y ?? 80,
      w: opts.w ?? 260,
      h: opts.h ?? 50,
      text: opts.text ?? "Text",
      fontSize: opts.fontSize ?? 16,
      fontWeight: opts.fontWeight ?? 600,
      fontFamily: opts.fontFamily ?? "Helvetica",
      fontStyle: opts.fontStyle ?? "normal",
      textAlign: opts.textAlign ?? "left",
      underline: !!opts.underline,
      autoGrow: !!opts.autoGrow,
      minH: opts.minH ?? (opts.h ?? 50),
      color: opts.color ?? "#111827",
      fillColor: "transparent",
      borderColor: "transparent",
      radius: 0,
    });
    const createBox = (opts = {}) => ({
      id: `el_${Date.now()}_${Math.random().toString(16).slice(2, 6)}`,
      type: "box",
      x: opts.x ?? 80,
      y: opts.y ?? 80,
      w: opts.w ?? 260,
      h: opts.h ?? 140,
      text: "",
      borderColor: opts.borderColor ?? "#111827",
      fillColor: opts.fillColor ?? "#ffffff",
      radius: opts.radius ?? 8,
    });
    const addSection = (x, y, w, h, text, textSize = 14) => {
      const box = createBox({ x, y, w, h, borderColor: "#111827", fillColor: "#ffffff", radius: 8 });
      const t = createText({ x: x + 12, y: y + 12, w: w - 24, h: h - 24, text, fontSize: textSize, fontWeight: 600 });
      state.elements.push(box, t);
      selectedId = t.id;
    };
    if (type === "text") {
      const t = createText();
      state.elements.push(t);
      selectedId = t.id;
    } else if (type === "box") {
      const b = createBox();
      state.elements.push(b);
      selectedId = b.id;
    } else if (type === "header") {
      const t1 = createText({ x: 48, y: 36, w: 280, h: 44, text: tok("doc_label"), fontSize: 40, fontWeight: 700 });
      const t2 = createText({
        x: 560,
        y: 44,
        w: 240,
        h: 62,
        text: `Invoice #: ${tok("invoice_number")}\nDate: ${tok("date")}\nDue: ${tok("due_date")}`,
        fontSize: 13,
        fontWeight: 500
      });
      state.elements.push(t1, t2);
      selectedId = t1.id;
    } else if (type === "business") {
      addSection(320, 36, 220, 76, `${tok("business_name")}\n${tok("business_address")}\n${tok("business_phone")}`, 11);
    } else if (type === "bill") {
      addSection(48, 118, 350, 150, `BILL TO\n${tok("customer_name")}\nEmail: ${tok("customer_email")}\nPhone: ${tok("customer_phone")}`, 14);
    } else if (type === "job") {
      addSection(418, 118, 350, 150, `JOB DETAILS\nJob: ${tok("job")}\nRate/Hour: ${tok("rate")}\nTotal Hours: ${tok("hours")}`, 14);
    } else if (type === "labor") {
      const box = createBox({ x: 48, y: 300, w: 720, h: 140, borderColor: "#111827", fillColor: "#ffffff", radius: 8 });
      const t = createText({ x: 62, y: 314, w: 692, h: 112, minH: 112, text: `${tok("labor_table")}`, fontSize: 12, fontWeight: 500, autoGrow: true });
      state.elements.push(box, t);
      selectedId = t.id;
    } else if (type === "parts") {
      const box = createBox({ x: 48, y: 450, w: 720, h: 150, borderColor: "#111827", fillColor: "#ffffff", radius: 8 });
      const t = createText({ x: 62, y: 464, w: 692, h: 122, minH: 122, text: `${tok("parts_table")}`, fontSize: 12, fontWeight: 500, autoGrow: true });
      state.elements.push(box, t);
      selectedId = t.id;
    } else if (type === "notes") {
      addSection(48, 780, 430, 160, `NOTES\n${tok("notes_text")}`, 13);
    } else if (type === "summary") {
      addSection(
        500,
        780,
        268,
        180,
        `SUMMARY\nLabor: ${tok("labor_total")}\nParts: ${tok("parts_total")}\nTax: ${tok("tax")}\nTotal: ${tok("total")}\nAmount Due: ${tok("amount_due")}`,
        14
      );
    }
    renderCanvas();
  }

  function quickStart(kind) {
    const base = { canvas: { width: 816, height: 1056, bg: "#ffffff" }, elements: [] };
    state = base;
    if (kind === "pdf_like") {
      addPreset("header");
      addPreset("business");
      addPreset("bill");
      addPreset("job");
      addPreset("labor");
      addPreset("parts");
      addPreset("notes");
      addPreset("summary");
    } else if (kind === "minimal") {
      addPreset("header");
      addPreset("business");
      addPreset("bill");
      addPreset("summary");
    } else if (kind === "service") {
      addPreset("header");
      addPreset("business");
      addPreset("bill");
      addPreset("job");
      addPreset("labor");
      addPreset("parts");
      addPreset("notes");
      addPreset("summary");
    } else {
      addPreset("header");
      addPreset("business");
      addPreset("bill");
      addPreset("job");
      addPreset("parts");
      addPreset("summary");
    }
  }

  async function saveTemplate({ asNew = false, activate = false } = {}) {
    const payload = {
      template_id: asNew ? null : currentTemplateId,
      name: (templateName.value || "").trim() || "Untitled Template",
      set_active: !!activate,
      design: state,
    };
    let res;
    let data = null;
    try {
      res = await fetch(saveUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const raw = await res.text();
      try {
        data = JSON.parse(raw || "{}");
      } catch (_e) {
        data = { ok: false, error: `Unexpected server response (${res.status}).` };
      }
    } catch (err) {
      setStatus("Save failed (network error).", "error");
      alert(`Could not save template: ${err?.message || err}`);
      return false;
    }
    if (!res.ok || !data.ok) {
      setStatus("Save failed.", "error");
      alert(data.error || "Failed to save template.");
      return false;
    }
    if (asNew) {
      templates.unshift({ id: data.id, name: data.name, is_active: !!data.is_active, design: JSON.parse(JSON.stringify(state)) });
      currentTemplateId = data.id;
    } else {
      const t = templates.find(x => Number(x.id) === Number(currentTemplateId));
      if (t) {
        t.name = payload.name;
        t.design = JSON.parse(JSON.stringify(state));
      }
    }
    if (activate) {
      templates.forEach(t => t.is_active = Number(t.id) === Number(currentTemplateId));
    }
    renderTemplateList();
    setStatus(`Saved at ${new Date().toLocaleTimeString()}`, "ok");
    return true;
  }

  async function activateTemplate(id) {
    let res;
    let data = null;
    try {
      res = await fetch(`${activateBase}${id}/activate`, { method: "POST" });
      const raw = await res.text();
      try {
        data = JSON.parse(raw || "{}");
      } catch (_e) {
        data = { ok: false, error: `Unexpected server response (${res.status}).` };
      }
    } catch (err) {
      setStatus("Activate failed (network error).", "error");
      alert(`Could not activate template: ${err?.message || err}`);
      return;
    }
    if (!res.ok || !data.ok) {
      setStatus("Activate failed.", "error");
      return alert(data.error || "Failed to activate template.");
    }
    templates.forEach(t => t.is_active = Number(t.id) === Number(id));
    currentTemplateId = Number(id);
    renderTemplateList();
    setStatus("Template is now active.", "ok");
  }

  async function deleteTemplate(id) {
    if (!confirm("Delete this template?")) return;
    const res = await fetch(`${activateBase}${id}/delete`, { method: "POST" });
    const data = await res.json();
    if (!res.ok || !data.ok) return alert(data.error || "Failed to delete template.");
    const idx = templates.findIndex(t => Number(t.id) === Number(id));
    if (idx >= 0) templates.splice(idx, 1);
    if (!templates.length) return location.reload();
    if (Number(currentTemplateId) === Number(id)) loadTemplate(templates[0].id);
    renderTemplateList();
  }

  canvas.addEventListener("mousedown", (e) => {
    const node = e.target.closest(".node");
    if (!node) { selectedId = null; renderCanvas(); return; }
    const id = node.dataset.id;
    selectedId = id;
    const el = nodeById(id);
    if (!el) return;
    const rect = canvas.getBoundingClientRect();
    const startX = e.clientX;
    const startY = e.clientY;
    const originX = Number(el.x || 0);
    const originY = Number(el.y || 0);
    const originW = Number(el.w || 80);
    const originH = Number(el.h || 30);
    const isResize = e.target.classList.contains("resize");
    drag = { id, startX, startY, originX, originY, originW, originH, isResize, rect };
    renderCanvas();
  });

  window.addEventListener("mousemove", (e) => {
    if (!drag) return;
    const el = nodeById(drag.id);
    if (!el) return;
    const dx = e.clientX - drag.startX;
    const dy = e.clientY - drag.startY;
    if (drag.isResize) {
      el.w = Math.max(30, Math.round((drag.originW + dx) / SNAP) * SNAP);
      el.h = Math.max(24, Math.round((drag.originH + dy) / SNAP) * SNAP);
    } else {
      el.x = Math.max(0, Math.min((state.canvas.width || 816) - 20, Math.round((drag.originX + dx) / SNAP) * SNAP));
      el.y = Math.max(0, Math.min((state.canvas.height || 1056) - 20, Math.round((drag.originY + dy) / SNAP) * SNAP));
    }
    renderCanvas();
  });
  window.addEventListener("mouseup", () => { drag = null; });

  canvasBg.addEventListener("input", () => {
    state.canvas.bg = canvasBg.value;
    renderCanvas();
  });
  if (showSampleData) {
    showSampleData.addEventListener("change", renderCanvas);
  }

  document.querySelectorAll("[data-add]").forEach(btn => {
    btn.addEventListener("click", () => addPreset(btn.dataset.add));
  });
  document.querySelectorAll("[data-quick]").forEach(btn => {
    btn.addEventListener("click", () => quickStart(btn.dataset.quick));
  });

  templateList.addEventListener("click", (e) => {
    const load = e.target.getAttribute("data-load");
    const activate = e.target.getAttribute("data-activate");
    const del = e.target.getAttribute("data-delete");
    if (load) return loadTemplate(Number(load));
    if (activate) return activateTemplate(Number(activate));
    if (del) return deleteTemplate(Number(del));
  });

  saveAsNewBtn.addEventListener("click", async () => {
    setStatus("Saving as new template...");
    await saveTemplate({ asNew: true, activate: false });
  });
  saveActiveBtn.addEventListener("click", async () => {
    setStatus("Saving current template...");
    await saveTemplate({ asNew: false, activate: false });
  });
  setActiveBtn.addEventListener("click", async () => {
    if (!currentTemplateId) {
      alert("Please load a template first.");
      return;
    }
    const ok = await saveTemplate({ asNew: false, activate: false });
    if (!ok) return;
    await activateTemplate(Number(currentTemplateId));
  });

  renderTemplateList();
  loadTemplate(currentTemplateId);
  if (!templates || !templates.length) {
    quickStart("pdf_like");
  }
})();
</script>
{% endblock %}
