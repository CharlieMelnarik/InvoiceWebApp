{% extends "base.html" %}
{% set title = "Invoice Builder" %}

{% block content %}
<style>
  .builder-shell { max-width: 1820px; margin: 0 auto; }
  .builder-layout { display: grid; grid-template-columns: 175px 1fr; gap: 10px; }
  .builder-v3-toolbar {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    padding: 8px 10px;
    border: 1px solid #b6cae8;
    border-radius: 12px;
    background: linear-gradient(180deg, #ffffff 0%, #edf4ff 100%);
    box-shadow: 0 6px 16px rgba(12, 34, 73, 0.10);
    margin-bottom: 10px;
  }
  .toolbar-group { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
  .toolbar-label { font-size: 0.76rem; color: #395a88; font-weight: 700; letter-spacing: 0.02em; text-transform: uppercase; }
  .toolbar-sep { width: 1px; height: 24px; background: #c8d7ed; margin: 0 2px; }
  .builder-panel {
    border: 1px solid #b6cae8;
    border-radius: 14px;
    background: linear-gradient(180deg, #ffffff 0%, #edf4ff 100%);
    box-shadow: 0 10px 26px rgba(12, 34, 73, 0.12);
    padding: 8px;
  }
  .builder-panel h5 { margin: 0 0 6px; color: #123a71; font-weight: 800; font-size: 1rem; }
  .builder-workspace {
    display: flex;
    flex-direction: column;
    gap: 10px;
    min-width: 0;
  }
  .builder-panel-right {
    max-height: 330px;
    overflow: auto;
  }
  .builder-canvas-wrap {
    border: 1px solid #a7bfdf;
    border-radius: 14px;
    padding: 10px;
    background: linear-gradient(180deg, #d8e4f7 0%, #cad8ee 100%);
    overflow: auto;
  }
  .builder-canvas-stage {
    position: relative;
    width: 816px;
    height: 1056px;
    margin: 0 auto;
    transform-origin: top left;
  }
  .builder-live-preview {
    position: absolute;
    top: 0;
    left: 0;
    width: calc(100% + 64px);
    height: calc(100% + 96px);
    border: 0;
    background: #fff;
    z-index: 0;
    pointer-events: none;
    display: block;
    transform-origin: top left;
    transform: translate(var(--preview-offset-x, 0px), var(--preview-offset-y, 0px)) scale(var(--preview-scale, 1));
  }
  .builder-canvas {
    position: relative;
    width: 816px;
    height: 1056px;
    margin: 0;
    background: #fff;
    border: 1px solid #a9bedd;
    box-shadow: 0 12px 30px rgba(15, 23, 42, 0.2);
    transform-origin: top left;
    z-index: 1;
    box-sizing: border-box;
  }
  .canvas-guide {
    position: absolute;
    inset: 16px;
    border: 1px dashed rgba(30, 99, 198, 0.22);
    pointer-events: none;
  }
  .builder-canvas.grid-on::before {
    content: "";
    position: absolute;
    inset: 0;
    pointer-events: none;
    background-image:
      linear-gradient(to right, rgba(30,99,198,0.10) 1px, transparent 1px),
      linear-gradient(to bottom, rgba(30,99,198,0.10) 1px, transparent 1px);
    background-size: 12px 12px;
  }
  .builder-canvas.exact-mode .node {
    color: transparent !important;
    text-decoration: none !important;
    background: transparent !important;
    border-color: transparent !important;
    pointer-events: auto;
  }
  .builder-canvas.exact-mode {
    background: transparent !important;
    border-color: transparent !important;
    box-shadow: none !important;
  }
  .builder-canvas.exact-mode .canvas-guide {
    border-color: transparent !important;
  }
  .builder-canvas.exact-mode .node.selected {
    border-color: #1e63c6 !important;
    background: transparent !important;
  }
  .builder-canvas.exact-mode .node img,
  .builder-canvas.exact-mode .node .image-placeholder {
    opacity: 0;
  }
  .builder-canvas.exact-mode .node .resize { display: none; }
  .builder-canvas.exact-mode .node.selected .resize { display: block; }
  .node {
    position: absolute;
    cursor: move;
    user-select: none;
    border: 1px dashed transparent;
    overflow: hidden;
    white-space: pre-wrap;
  }
  .node.selected { border-color: #1e63c6; background: rgba(30, 99, 198, 0.06); }
  .node.box { background: #fff; }
  .node.image { background: #fff; border-style: solid; }
  .node.image img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
    pointer-events: none;
  }
  .node.image .image-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #3f5f8f;
    font-size: 0.72rem;
    text-align: center;
    padding: 6px;
    pointer-events: none;
  }
  .node .resize {
    position: absolute;
    width: 10px;
    height: 10px;
    right: 0;
    bottom: 0;
    cursor: nwse-resize;
    background: #1e63c6;
  }
  .tool-btn { width: 100%; margin-bottom: 5px; text-align: left; font-size: 0.78rem; padding: 0.28rem 0.42rem; }
  .tool-group-title {
    font-size: 0.8rem;
    font-weight: 800;
    letter-spacing: 0.03em;
    color: #2a4d7f;
    margin: 6px 0 4px;
    text-transform: uppercase;
  }
  .helper-callout {
    border: 1px solid #b9cdea;
    border-radius: 10px;
    background: #f5f9ff;
    padding: 6px;
    font-size: 0.72rem;
    color: #395a88;
    margin-bottom: 8px;
  }
  .token-list {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }
  .token-btn {
    border: 1px solid #b9cdea;
    border-radius: 999px;
    background: #f6f9ff;
    padding: 2px 8px;
    font-size: 0.77rem;
    color: #1f4f94;
    cursor: pointer;
  }
  .builder-token-pill {
    color: #1f5fb5;
    font-weight: 700;
    background: #e8f1ff;
    border: 1px solid #bfd4f5;
    border-radius: 6px;
    padding: 0 4px;
    white-space: nowrap;
  }
  .token-btn:hover { background: #e7f0ff; }
  .template-list { max-height: 240px; overflow: auto; }
  .template-row {
    border: 1px solid #bdd0ea;
    border-radius: 10px;
    padding: 6px;
    background: #fff;
    margin-bottom: 6px;
  }
  .template-row.active { border-color: #1f58ab; box-shadow: 0 0 0 2px rgba(31, 88, 171, 0.15); }
  .builder-shell.left-collapsed .builder-layout { grid-template-columns: 1fr; }
  .builder-shell.right-collapsed .builder-panel-right { display: none; }
  .builder-shell.left-collapsed .builder-panel-left { display: none; }
  @media (max-width: 1300px) { .builder-layout { grid-template-columns: 1fr; } }
</style>

<div class="builder-shell">
  <div class="page-header">
    <div>
      <h1 class="h3 fw-bold mb-1">Invoice Builder</h1>
      <div class="subtitle">Drag, resize, and style invoice elements. Save unlimited templates and set one active.</div>
    </div>
    <div class="action-group">
      <a class="btn btn-outline-secondary" href="{{ url_for('settings') }}">Back to Settings</a>
      <button id="undoBtnTop" class="btn btn-outline-secondary" type="button">Undo</button>
      <button id="redoBtnTop" class="btn btn-outline-secondary" type="button">Redo</button>
      <button id="saveActiveBtn" class="btn btn-primary" type="button">Save Active Template</button>
      <span id="saveStatus" class="badge text-bg-light border align-self-center"></span>
    </div>
  </div>

  <div class="builder-v3-toolbar">
    <div class="toolbar-group">
      <span class="toolbar-label">Edit</span>
      <button id="undoBtn" type="button" class="btn btn-outline-secondary btn-sm">Undo</button>
      <button id="redoBtn" type="button" class="btn btn-outline-secondary btn-sm">Redo</button>
      <button id="duplicateSelectedBtn" type="button" class="btn btn-outline-secondary btn-sm">Duplicate</button>
      <button id="deleteSelectedBtn" type="button" class="btn btn-outline-danger btn-sm">Delete</button>
      <span class="toolbar-sep"></span>
      <button id="alignLeftBtn" type="button" class="btn btn-outline-primary btn-sm">Align L</button>
      <button id="alignCenterBtn" type="button" class="btn btn-outline-primary btn-sm">Align C</button>
      <button id="alignRightBtn" type="button" class="btn btn-outline-primary btn-sm">Align R</button>
      <button id="alignTopBtn" type="button" class="btn btn-outline-primary btn-sm">Top</button>
      <button id="alignMiddleBtn" type="button" class="btn btn-outline-primary btn-sm">Middle</button>
      <button id="alignBottomBtn" type="button" class="btn btn-outline-primary btn-sm">Bottom</button>
    </div>
    <div class="toolbar-group">
      <span class="toolbar-label">View</span>
      <button id="fitWidthBtn" type="button" class="btn btn-outline-secondary btn-sm">Fit Width</button>
      <button id="fitPageBtn" type="button" class="btn btn-outline-secondary btn-sm">Fit Page</button>
      <button id="zoom100Btn" type="button" class="btn btn-outline-secondary btn-sm">100%</button>
      <input id="zoomRange" type="range" class="form-range" min="50" max="175" step="5" value="100" style="width:120px;">
      <span id="zoomLabel" class="small text-muted" style="min-width:42px;">100%</span>
      <span class="toolbar-sep"></span>
      <div class="form-check form-switch m-0">
        <input class="form-check-input" type="checkbox" id="snapToggle" checked>
        <label class="form-check-label small" for="snapToggle">Snap</label>
      </div>
      <div class="form-check form-switch m-0">
        <input class="form-check-input" type="checkbox" id="gridToggle">
        <label class="form-check-label small" for="gridToggle">Grid</label>
      </div>
      <div class="form-check form-switch m-0">
        <input class="form-check-input" type="checkbox" id="exactPreviewToggle" checked>
        <label class="form-check-label small" for="exactPreviewToggle">Exact PDF</label>
      </div>
      <label class="small text-muted m-0" for="previewOffsetX">X</label>
      <input id="previewOffsetX" type="number" class="form-control form-control-sm" style="width:64px;" value="0" step="1">
      <label class="small text-muted m-0" for="previewOffsetY">Y</label>
      <input id="previewOffsetY" type="number" class="form-control form-control-sm" style="width:64px;" value="0" step="1">
      <label class="small text-muted m-0" for="previewScale">Scale</label>
      <input id="previewScale" type="number" class="form-control form-control-sm" style="width:78px;" value="1.000" step="0.005" min="0.900" max="1.100">
      <button id="autoAlignPreviewBtn" type="button" class="btn btn-outline-secondary btn-sm">Auto Align</button>
      <button id="toggleLeftPanelBtn" type="button" class="btn btn-outline-secondary btn-sm">Tools</button>
      <button id="toggleRightPanelBtn" type="button" class="btn btn-outline-secondary btn-sm">Properties</button>
    </div>
  </div>

  <div class="builder-layout">
    <section class="builder-panel builder-panel-left">
      <h5>Easy Builder</h5>
      <div class="helper-callout">
        1) Pick a quick-start layout<br>
        2) Add sections you want<br>
        3) Drag sections where you want them<br>
        4) Save template
      </div>
      <div class="tool-group-title">Quick Start</div>
      <button class="btn btn-primary tool-btn" data-quick="pdf_like">Use PDF-Like Starter (Recommended)</button>
      <button class="btn btn-outline-primary tool-btn" data-quick="standard">Use Standard Starter</button>
      <button class="btn btn-outline-primary tool-btn" data-quick="minimal">Use Minimal Starter</button>
      <button class="btn btn-outline-primary tool-btn" data-quick="service">Use Service Starter</button>
      <div class="tool-group-title">Load InvoiceRunner Layout</div>
      <button class="btn btn-outline-success tool-btn" data-layout="classic">Load Classic Layout</button>
      <button class="btn btn-outline-success tool-btn" data-layout="modern">Load Modern Layout</button>
      <button class="btn btn-outline-success tool-btn" data-layout="split_panel">Load Split Panel Layout</button>
      <button class="btn btn-outline-success tool-btn" data-layout="strip">Load Invoice Strip Layout</button>
      <div class="tool-group-title">Add Sections</div>
      <button class="btn btn-outline-primary tool-btn" data-add="header">+ Header (Title + Date + Number)</button>
      <button class="btn btn-outline-primary tool-btn" data-add="logo">+ Business Logo</button>
      <button class="btn btn-outline-primary tool-btn" data-add="business">+ Business Details Section</button>
      <button class="btn btn-outline-primary tool-btn" data-add="bill">+ Bill To Section</button>
      <button class="btn btn-outline-primary tool-btn" data-add="job">+ Job Details Section</button>
      <button class="btn btn-outline-primary tool-btn" data-add="labor">+ Labor Section</button>
      <button class="btn btn-outline-primary tool-btn" data-add="parts">+ Parts Section</button>
      <button class="btn btn-outline-primary tool-btn" data-add="notes">+ Notes Section</button>
      <button class="btn btn-outline-primary tool-btn" data-add="summary">+ Summary Section</button>
      <button class="btn btn-outline-secondary tool-btn" data-add="text">+ Free Text</button>
      <button class="btn btn-outline-secondary tool-btn" data-add="box">+ Empty Box</button>
      <hr>
      <label class="form-label compact-label">Canvas Background</label>
      <input id="canvasBg" class="form-control form-control-color" type="color" value="#ffffff">
      <div class="form-check mt-2">
        <input class="form-check-input" type="checkbox" id="showSampleData" checked>
        <label class="form-check-label" for="showSampleData">Show sample data in builder preview</label>
      </div>
      <div class="small text-muted mt-2">Tip: click a section, then edit text on the right. Drag to move. Pull corner to resize.</div>
      <div class="small text-muted">Exact mode tip: click selects outer box by default; use <strong>Alt+Click</strong> to select inner text.</div>
    </section>

    <section class="builder-workspace">
      <section class="builder-panel builder-panel-right">
        <h5>Properties</h5>
        <div class="mb-2">
          <label class="form-label compact-label">Template Name</label>
          <input id="templateName" class="form-control" type="text" placeholder="My Custom Layout">
        </div>
        <div class="d-grid gap-2 mb-3">
          <button id="newBlankBtn" class="btn btn-outline-secondary" type="button">New Blank Template</button>
          <button id="saveAsNewBtn" class="btn btn-outline-primary" type="button">Save As New Template</button>
          <button id="setActiveBtn" class="btn btn-outline-success" type="button">Set Selected Active</button>
        </div>
        <hr>
        <div id="propEditor">
          <div class="small text-muted">Select an element to edit.</div>
        </div>
        <hr>
        <h5>Templates</h5>
        <div id="templateList" class="template-list"></div>
      </section>

      <section id="canvasWrap" class="builder-canvas-wrap">
        <div id="canvasStage" class="builder-canvas-stage">
          <iframe id="livePreviewFrame" class="builder-live-preview" title="Exact PDF Preview"></iframe>
          <div id="canvas" class="builder-canvas">
            <div class="canvas-guide"></div>
          </div>
        </div>
      </section>
    </section>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(() => {
  const saveUrl = "{{ url_for('api_invoice_builder_save') }}";
  const activateBase = "/api/invoice-builder/template/";
  const templates = Array.isArray({{ templates_payload|tojson }}) ? {{ templates_payload|tojson }} : [];
  const logoPreviewUrl = {{ (logo_preview_url or '')|tojson }};
  const livePreviewUrl = {{ (live_preview_url or '')|tojson }};
  const ownerHasLogo = {{ (owner_has_logo or False)|tojson }};
  let currentTemplateId = {{ active_template_id|tojson }};

  const canvas = document.getElementById("canvas");
  const canvasStage = document.getElementById("canvasStage");
  const canvasWrap = document.getElementById("canvasWrap");
  const canvasBg = document.getElementById("canvasBg");
  const templateName = document.getElementById("templateName");
  const templateList = document.getElementById("templateList");
  const propEditor = document.getElementById("propEditor");
  const saveAsNewBtn = document.getElementById("saveAsNewBtn");
  const newBlankBtn = document.getElementById("newBlankBtn");
  const saveActiveBtn = document.getElementById("saveActiveBtn");
  const setActiveBtn = document.getElementById("setActiveBtn");
  const saveStatus = document.getElementById("saveStatus");
  const showSampleData = document.getElementById("showSampleData");
  const zoomRange = document.getElementById("zoomRange");
  const zoomLabel = document.getElementById("zoomLabel");
  const snapToggle = document.getElementById("snapToggle");
  const gridToggle = document.getElementById("gridToggle");
  const exactPreviewToggle = document.getElementById("exactPreviewToggle");
  const previewOffsetXInput = document.getElementById("previewOffsetX");
  const previewOffsetYInput = document.getElementById("previewOffsetY");
  const previewScaleInput = document.getElementById("previewScale");
  const autoAlignPreviewBtn = document.getElementById("autoAlignPreviewBtn");
  const livePreviewFrame = document.getElementById("livePreviewFrame");
  const undoBtn = document.getElementById("undoBtn");
  const redoBtn = document.getElementById("redoBtn");
  const undoBtnTop = document.getElementById("undoBtnTop");
  const redoBtnTop = document.getElementById("redoBtnTop");
  const duplicateSelectedBtn = document.getElementById("duplicateSelectedBtn");
  const deleteSelectedBtn = document.getElementById("deleteSelectedBtn");
  const alignLeftBtn = document.getElementById("alignLeftBtn");
  const alignCenterBtn = document.getElementById("alignCenterBtn");
  const alignRightBtn = document.getElementById("alignRightBtn");
  const alignTopBtn = document.getElementById("alignTopBtn");
  const alignMiddleBtn = document.getElementById("alignMiddleBtn");
  const alignBottomBtn = document.getElementById("alignBottomBtn");
  const fitWidthBtn = document.getElementById("fitWidthBtn");
  const fitPageBtn = document.getElementById("fitPageBtn");
  const zoom100Btn = document.getElementById("zoom100Btn");
  const toggleLeftPanelBtn = document.getElementById("toggleLeftPanelBtn");
  const toggleRightPanelBtn = document.getElementById("toggleRightPanelBtn");
  const builderShell = document.querySelector(".builder-shell");

  let state = { canvas: { width: 816, height: 1056, bg: "#ffffff" }, elements: [] };
  let selectedId = null;
  let drag = null;
  let zoomPct = 100;
  const SNAP = 4;
  let snapEnabled = true;
  let showGridEnabled = false;
  let history = [];
  let historyIndex = -1;
  let restoringHistory = false;
  let exactPreviewEnabled = true;
  let previewTimer = null;
  let previewObjectUrl = "";
  let previewInFlight = false;
  let previewQueued = false;
  let previewReqSeq = 0;
  let previewAppliedSeq = 0;
  let previewOffsetX = 0;
  let previewOffsetY = 0;
  let previewScale = 1;
  const TOKENS = [
    "doc_label","invoice_number","date","due_date","business_name","business_phone","business_address","business_email","business_logo",
    "customer_name","customer_email","customer_phone","job","job_label","rate","hours",
    "labor_title","parts_title","shop_supplies_label",
    "labor_lines","parts_lines","notes_text","labor_table","parts_table",
    "parts_total","labor_total","tax","total","paid","amount_due"
  ];
  const TOKEN_LABELS = {
    doc_label: "Document Label",
    invoice_number: "Document Number",
    date: "Date",
    due_date: "Due Date",
    business_name: "Business Name",
    business_phone: "Business Phone",
    business_address: "Business Address",
    business_email: "Business Email",
    business_logo: "Business Logo",
    customer_name: "Customer Name",
    customer_email: "Customer Email",
    customer_phone: "Customer Phone",
    job: "Job",
    job_label: "Job Label",
    rate: "Rate",
    hours: "Hours",
    labor_title: "Labor Title",
    parts_title: "Parts Title",
    shop_supplies_label: "Shop Supplies Label",
    labor_lines: "Labor Lines",
    parts_lines: "Parts Lines",
    notes_text: "Notes Text",
    labor_table: "Labor Table",
    parts_table: "Parts Table",
    parts_total: "Parts Total",
    labor_total: "Labor Total",
    tax: "Tax",
    total: "Total",
    paid: "Paid",
    amount_due: "Amount Due",
  };
  const tok = (name) => "{" + "{" + name + "}" + "}";
  function setStatus(msg, kind = "info") {
    if (!saveStatus) return;
    saveStatus.textContent = msg || "";
    saveStatus.className = "badge border align-self-center";
    if (kind === "ok") {
      saveStatus.classList.add("text-bg-success");
    } else if (kind === "error") {
      saveStatus.classList.add("text-bg-danger");
    } else {
      saveStatus.classList.add("text-bg-light");
    }
  }

  function cloneState() {
    return JSON.parse(JSON.stringify(state || { canvas: { width: 816, height: 1056, bg: "#fff" }, elements: [] }));
  }

  function pushHistory(label = "") {
    if (restoringHistory) return;
    const snap = cloneState();
    const prev = history[historyIndex];
    if (prev && JSON.stringify(prev) === JSON.stringify(snap)) return;
    history = history.slice(0, historyIndex + 1);
    history.push(snap);
    historyIndex = history.length - 1;
    if (history.length > 80) {
      history.shift();
      historyIndex = history.length - 1;
    }
    if (label) setStatus(label, "info");
  }

  function applyHistory(index) {
    if (index < 0 || index >= history.length) return;
    restoringHistory = true;
    state = normalizeDesign(history[index]);
    historyIndex = index;
    selectedId = null;
    restoringHistory = false;
    renderCanvas();
  }

  function undo() {
    if (historyIndex <= 0) return;
    applyHistory(historyIndex - 1);
    setStatus("Undo", "info");
  }

  function redo() {
    if (historyIndex >= history.length - 1) return;
    applyHistory(historyIndex + 1);
    setStatus("Redo", "info");
  }

  function updateZoom() {
    zoomPct = Math.max(50, Math.min(175, Number(zoomPct || 100)));
    const z = zoomPct / 100;
    if (canvas) canvas.style.transform = `scale(${z})`;
    const w = Number(state?.canvas?.width || 816);
    const h = Number(state?.canvas?.height || 1056);
    if (canvasStage) {
      canvasStage.style.width = `${Math.round(w * z)}px`;
      canvasStage.style.height = `${Math.round(h * z)}px`;
    }
    if (zoomRange) zoomRange.value = String(zoomPct);
    if (zoomLabel) zoomLabel.textContent = `${zoomPct}%`;
  }

  function applyPreviewOffset() {
    if (!canvasStage) return;
    canvasStage.style.setProperty("--preview-offset-x", `${Math.round(previewOffsetX)}px`);
    canvasStage.style.setProperty("--preview-offset-y", `${Math.round(previewOffsetY)}px`);
    const clampedScale = Math.max(0.9, Math.min(1.1, Number(previewScale || 1)));
    previewScale = clampedScale;
    canvasStage.style.setProperty("--preview-scale", `${clampedScale}`);
    if (previewOffsetXInput) previewOffsetXInput.value = String(Math.round(previewOffsetX));
    if (previewOffsetYInput) previewOffsetYInput.value = String(Math.round(previewOffsetY));
    if (previewScaleInput) previewScaleInput.value = clampedScale.toFixed(3);
    try {
      localStorage.setItem("invoice_builder_preview_offset_x", String(Math.round(previewOffsetX)));
      localStorage.setItem("invoice_builder_preview_offset_y", String(Math.round(previewOffsetY)));
      localStorage.setItem("invoice_builder_preview_scale", clampedScale.toFixed(3));
    } catch (_e) {}
  }

  function loadPreviewOffsetDefaults() {
    let x = 0;
    let y = 0;
    let s = 1;
    try {
      const sx = localStorage.getItem("invoice_builder_preview_offset_x");
      const sy = localStorage.getItem("invoice_builder_preview_offset_y");
      const ss = localStorage.getItem("invoice_builder_preview_scale");
      if (sx !== null && sx !== "") x = Number(sx) || 0;
      if (sy !== null && sy !== "") y = Number(sy) || 0;
      if (ss !== null && ss !== "") s = Number(ss) || 1;
    } catch (_e) {}
    if (x === 0 && y === 0) {
      const ua = navigator.userAgent || "";
      const isSafari = /Safari/i.test(ua) && !/Chrome|Chromium|Edg|CriOS/i.test(ua);
      if (isSafari) {
        x = -56;
        y = -36;
        s = 1.018;
      }
    }
    previewOffsetX = x;
    previewOffsetY = y;
    previewScale = s;
    applyPreviewOffset();
  }

  function autoAlignPreview() {
    const ua = navigator.userAgent || "";
    const isSafari = /Safari/i.test(ua) && !/Chrome|Chromium|Edg|CriOS/i.test(ua);
    const isFirefox = /Firefox/i.test(ua);
    if (isSafari) {
      previewOffsetX = -56;
      previewOffsetY = -36;
      previewScale = 1.018;
    } else if (isFirefox) {
      previewOffsetX = -8;
      previewOffsetY = -8;
      previewScale = 1.002;
    } else {
      previewOffsetX = 0;
      previewOffsetY = 0;
      previewScale = 1;
    }
    applyPreviewOffset();
    setStatus("Auto alignment applied.", "ok");
    refreshExactPreviewNow();
  }

  async function refreshExactPreviewNow() {
    if (!exactPreviewEnabled || !livePreviewUrl || !livePreviewFrame) return;
    if (previewInFlight) {
      previewQueued = true;
      return;
    }
    previewInFlight = true;
    const reqSeq = ++previewReqSeq;
    try {
      const res = await fetch(livePreviewUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ design: state }),
      });
      if (!res.ok) return;
      const blob = await res.blob();
      if (previewObjectUrl) URL.revokeObjectURL(previewObjectUrl);
      previewObjectUrl = URL.createObjectURL(blob);
      if (reqSeq >= previewAppliedSeq) {
        previewAppliedSeq = reqSeq;
        livePreviewFrame.src = `${previewObjectUrl}#toolbar=0&navpanes=0&scrollbar=0&zoom=page-width`;
      }
    } catch (_e) {
      // best effort only
    } finally {
      previewInFlight = false;
      if (previewQueued) {
        previewQueued = false;
        refreshExactPreviewNow();
      }
    }
  }

  function scheduleExactPreview() {
    if (!exactPreviewEnabled || !livePreviewUrl) return;
    if (previewTimer) clearTimeout(previewTimer);
    const delayMs = drag ? 60 : 220;
    previewTimer = setTimeout(() => {
      previewTimer = null;
      refreshExactPreviewNow();
    }, delayMs);
  }

  function fitWidth() {
    if (!canvasWrap) return;
    const targetW = Math.max(180, canvasWrap.clientWidth - 24);
    const baseW = Number(state?.canvas?.width || 816);
    zoomPct = Math.max(50, Math.min(175, Math.round((targetW / baseW) * 100)));
    updateZoom();
  }

  function fitPage() {
    if (!canvasWrap) return;
    const targetW = Math.max(180, canvasWrap.clientWidth - 24);
    const targetH = Math.max(240, canvasWrap.clientHeight - 24);
    const baseW = Number(state?.canvas?.width || 816);
    const baseH = Number(state?.canvas?.height || 1056);
    const z = Math.min(targetW / baseW, targetH / baseH);
    zoomPct = Math.max(50, Math.min(175, Math.round(z * 100)));
    updateZoom();
  }

  function isTypingContext() {
    const a = document.activeElement;
    if (!a) return false;
    if (a.tagName === "INPUT" || a.tagName === "TEXTAREA" || a.tagName === "SELECT") return true;
    return !!a.closest?.("[contenteditable='true']");
  }

  function deleteSelected() {
    const el = nodeById(selectedId);
    if (!el) return;
    state.elements = state.elements.filter(x => String(x.id) !== String(el.id));
    selectedId = null;
    pushHistory("Element deleted");
    renderCanvas();
  }

  function duplicateSelected() {
    const el = nodeById(selectedId);
    if (!el) return;
    const copy = JSON.parse(JSON.stringify(el));
    copy.id = `el_${Date.now()}`;
    copy.x = (copy.x || 0) + 16;
    copy.y = (copy.y || 0) + 16;
    state.elements.push(copy);
    selectedId = copy.id;
    pushHistory("Element duplicated");
    renderCanvas();
  }

  function alignSelected(mode) {
    const el = nodeById(selectedId);
    if (!el) return;
    const cw = Number(state?.canvas?.width || 816);
    const ch = Number(state?.canvas?.height || 1056);
    if (mode === "left") el.x = 0;
    if (mode === "center") el.x = Math.round((cw - Number(el.w || 0)) / 2);
    if (mode === "right") el.x = Math.max(0, cw - Number(el.w || 0));
    if (mode === "top") el.y = 0;
    if (mode === "middle") el.y = Math.round((ch - Number(el.h || 0)) / 2);
    if (mode === "bottom") el.y = Math.max(0, ch - Number(el.h || 0));
    pushHistory("Aligned");
    renderCanvas();
  }
  const SAMPLE_VALUES = {{ (builder_sample_values or {})|tojson }};

  function activeTemplate() {
    return templates.find(t => Number(t.id) === Number(currentTemplateId)) || templates[0];
  }

  function nodeById(id) {
    return state.elements.find(e => String(e.id) === String(id));
  }

  function normalizeDesign(design) {
    const safe = JSON.parse(JSON.stringify(design || { canvas: { width: 816, height: 1056, bg: "#fff" }, elements: [] }));
    if (!safe.canvas) safe.canvas = { width: 816, height: 1056, bg: "#fff" };
    if (!Array.isArray(safe.elements)) safe.elements = [];
    safe.elements = safe.elements.map((el) => {
      if (!el || typeof el !== "object") return el;
      const copy = { ...el };
      if (typeof copy.text === "string") {
        let txt = copy.text;
        for (let i = 0; i < 5; i += 1) {
          if (!txt.includes("\\n")) break;
          txt = txt.replace(/\\n/g, "\n");
        }
        copy.text = txt;
      }
      if (typeof copy.richText === "string") {
        let rich = copy.richText;
        for (let i = 0; i < 5; i += 1) {
          if (!rich.includes("\\n")) break;
          rich = rich.replace(/\\n/g, "\n");
        }
        copy.richText = rich;
      }
      return copy;
    });
    return safe;
  }

  function escapeHtml(text) {
    return String(text || "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
  }

  function plainTextToHtml(text) {
    return escapeHtml(String(text || "").replace(/\\n/g, "\n")).replace(/\n/g, "<br>");
  }

  function richHtmlToPlain(html) {
    const tmp = document.createElement("div");
    tmp.innerHTML = String(html || "")
      .replace(/<\/?(div|p)[^>]*>/gi, "\n")
      .replace(/<br\s*\/?>/gi, "\n");
    return (tmp.textContent || tmp.innerText || "").replace(/\r/g, "");
  }

  function tokenLabel(key) {
    const k = String(key || "");
    return TOKEN_LABELS[k] || k.replace(/_/g, " ").replace(/\b\w/g, (m) => m.toUpperCase());
  }

  function tokenizedToDisplayHtml(rawHtml) {
    return String(rawHtml || "").replace(/\{\{\s*([a-zA-Z0-9_]+)\s*\}\}/g, (_m, key) => {
      const label = tokenLabel(key).replace(/</g, "&lt;").replace(/>/g, "&gt;");
      return `<span class="builder-token-pill" contenteditable="false" data-token="${key}">${label}</span>`;
    });
  }

  function displayHtmlToTokenized(rawHtml) {
    const wrap = document.createElement("div");
    wrap.innerHTML = String(rawHtml || "");
    wrap.querySelectorAll("span.builder-token-pill[data-token]").forEach((node) => {
      const key = (node.getAttribute("data-token") || "").trim();
      const repl = document.createTextNode("\u007b\u007b" + key + "\u007d\u007d");
      node.replaceWith(repl);
    });
    return wrap.innerHTML;
  }

  function stripInlineFontSizeStyles(html) {
    let out = String(html || "");
    // Remove font-size from inline style attrs but keep other style rules.
    out = out.replace(/style=(['"])(.*?)\1/gi, (_m, q, styleBody) => {
      const cleaned = String(styleBody || "")
        .replace(/(?:^|;)\s*font-size\s*:\s*[^;]+/gi, "")
        .replace(/^\s*;\s*|\s*;\s*$/g, "")
        .trim();
      return cleaned ? `style=${q}${cleaned}${q}` : "";
    });
    // Legacy <font size="..."> tags can also override element-level font size.
    out = out.replace(/\s+size=(['"]).*?\1/gi, "");
    return out;
  }

  function renderedNodeHtml(el) {
    const rawHtml = String(el.richText || plainTextToHtml(el.text || ""));
    if (!(showSampleData && showSampleData.checked)) return rawHtml;
    return rawHtml.replace(/\{\{\s*([a-z_]+)\s*\}\}/gi, (_m, key) => SAMPLE_VALUES[key] ?? tok(key));
  }

  function resolveImageSrc(el) {
    const raw = String(el?.src || el?.text || "").trim();
    if (!raw) return "";
    if (/\{\{\s*business_logo\s*\}\}/i.test(raw)) return logoPreviewUrl || "";
    if (raw.startsWith("imported_asset:")) {
      const assetPath = raw.slice("imported_asset:".length).replace(/^\/+/, "");
      return `/api/invoice-builder/imported-asset/${encodeURI(assetPath)}`;
    }
    return raw;
  }

  function updateSelectedNodeText() {
    if (!selectedId) return;
    const el = nodeById(selectedId);
    if (!el || String(el.type || "text").toLowerCase() === "box") return;
    const node = canvas.querySelector(`.node[data-id="${CSS.escape(String(selectedId))}"]`);
    if (!node) return;
    const resize = node.querySelector(".resize");
    node.innerHTML = renderedNodeHtml(el);
    if (resize) node.appendChild(resize);
    scheduleExactPreview();
  }

  function insertTokenAtCaret(editor, token) {
    editor.focus();
    try {
      const ok = document.execCommand("insertText", false, token);
      if (ok) return;
    } catch (_e) {}
    const sel = window.getSelection();
    if (!sel || !sel.rangeCount) {
      editor.innerHTML += escapeHtml(token);
      return;
    }
    const range = sel.getRangeAt(0);
    range.deleteContents();
    range.insertNode(document.createTextNode(token));
    range.collapse(false);
    sel.removeAllRanges();
    sel.addRange(range);
  }

  function applyInlineSpanStyle(editor, styles) {
    const sel = window.getSelection();
    if (!sel || !sel.rangeCount) return false;
    const range = sel.getRangeAt(0);
    if (!editor.contains(range.commonAncestorContainer) || range.collapsed) return false;
    const span = document.createElement("span");
    Object.entries(styles || {}).forEach(([k, v]) => {
      if (v !== null && v !== undefined && String(v).trim() !== "") span.style[k] = String(v);
    });
    const frag = range.extractContents();
    span.appendChild(frag);
    range.insertNode(span);
    const newRange = document.createRange();
    newRange.selectNodeContents(span);
    newRange.collapse(false);
    sel.removeAllRanges();
    sel.addRange(newRange);
    return true;
  }

  function hasDynamicTableToken(el) {
    const raw = `${String(el?.text || "")} ${String(el?.richText || "")}`;
    return /\{\{\s*(labor_table|parts_table|labor_lines|parts_lines)\s*\}\}/i.test(raw);
  }

  function xOverlap(a, b) {
    const ax1 = Number(a?.x || 0);
    const ax2 = ax1 + Math.max(1, Number(a?.w || 1));
    const bx1 = Number(b?.x || 0);
    const bx2 = bx1 + Math.max(1, Number(b?.w || 1));
    return ax1 < bx2 && bx1 < ax2;
  }

  function nearestBelowY(el) {
    const y = Number(el?.y || 0);
    let best = null;
    state.elements.forEach((other) => {
      if (!other || String(other.id) === String(el.id)) return;
      if (!xOverlap(el, other)) return;
      const oy = Number(other.y || 0);
      if (oy <= y) return;
      if (best === null || oy < best) best = oy;
    });
    return best;
  }

  function renderTemplateList() {
    templateList.innerHTML = "";
    let count = 0;
    (Array.isArray(templates) ? templates : []).forEach((t) => {
      if (!t || typeof t !== "object") return;
      const idNum = Number(t.id);
      if (!Number.isFinite(idNum)) return;

      const row = document.createElement("div");
      row.className = "template-row" + (idNum === Number(currentTemplateId) ? " active" : "");

      const head = document.createElement("div");
      head.className = "d-flex justify-content-between align-items-center";
      const name = document.createElement("strong");
      name.textContent = String(t.name || "Template");
      head.appendChild(name);
      if (t.is_active) {
        const badge = document.createElement("span");
        badge.className = "badge text-bg-success";
        badge.textContent = "Active";
        head.appendChild(badge);
      }
      row.appendChild(head);

      const actions = document.createElement("div");
      actions.className = "d-flex gap-1 mt-2";
      const mkBtn = (cls, label, attr) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = `btn ${cls} btn-sm`;
        btn.textContent = label;
        btn.setAttribute(attr, String(idNum));
        return btn;
      };
      actions.appendChild(mkBtn("btn-outline-primary", "Load", "data-load"));
      actions.appendChild(mkBtn("btn-outline-success", "Activate", "data-activate"));
      actions.appendChild(mkBtn("btn-outline-danger", "Delete", "data-delete"));
      row.appendChild(actions);

      templateList.appendChild(row);
      count += 1;
    });

    if (count === 0) {
      const empty = document.createElement("div");
      empty.className = "small text-muted";
      empty.textContent = "No templates loaded. If this looks wrong, refresh this page.";
      templateList.appendChild(empty);
    }
  }

  function renderCanvas(pass = 0) {
    canvas.style.background = state.canvas.bg || "#fff";
    canvas.classList.toggle("grid-on", !!showGridEnabled);
    canvas.classList.toggle("exact-mode", !!exactPreviewEnabled);
    canvas.innerHTML = '<div class="canvas-guide"></div>';

    state.elements.forEach(el => {
      const node = document.createElement("div");
      node.className = "node " + (el.type === "box" ? "box " : "") + (String(el.id) === String(selectedId) ? "selected" : "");
      node.dataset.id = String(el.id);
      node.dataset.type = String(el.type || "text").toLowerCase();
      node.style.left = `${el.x || 0}px`;
      node.style.top = `${el.y || 0}px`;
      node.style.width = `${Math.max(30, el.w || 80)}px`;
      node.style.height = `${Math.max(24, el.h || 30)}px`;
      node.style.color = el.color || "#111827";
      node.style.fontSize = `${el.fontSize || 14}px`;
      node.style.fontWeight = String(el.fontWeight || 500);
      const fontFamily = String(el.fontFamily || "Helvetica");
      node.style.fontFamily =
        fontFamily === "Times-Roman" ? "Georgia, 'Times New Roman', serif" :
        fontFamily === "Courier" ? "'Courier New', Courier, monospace" :
        "'Helvetica Neue', Helvetica, Arial, sans-serif";
      node.style.fontStyle = (String(el.fontStyle || "normal").toLowerCase() === "italic") ? "italic" : "normal";
      node.style.textAlign = String(el.textAlign || "left").toLowerCase();
      node.style.textDecoration = (el.underline ? "underline" : "none");
      node.style.lineHeight = String(Math.max(0.8, Math.min(3.0, Number(el.lineSpacing || 1.2))));
      node.style.borderColor = el.borderColor || "transparent";
      node.style.backgroundColor = el.fillColor || "transparent";
      node.style.borderRadius = `${el.radius || 0}px`;
      if (String(el.type || "").toLowerCase() === "image") {
        node.classList.add("image");
        const src = resolveImageSrc(el);
        if (src) {
          node.innerHTML = `<img src="${src}" alt="Logo">`;
        } else {
          node.innerHTML = `<div class="image-placeholder">Business Logo</div>`;
        }
      } else {
        node.innerHTML = renderedNodeHtml(el);
      }
      const resize = document.createElement("div");
      resize.className = "resize";
      node.appendChild(resize);
      canvas.appendChild(node);

      if (el.type !== "box" && (el.autoGrow || hasDynamicTableToken(el))) {
        const baseMin = Math.max(24, Number(el.minH || 30));
        node.style.height = "auto";
        let needed = Math.max(baseMin, Math.ceil(node.scrollHeight + 8));
        const collisionY = nearestBelowY(el);
        if (collisionY !== null) {
          const maxAllowed = Math.max(baseMin, Math.floor(collisionY - Number(el.y || 0) - 4));
          needed = Math.min(needed, maxAllowed);
        }
        node.style.height = `${needed}px`;
        if (Number(el.h || 0) !== needed) el.h = needed;
      }
    });

    let layoutChanged = false;

    // Linked growth for boxes that track another element's height.
    state.elements.forEach((box) => {
      if (!box || box.type !== "box" || !box.growWithId) return;
      const target = nodeById(box.growWithId);
      if (!target) return;
      if (box.growDelta === null || box.growDelta === undefined || Number.isNaN(Number(box.growDelta))) {
        box.growDelta = Number(box.h || 0) - Number(target.h || 0);
      }
      let desired = Math.max(24, Math.round(Number(target.h || 0) + Number(box.growDelta || 0)));
      const collisionY = nearestBelowY(box);
      if (collisionY !== null) {
        const maxAllowed = Math.max(24, Math.floor(collisionY - Number(box.y || 0) - 4));
        desired = Math.min(desired, maxAllowed);
      }
      if (Number(box.h || 0) !== desired) {
        box.h = desired;
        layoutChanged = true;
      }
    });

    // Lock-follow behavior (anchor to another element's position).
    state.elements.forEach((el) => {
      if (!el || !el.lockToId) return;
      const anchor = nodeById(el.lockToId);
      if (!anchor || String(anchor.id) === String(el.id)) return;
      const offset = Number(el.lockOffset || 0);
      const mode = String(el.lockMode || "below");
      let newY = Number(el.y || 0);
      if (mode === "above") {
        newY = Number(anchor.y || 0) - Number(el.h || 0) + offset;
      } else if (mode === "align_top") {
        newY = Number(anchor.y || 0) + offset;
      } else if (mode === "align_bottom") {
        newY = Number(anchor.y || 0) + Number(anchor.h || 0) - Number(el.h || 0) + offset;
      } else {
        newY = Number(anchor.y || 0) + Number(anchor.h || 0) + offset;
      }
      newY = Math.max(0, Math.round(newY));
      if (Number(el.y || 0) !== newY) {
        el.y = newY;
        layoutChanged = true;
      }
    });

    if (layoutChanged && pass < 4) {
      renderCanvas(pass + 1);
      return;
    }
    updateZoom();
    scheduleExactPreview();
    renderPropertyEditor();
  }

  function renderPropertyEditor() {
    const el = nodeById(selectedId);
    if (!el) {
      propEditor.innerHTML = '<div class="small text-muted">Select an element to edit.</div>';
      return;
    }
    if (el.type === "box") {
      const textTargets = state.elements.filter((x) => x && x.type !== "box");
      const allTargets = state.elements.filter((x) => x && String(x.id) !== String(el.id));
      const targetOptions = ['<option value="">None</option>'].concat(
        textTargets.map((t) => {
          const label = (String(t.text || t.richText || "Text Element").replace(/\s+/g, " ").trim() || "Text Element").slice(0, 42);
          const selected = String(el.growWithId || "") === String(t.id) ? "selected" : "";
          return `<option value="${String(t.id)}" ${selected}>${label}</option>`;
        })
      ).join("");
      const lockOptions = ['<option value="">None</option>'].concat(
        allTargets.map((t) => {
          const raw = String(t.text || t.richText || (t.type === "box" ? "Box Element" : "Element")).replace(/\s+/g, " ").trim();
          const label = (raw || (t.type === "box" ? "Box Element" : "Element")).slice(0, 42);
          const selected = String(el.lockToId || "") === String(t.id) ? "selected" : "";
          return `<option value="${String(t.id)}" ${selected}>${label}</option>`;
        })
      ).join("");
      propEditor.innerHTML = `
        <div class="mb-2 small text-muted">Box shape selected.</div>
        <div class="row g-2">
          <div class="col-6">
            <label class="form-label compact-label">Border Color</label>
            <input id="propBorder" class="form-control form-control-color" type="color" value="${(el.borderColor && el.borderColor.startsWith("#")) ? el.borderColor : "#111827"}">
          </div>
          <div class="col-6">
            <label class="form-label compact-label">Fill Color</label>
            <input id="propFill" class="form-control form-control-color" type="color" value="${(el.fillColor && el.fillColor.startsWith("#")) ? el.fillColor : "#ffffff"}">
          </div>
          <div class="col-6">
            <label class="form-label compact-label">Corner Radius</label>
            <input id="propRadius" class="form-control" type="number" min="0" max="40" value="${el.radius || 0}">
          </div>
          <div class="col-12">
            <label class="form-label compact-label">Grow With Element</label>
            <select id="propGrowWith" class="form-select">${targetOptions}</select>
          </div>
          <div class="col-6">
            <label class="form-label compact-label">Height Offset</label>
            <input id="propGrowDelta" class="form-control" type="number" value="${Number(el.growDelta || 0)}">
          </div>
          <div class="col-12">
            <label class="form-label compact-label">Lock To Element</label>
            <select id="propLockTo" class="form-select">${lockOptions}</select>
          </div>
          <div class="col-6">
            <label class="form-label compact-label">Lock Position</label>
            <select id="propLockMode" class="form-select">
              <option value="below" ${String(el.lockMode || "below") === "below" ? "selected" : ""}>Below Anchor</option>
              <option value="above" ${String(el.lockMode || "below") === "above" ? "selected" : ""}>Above Anchor</option>
              <option value="align_top" ${String(el.lockMode || "below") === "align_top" ? "selected" : ""}>Align Top</option>
              <option value="align_bottom" ${String(el.lockMode || "below") === "align_bottom" ? "selected" : ""}>Align Bottom</option>
            </select>
          </div>
          <div class="col-6">
            <label class="form-label compact-label">Lock Offset</label>
            <input id="propLockOffset" class="form-control" type="number" value="${Number(el.lockOffset || 0)}">
          </div>
        </div>
        <div class="d-grid gap-2 mt-2">
          <button id="duplicateBtn" class="btn btn-outline-primary btn-sm" type="button">Duplicate Element</button>
          <button id="removeBtn" class="btn btn-outline-danger btn-sm" type="button">Delete Element</button>
        </div>
      `;
      document.getElementById("propBorder").addEventListener("input", (e) => { el.borderColor = e.target.value; renderCanvas(); });
      document.getElementById("propFill").addEventListener("input", (e) => { el.fillColor = e.target.value; renderCanvas(); });
      document.getElementById("propRadius").addEventListener("input", (e) => { el.radius = Number(e.target.value || 0); renderCanvas(); });
      document.getElementById("propGrowWith").addEventListener("change", (e) => {
        const targetId = (e.target.value || "").trim();
        el.growWithId = targetId || null;
        if (!targetId) {
          el.growDelta = 0;
        } else {
          const target = nodeById(targetId);
          el.growDelta = Number(el.h || 0) - Number(target?.h || 0);
        }
        renderCanvas();
      });
      document.getElementById("propGrowDelta").addEventListener("input", (e) => {
        el.growDelta = Number(e.target.value || 0);
        renderCanvas();
      });
      document.getElementById("propLockTo").addEventListener("change", (e) => {
        el.lockToId = (e.target.value || "").trim() || null;
        if (!el.lockToId) el.lockOffset = 0;
        renderCanvas();
      });
      document.getElementById("propLockMode").addEventListener("change", (e) => {
        el.lockMode = (e.target.value || "below").trim();
        renderCanvas();
      });
      document.getElementById("propLockOffset").addEventListener("input", (e) => {
        el.lockOffset = Number(e.target.value || 0);
        renderCanvas();
      });
    } else if (el.type === "image") {
      propEditor.innerHTML = `
        <div class="mb-2 small text-muted">Logo/image element selected.</div>
        <div class="row g-2">
          <div class="col-12">
            <label class="form-label compact-label">Image Source</label>
            <input id="propImgSrc" class="form-control" type="text" value="${String(el.src || "{{business_logo}}")}" placeholder="{{business_logo}}">
          </div>
          <div class="col-6">
            <label class="form-label compact-label">Border Color</label>
            <input id="propBorder" class="form-control form-control-color" type="color" value="${(el.borderColor && el.borderColor.startsWith("#")) ? el.borderColor : "#111827"}">
          </div>
          <div class="col-6">
            <label class="form-label compact-label">Fill Color</label>
            <input id="propFill" class="form-control form-control-color" type="color" value="${(el.fillColor && el.fillColor.startsWith("#")) ? el.fillColor : "#ffffff"}">
          </div>
          <div class="col-6">
            <label class="form-label compact-label">Corner Radius</label>
            <input id="propRadius" class="form-control" type="number" min="0" max="40" value="${el.radius || 0}">
          </div>
        </div>
        <div class="d-grid gap-2 mt-2">
          <button id="duplicateBtn" class="btn btn-outline-primary btn-sm" type="button">Duplicate Element</button>
          <button id="removeBtn" class="btn btn-outline-danger btn-sm" type="button">Delete Element</button>
        </div>
      `;
      document.getElementById("propImgSrc").addEventListener("input", (e) => {
        el.src = String(e.target.value || "").trim() || "{{business_logo}}";
        renderCanvas();
      });
      document.getElementById("propBorder").addEventListener("input", (e) => { el.borderColor = e.target.value; renderCanvas(); });
      document.getElementById("propFill").addEventListener("input", (e) => { el.fillColor = e.target.value; renderCanvas(); });
      document.getElementById("propRadius").addEventListener("input", (e) => { el.radius = Number(e.target.value || 0); renderCanvas(); });
    } else {
      const isBold = Number(el.fontWeight || 500) >= 600;
      const isItalic = String(el.fontStyle || "normal").toLowerCase() === "italic";
      const isUnderline = !!el.underline;
      const textAlign = String(el.textAlign || "left").toLowerCase();
      const allTargets = state.elements.filter((x) => x && String(x.id) !== String(el.id));
      const lockOptions = ['<option value="">None</option>'].concat(
        allTargets.map((t) => {
          const raw = String(t.text || t.richText || (t.type === "box" ? "Box Element" : "Element")).replace(/\s+/g, " ").trim();
          const label = (raw || (t.type === "box" ? "Box Element" : "Element")).slice(0, 42);
          const selected = String(el.lockToId || "") === String(t.id) ? "selected" : "";
          return `<option value="${String(t.id)}" ${selected}>${label}</option>`;
        })
      ).join("");
      propEditor.innerHTML = `
        <div class="mb-2">
          <label class="form-label compact-label">Text</label>
          <div class="btn-toolbar mb-2 gap-2" role="toolbar" aria-label="Inline text style">
            <div class="btn-group btn-group-sm" role="group">
              <button id="inlineBold" type="button" class="btn btn-outline-secondary"><strong>B</strong></button>
              <button id="inlineItalic" type="button" class="btn btn-outline-secondary"><em>I</em></button>
              <button id="inlineUnderline" type="button" class="btn btn-outline-secondary"><span style="text-decoration: underline;">U</span></button>
            </div>
            <select id="inlineFontFamily" class="form-select form-select-sm" style="max-width: 220px;">
              <option value="Helvetica">Inline Sans (Helvetica)</option>
              <option value="Times-Roman">Inline Serif (Times)</option>
              <option value="Courier">Inline Mono (Courier)</option>
            </select>
            <select id="inlineFontSize" class="form-select form-select-sm" style="max-width: 140px;">
              <option value="">Inline Size</option>
              <option value="10">10 pt</option>
              <option value="12">12 pt</option>
              <option value="14">14 pt</option>
              <option value="16">16 pt</option>
              <option value="18">18 pt</option>
              <option value="20">20 pt</option>
              <option value="24">24 pt</option>
              <option value="28">28 pt</option>
              <option value="32">32 pt</option>
            </select>
          </div>
          <div id="propTextRich" class="form-control" contenteditable="true" style="min-height: 130px; white-space: pre-wrap; overflow: auto;"></div>
          <div class="small text-muted mt-1">Tip: highlight specific words and use the inline toolbar above for mixed formatting in one box.</div>
        </div>
        <div class="mb-2">
          <div class="small text-muted mb-1">Click to insert data fields:</div>
          <div class="token-list" id="tokenList"></div>
        </div>
        <div class="mb-2">
          <label class="form-label compact-label">Sample Preview</label>
          <div class="helper-callout" id="samplePreview"></div>
        </div>
        <div class="row g-2">
          <div class="col-6">
            <label class="form-label compact-label">Font Size</label>
            <input id="propFontSize" class="form-control" type="number" min="8" max="80" value="${el.fontSize || 14}">
          </div>
          <div class="col-6">
            <label class="form-label compact-label">Line Spacing</label>
            <input id="propLineSpacing" class="form-control" type="number" min="0.8" max="3" step="0.05" value="${Number(el.lineSpacing || 1.2)}">
          </div>
          <div class="col-6">
            <label class="form-label compact-label">Font Family</label>
            <select id="propFontFamily" class="form-select">
              <option value="Helvetica" ${String(el.fontFamily || "Helvetica") === "Helvetica" ? "selected" : ""}>Sans Serif (Helvetica)</option>
              <option value="Times-Roman" ${String(el.fontFamily || "Helvetica") === "Times-Roman" ? "selected" : ""}>Serif (Times)</option>
              <option value="Courier" ${String(el.fontFamily || "Helvetica") === "Courier" ? "selected" : ""}>Monospace (Courier)</option>
            </select>
          </div>
          <div class="col-6">
            <label class="form-label compact-label">Text Color</label>
            <input id="propColor" class="form-control form-control-color" type="color" value="${el.color || "#111827"}">
          </div>
          <div class="col-6">
            <label class="form-label compact-label">Style</label>
            <div class="btn-group w-100" role="group" aria-label="Text style controls">
              <button id="propBold" class="btn btn-sm ${isBold ? "btn-primary" : "btn-outline-primary"}" type="button"><strong>B</strong></button>
              <button id="propItalic" class="btn btn-sm ${isItalic ? "btn-primary" : "btn-outline-primary"}" type="button"><em>I</em></button>
              <button id="propUnderline" class="btn btn-sm ${isUnderline ? "btn-primary" : "btn-outline-primary"}" type="button"><span style="text-decoration: underline;">U</span></button>
            </div>
          </div>
          <div class="col-12">
            <label class="form-label compact-label">Alignment</label>
            <div class="btn-group w-100" role="group" aria-label="Text alignment">
              <button id="propAlignLeft" class="btn btn-sm ${textAlign === "left" ? "btn-primary" : "btn-outline-primary"}" type="button">Left</button>
              <button id="propAlignCenter" class="btn btn-sm ${textAlign === "center" ? "btn-primary" : "btn-outline-primary"}" type="button">Center</button>
              <button id="propAlignRight" class="btn btn-sm ${textAlign === "right" ? "btn-primary" : "btn-outline-primary"}" type="button">Right</button>
            </div>
          </div>
          <div class="col-12">
            <label class="form-label compact-label">Lock To Element</label>
            <select id="propLockTo" class="form-select">${lockOptions}</select>
          </div>
          <div class="col-6">
            <label class="form-label compact-label">Lock Position</label>
            <select id="propLockMode" class="form-select">
              <option value="below" ${String(el.lockMode || "below") === "below" ? "selected" : ""}>Below Anchor</option>
              <option value="above" ${String(el.lockMode || "below") === "above" ? "selected" : ""}>Above Anchor</option>
              <option value="align_top" ${String(el.lockMode || "below") === "align_top" ? "selected" : ""}>Align Top</option>
              <option value="align_bottom" ${String(el.lockMode || "below") === "align_bottom" ? "selected" : ""}>Align Bottom</option>
            </select>
          </div>
          <div class="col-6">
            <label class="form-label compact-label">Lock Offset</label>
            <input id="propLockOffset" class="form-control" type="number" value="${Number(el.lockOffset || 0)}">
          </div>
        </div>
        <div class="d-grid gap-2 mt-2">
          <button id="duplicateBtn" class="btn btn-outline-primary btn-sm" type="button">Duplicate Element</button>
          <button id="removeBtn" class="btn btn-outline-danger btn-sm" type="button">Delete Element</button>
        </div>
      `;
      const textEditor = document.getElementById("propTextRich");
      const samplePreview = document.getElementById("samplePreview");
      textEditor.innerHTML = tokenizedToDisplayHtml(String(el.richText || plainTextToHtml(el.text || "")));
      textEditor.style.lineHeight = String(Math.max(0.8, Math.min(3.0, Number(el.lineSpacing || 1.2))));
      try { document.execCommand("styleWithCSS", false, false); } catch (_e) {}

      const syncEditorToElement = () => {
        el.richText = displayHtmlToTokenized(textEditor.innerHTML || "");
        el.text = richHtmlToPlain(el.richText);
      };
      const renderSamplePreview = () => {
        const raw = richHtmlToPlain(String(el.richText || plainTextToHtml(el.text || "")));
        samplePreview.textContent = raw.replace(/\{\{\s*([a-z_]+)\s*\}\}/gi, (_m, key) => SAMPLE_VALUES[key] ?? tok(key));
      };
      renderSamplePreview();
      textEditor.addEventListener("input", () => {
        syncEditorToElement();
        renderSamplePreview();
        updateSelectedNodeText();
      });
      textEditor.addEventListener("keyup", syncEditorToElement);
      textEditor.addEventListener("blur", syncEditorToElement);
      document.getElementById("propFontSize").addEventListener("input", (e) => {
        el.fontSize = Number(e.target.value || 14);
        if (typeof el.richText === "string" && el.richText.trim()) {
          el.richText = stripInlineFontSizeStyles(el.richText);
          textEditor.innerHTML = el.richText;
          el.text = richHtmlToPlain(el.richText);
        }
        renderSamplePreview();
        renderCanvas();
      });
      document.getElementById("propLineSpacing").addEventListener("input", (e) => {
        el.lineSpacing = Math.max(0.8, Math.min(3, Number(e.target.value || 1.2)));
        textEditor.style.lineHeight = String(el.lineSpacing);
        renderCanvas();
      });
      document.getElementById("propFontFamily").addEventListener("change", (e) => { el.fontFamily = e.target.value || "Helvetica"; renderCanvas(); });
      document.getElementById("propColor").addEventListener("input", (e) => { el.color = e.target.value; renderCanvas(); });
      document.getElementById("propBold").addEventListener("click", () => {
        const currentlyBold = Number(el.fontWeight || 500) >= 600;
        el.fontWeight = currentlyBold ? 500 : 700;
        renderCanvas();
      });
      document.getElementById("propItalic").addEventListener("click", () => {
        const currentlyItalic = String(el.fontStyle || "normal").toLowerCase() === "italic";
        el.fontStyle = currentlyItalic ? "normal" : "italic";
        renderCanvas();
      });
      document.getElementById("propUnderline").addEventListener("click", () => {
        el.underline = !el.underline;
        renderCanvas();
      });
      document.getElementById("propAlignLeft").addEventListener("click", () => {
        el.textAlign = "left";
        renderCanvas();
      });
      document.getElementById("propAlignCenter").addEventListener("click", () => {
        el.textAlign = "center";
        renderCanvas();
      });
      document.getElementById("propAlignRight").addEventListener("click", () => {
        el.textAlign = "right";
        renderCanvas();
      });
      document.getElementById("propLockTo").addEventListener("change", (e) => {
        el.lockToId = (e.target.value || "").trim() || null;
        if (!el.lockToId) el.lockOffset = 0;
        renderCanvas();
      });
      document.getElementById("propLockMode").addEventListener("change", (e) => {
        el.lockMode = (e.target.value || "below").trim();
        renderCanvas();
      });
      document.getElementById("propLockOffset").addEventListener("input", (e) => {
        el.lockOffset = Number(e.target.value || 0);
        renderCanvas();
      });
      const inlineFontFamily = document.getElementById("inlineFontFamily");
      const inlineFontSize = document.getElementById("inlineFontSize");
      document.getElementById("inlineBold").addEventListener("click", () => {
        textEditor.focus();
        document.execCommand("bold", false, null);
        syncEditorToElement();
        updateSelectedNodeText();
      });
      document.getElementById("inlineItalic").addEventListener("click", () => {
        textEditor.focus();
        document.execCommand("italic", false, null);
        syncEditorToElement();
        updateSelectedNodeText();
      });
      document.getElementById("inlineUnderline").addEventListener("click", () => {
        textEditor.focus();
        document.execCommand("underline", false, null);
        syncEditorToElement();
        updateSelectedNodeText();
      });
      inlineFontFamily.addEventListener("change", () => {
        textEditor.focus();
        document.execCommand("fontName", false, inlineFontFamily.value || "Helvetica");
        syncEditorToElement();
        updateSelectedNodeText();
      });
      inlineFontSize.addEventListener("change", () => {
        const sz = (inlineFontSize.value || "").trim();
        if (!sz) return;
        textEditor.focus();
        const ok = applyInlineSpanStyle(textEditor, { fontSize: `${sz}px` });
        if (!ok) return;
        syncEditorToElement();
        updateSelectedNodeText();
      });
      const tokenList = document.getElementById("tokenList");
      TOKENS.forEach((t) => {
        const b = document.createElement("button");
        b.type = "button";
        b.className = "token-btn";
        b.textContent = tokenLabel(t);
        b.addEventListener("click", () => {
          const tokenHtml = `<span class="builder-token-pill" contenteditable="false" data-token="${t}">${tokenLabel(t)}</span>`;
          textEditor.focus();
          document.execCommand("insertHTML", false, tokenHtml);
          syncEditorToElement();
          renderSamplePreview();
          updateSelectedNodeText();
        });
        tokenList.appendChild(b);
      });
    }
    document.getElementById("duplicateBtn").addEventListener("click", () => {
      duplicateSelected();
    });
    document.getElementById("removeBtn").addEventListener("click", () => {
      deleteSelected();
    });
  }

  function loadTemplate(id) {
    const t = templates.find(x => Number(x.id) === Number(id));
    if (!t) return;
    currentTemplateId = Number(t.id);
    templateName.value = t.name || "";
    state = normalizeDesign(t.design || { canvas: { width: 816, height: 1056, bg: "#fff" }, elements: [] });
    canvasBg.value = state.canvas.bg || "#ffffff";
    selectedId = null;
    renderTemplateList();
    history = [cloneState()];
    historyIndex = 0;
    renderCanvas();
  }

  function resetToBlank(name = "Untitled Template") {
    currentTemplateId = null;
    templateName.value = name;
    state = normalizeDesign({ canvas: { width: 816, height: 1056, bg: "#ffffff" }, elements: [] });
    canvasBg.value = state.canvas.bg || "#ffffff";
    selectedId = null;
    history = [cloneState()];
    historyIndex = 0;
    renderTemplateList();
    renderCanvas();
  }

  function addPreset(type, recordHistory = true) {
    const createText = (opts = {}) => ({
      id: `el_${Date.now()}_${Math.random().toString(16).slice(2, 6)}`,
      type: "text",
      x: opts.x ?? 80,
      y: opts.y ?? 80,
      w: opts.w ?? 260,
      h: opts.h ?? 50,
      text: opts.text ?? "Text",
      fontSize: opts.fontSize ?? 16,
      fontWeight: opts.fontWeight ?? 600,
      fontFamily: opts.fontFamily ?? "Helvetica",
      fontStyle: opts.fontStyle ?? "normal",
      lineSpacing: Number(opts.lineSpacing ?? 1.2),
      textAlign: opts.textAlign ?? "left",
      underline: !!opts.underline,
      autoGrow: !!opts.autoGrow,
      minH: opts.minH ?? (opts.h ?? 50),
      lockToId: opts.lockToId ?? null,
      lockMode: opts.lockMode ?? "below",
      lockOffset: opts.lockOffset ?? 0,
      color: opts.color ?? "#111827",
      fillColor: "transparent",
      borderColor: "transparent",
      radius: 0,
    });
    const createBox = (opts = {}) => ({
      id: `el_${Date.now()}_${Math.random().toString(16).slice(2, 6)}`,
      type: "box",
      x: opts.x ?? 80,
      y: opts.y ?? 80,
      w: opts.w ?? 260,
      h: opts.h ?? 140,
      text: "",
      borderColor: opts.borderColor ?? "#111827",
      fillColor: opts.fillColor ?? "#ffffff",
      radius: opts.radius ?? 8,
      lockToId: opts.lockToId ?? null,
      lockMode: opts.lockMode ?? "below",
      lockOffset: opts.lockOffset ?? 0,
    });
    const createImage = (opts = {}) => ({
      id: `el_${Date.now()}_${Math.random().toString(16).slice(2, 6)}`,
      type: "image",
      x: opts.x ?? 48,
      y: opts.y ?? 40,
      w: opts.w ?? 120,
      h: opts.h ?? 72,
      src: opts.src ?? "{{business_logo}}",
      borderColor: opts.borderColor ?? "#111827",
      fillColor: opts.fillColor ?? "#ffffff",
      radius: opts.radius ?? 4,
      lockToId: opts.lockToId ?? null,
      lockMode: opts.lockMode ?? "below",
      lockOffset: opts.lockOffset ?? 0,
    });
    const addSection = (x, y, w, h, text, textSize = 14) => {
      const box = createBox({ x, y, w, h, borderColor: "#111827", fillColor: "#ffffff", radius: 8 });
      const t = createText({ x: x + 12, y: y + 12, w: w - 24, h: h - 24, text, fontSize: textSize, fontWeight: 600 });
      state.elements.push(box, t);
      selectedId = t.id;
    };
    if (type === "text") {
      const t = createText();
      state.elements.push(t);
      selectedId = t.id;
    } else if (type === "box") {
      const b = createBox();
      state.elements.push(b);
      selectedId = b.id;
    } else if (type === "header") {
      const t1 = createText({ x: 48, y: 36, w: 280, h: 44, text: tok("doc_label"), fontSize: 40, fontWeight: 700 });
      const t2 = createText({
        x: 560,
        y: 44,
        w: 240,
        h: 62,
        text: `Invoice #: ${tok("invoice_number")}\nDate: ${tok("date")}\nDue: ${tok("due_date")}`,
        fontSize: 13,
        fontWeight: 500
      });
      state.elements.push(t1, t2);
      selectedId = t1.id;
    } else if (type === "logo") {
      const img = createImage({ x: 48, y: 40, w: 120, h: 72, src: "{{business_logo}}" });
      state.elements.push(img);
      selectedId = img.id;
    } else if (type === "business") {
      addSection(320, 36, 220, 76, `${tok("business_name")}\n${tok("business_address")}\n${tok("business_phone")}`, 11);
    } else if (type === "bill") {
      addSection(48, 118, 350, 150, `BILL TO\n${tok("customer_name")}\nEmail: ${tok("customer_email")}\nPhone: ${tok("customer_phone")}`, 14);
    } else if (type === "job") {
      addSection(418, 118, 350, 150, `JOB DETAILS\nJob: ${tok("job")}\nRate/Hour: ${tok("rate")}\nTotal Hours: ${tok("hours")}`, 14);
    } else if (type === "labor") {
      const box = createBox({ x: 48, y: 300, w: 720, h: 140, borderColor: "#111827", fillColor: "#ffffff", radius: 8 });
      const t = createText({ x: 62, y: 314, w: 692, h: 112, minH: 112, text: `${tok("labor_table")}`, fontSize: 12, fontWeight: 500, autoGrow: true });
      box.growWithId = t.id;
      box.growDelta = Number(box.h || 0) - Number(t.h || 0);
      state.elements.push(box, t);
      selectedId = t.id;
    } else if (type === "parts") {
      const box = createBox({ x: 48, y: 450, w: 720, h: 150, borderColor: "#111827", fillColor: "#ffffff", radius: 8 });
      const t = createText({ x: 62, y: 464, w: 692, h: 122, minH: 122, text: `${tok("parts_table")}`, fontSize: 12, fontWeight: 500, autoGrow: true });
      box.growWithId = t.id;
      box.growDelta = Number(box.h || 0) - Number(t.h || 0);
      state.elements.push(box, t);
      selectedId = t.id;
    } else if (type === "notes") {
      addSection(48, 780, 430, 160, `NOTES\n${tok("notes_text")}`, 13);
    } else if (type === "summary") {
      addSection(
        500,
        780,
        268,
        180,
        `SUMMARY\nLabor: ${tok("labor_total")}\nParts: ${tok("parts_total")}\nTax: ${tok("tax")}\nTotal: ${tok("total")}\nAmount Due: ${tok("amount_due")}`,
        14
      );
    }
    if (recordHistory) {
      pushHistory("Element added");
      renderCanvas();
    }
  }

  function quickStart(kind) {
    const base = { canvas: { width: 816, height: 1056, bg: "#ffffff" }, elements: [] };
    state = base;
    if (kind === "pdf_like") {
      addPreset("header", false);
      if (ownerHasLogo) addPreset("logo", false);
      addPreset("business", false);
      addPreset("bill", false);
      addPreset("job", false);
      addPreset("labor", false);
      addPreset("parts", false);
      addPreset("notes", false);
      addPreset("summary", false);
    } else if (kind === "minimal") {
      addPreset("header", false);
      if (ownerHasLogo) addPreset("logo", false);
      addPreset("business", false);
      addPreset("bill", false);
      addPreset("summary", false);
    } else if (kind === "service") {
      addPreset("header", false);
      if (ownerHasLogo) addPreset("logo", false);
      addPreset("business", false);
      addPreset("bill", false);
      addPreset("job", false);
      addPreset("labor", false);
      addPreset("parts", false);
      addPreset("notes", false);
      addPreset("summary", false);
    } else {
      addPreset("header", false);
      if (ownerHasLogo) addPreset("logo", false);
      addPreset("business", false);
      addPreset("bill", false);
      addPreset("job", false);
      addPreset("parts", false);
      addPreset("summary", false);
    }
    pushHistory("Quick start loaded");
    renderCanvas();
  }

  function loadExistingLayout(layoutKey) {
    const key = String(layoutKey || "").toLowerCase();
    const PT_TO_CANVAS = 4 / 3;
    const p = (v) => Math.round(Number(v || 0) * PT_TO_CANVAS * 10) / 10;
    const elId = (suffix = "el") => `el_${Date.now()}_${Math.random().toString(16).slice(2, 7)}_${suffix}`;
    const mkText = (opts = {}) => ({
      id: elId("txt"),
      type: "text",
      x: opts.x ?? 60,
      y: opts.y ?? 60,
      w: opts.w ?? 260,
      h: opts.h ?? 40,
      text: opts.text ?? "",
      fontSize: opts.fontSize ?? 12,
      fontWeight: opts.fontWeight ?? 500,
      fontFamily: opts.fontFamily ?? "Helvetica",
      fontStyle: opts.fontStyle ?? "normal",
      lineSpacing: Number(opts.lineSpacing ?? 1.2),
      textAlign: opts.textAlign ?? "left",
      underline: !!opts.underline,
      autoGrow: !!opts.autoGrow,
      minH: opts.minH ?? (opts.h ?? 40),
      lockToId: opts.lockToId ?? null,
      lockMode: opts.lockMode ?? "below",
      lockOffset: opts.lockOffset ?? 0,
      color: opts.color ?? "#111827",
      fillColor: "transparent",
      borderColor: "transparent",
      radius: 0,
    });
    const mkBox = (opts = {}) => ({
      id: elId("box"),
      type: "box",
      x: opts.x ?? 60,
      y: opts.y ?? 60,
      w: opts.w ?? 260,
      h: opts.h ?? 120,
      text: "",
      borderColor: opts.borderColor ?? "#111827",
      fillColor: opts.fillColor ?? "#ffffff",
      radius: opts.radius ?? 8,
      lockToId: opts.lockToId ?? null,
      lockMode: opts.lockMode ?? "below",
      lockOffset: opts.lockOffset ?? 0,
    });
    const mkImage = (opts = {}) => ({
      id: elId("img"),
      type: "image",
      x: opts.x ?? 60,
      y: opts.y ?? 40,
      w: opts.w ?? 100,
      h: opts.h ?? 60,
      src: opts.src ?? "{{business_logo}}",
      borderColor: opts.borderColor ?? "#111827",
      fillColor: opts.fillColor ?? "#ffffff",
      radius: opts.radius ?? 4,
      lockToId: opts.lockToId ?? null,
      lockMode: opts.lockMode ?? "below",
      lockOffset: opts.lockOffset ?? 0,
    });
    const billTextBlock = `BILL TO\n${tok("customer_name")}\nEmail: ${tok("customer_email")}\nPhone: ${tok("customer_phone")}`;
    const jobTextBlock = `JOB DETAILS\nJob: ${tok("job")}\nRate/Hour: ${tok("rate")}\nTotal Hours: ${tok("hours")}`;
    const metaTextBlock = `Invoice #: ${tok("invoice_number")}\nDate: ${tok("date")}\nDue: ${tok("due_date")}`;
    const summaryTextBlock =
      `SUMMARY\nLabor: ${tok("labor_total")}\nParts: ${tok("parts_total")}\nTax: ${tok("tax")}\nTotal: ${tok("total")}\nAmount Due: ${tok("amount_due")}`;
    const businessTextBlock = `${tok("business_name")}\n${tok("business_address")}\n${tok("business_phone")}`;
    const lightBorder = "#e2e8f0";
    const softBg = "#f8fafc";
    const dark = "#0f172a";

    resetToBlank("Untitled Template");
    state.canvas.bg = "#ffffff";
    state.elements = [];

    if (key === "classic") {
      const m = p(46.8);
      const gap = p(25.2);
      const boxW = p((612 - (46.8 * 2) - 25.2) / 2);
      const topY = p(122.4);
      const infoY = topY;
      const bodyTop = p(255.6);
      const billBox = mkBox({ x: m, y: infoY, w: boxW, h: p(97.2), borderColor: "#111827", fillColor: "#ffffff", radius: 8 });
      const jobBox = mkBox({ x: m + boxW + gap, y: infoY, w: boxW, h: p(97.2), borderColor: "#111827", fillColor: "#ffffff", radius: 8 });
      const laborText = mkText({
        x: m, y: bodyTop, w: p(612 - (46.8 * 2)), h: p(94), minH: p(94),
        text: tok("labor_table"), fontSize: 12, fontWeight: 500, autoGrow: true, color: "#111827"
      });
      const partsY = bodyTop + p(131);
      const partsText = mkText({
        x: m, y: partsY, w: p(612 - (46.8 * 2)), h: p(94), minH: p(94),
        text: tok("parts_table"), fontSize: 12, fontWeight: 500, autoGrow: true, color: "#111827"
      });

      state.elements.push(
        mkBox({ x: 0, y: p(73.9), w: 816, h: 1, borderColor: "#cccccc", fillColor: "#cccccc", radius: 0 }),
        billBox,
        jobBox,
        mkBox({ x: m, y: p(555), w: p(270), h: p(150), borderColor: "#111827", fillColor: "#ffffff", radius: 8 }),
        mkBox({ x: p(612 - 46.8 - 180), y: p(555), w: p(180), h: p(160), borderColor: "#111827", fillColor: "#ffffff", radius: 8 }),
        mkText({ x: ownerHasLogo ? p(130) : m, y: p(40), w: p(240), h: p(60), text: businessTextBlock, fontSize: 12, fontWeight: 700, color: "#111827" }),
        mkText({ x: p(612 - 46.8 - 170), y: p(38), w: p(170), h: p(22), text: tok("doc_label"), fontSize: 32, fontWeight: 700, textAlign: "right", color: "#111827" }),
        mkText({ x: p(612 - 46.8 - 220), y: p(82), w: p(220), h: p(60), text: metaTextBlock, fontSize: 13, fontWeight: 500, textAlign: "right", color: "#111827" }),
        mkText({ x: billBox.x + 12, y: billBox.y + 12, w: billBox.w - 24, h: billBox.h - 24, text: billTextBlock, fontSize: 13, fontWeight: 600, color: "#111827" }),
        mkText({ x: jobBox.x + 12, y: jobBox.y + 12, w: jobBox.w - 24, h: jobBox.h - 24, text: jobTextBlock, fontSize: 13, fontWeight: 600, color: "#111827" }),
        laborText,
        mkText({ x: p(612 - 46.8 - 170), y: bodyTop + p(102), w: p(170), h: p(22), text: `Total Labor: ${tok("labor_total")}`, fontSize: 12, fontWeight: 700, textAlign: "right", color: "#111827" }),
        partsText,
        mkText({ x: p(612 - 46.8 - 170), y: partsY + p(102), w: p(170), h: p(22), text: `Total Parts: ${tok("parts_total")}`, fontSize: 12, fontWeight: 700, textAlign: "right", color: "#111827" }),
        mkText({ x: m + 12, y: p(567), w: p(246), h: p(128), text: `NOTES\n${tok("notes_text")}`, fontSize: 13, fontWeight: 600, color: "#111827" }),
        mkText({ x: p(612 - 46.8 - 180) + 12, y: p(567), w: p(156), h: p(136), text: summaryTextBlock, fontSize: 13, fontWeight: 600, color: "#111827" })
      );
      if (ownerHasLogo) {
        state.elements.push(mkImage({ x: m, y: p(40), w: p(72), h: p(36), src: "{{business_logo}}", borderColor: "#111827", fillColor: "#ffffff" }));
      }
      templateName.value = "Classic Layout Starter";
    } else if (key === "modern") {
      const m = p(46.8);
      const boxW = p((612 - (46.8 * 2) - 25.2) / 2);
      const cardH = p(115.2);
      const topY = p(122.4);
      const tableW = p(612 - (46.8 * 2));
      const laborY = p(270);
      const partsY = p(405);
      state.elements.push(
        mkBox({ x: 0, y: 0, w: 816, h: p(97.2), borderColor: dark, fillColor: dark, radius: 0 }),
        mkBox({ x: m, y: topY, w: boxW, h: cardH, borderColor: lightBorder, fillColor: softBg, radius: 10 }),
        mkBox({ x: m + boxW + p(25.2), y: topY, w: boxW, h: cardH, borderColor: lightBorder, fillColor: softBg, radius: 10 }),
        mkBox({ x: m, y: p(525), w: p(612 - (46.8 * 2) - 190), h: p(150), borderColor: lightBorder, fillColor: softBg, radius: 10 }),
        mkBox({ x: p(612 - 46.8 - 180), y: p(525), w: p(180), h: p(160), borderColor: lightBorder, fillColor: softBg, radius: 10 }),
        mkText({ x: ownerHasLogo ? p(130) : m, y: p(44), w: p(250), h: p(60), text: businessTextBlock, fontSize: 11, fontWeight: 600, color: "#ffffff" }),
        mkText({ x: p(612 - 46.8 - 160), y: p(36), w: p(160), h: p(24), text: tok("doc_label"), fontSize: 24, fontWeight: 700, textAlign: "right", color: "#ffffff" }),
        mkText({ x: p(612 - 46.8 - 240), y: p(68), w: p(240), h: p(66), text: metaTextBlock, fontSize: 12, fontWeight: 500, textAlign: "right", color: "#ffffff" }),
        mkText({ x: m + 14, y: topY + 12, w: boxW - 28, h: cardH - 24, text: billTextBlock, fontSize: 12, fontWeight: 600, color: "#111827" }),
        mkText({ x: m + boxW + p(25.2) + 14, y: topY + 12, w: boxW - 28, h: cardH - 24, text: jobTextBlock, fontSize: 12, fontWeight: 600, color: "#111827" })
      );
      const laborText = mkText({
        x: m + 12, y: laborY + 12, w: tableW - 24, h: p(98), minH: p(98),
        text: tok("labor_table"), fontSize: 12, fontWeight: 500, autoGrow: true, color: "#111827"
      });
      const partsText = mkText({
        x: m + 12, y: partsY + 12, w: tableW - 24, h: p(98), minH: p(98),
        text: tok("parts_table"), fontSize: 12, fontWeight: 500, autoGrow: true, color: "#111827"
      });
      state.elements.push(
        laborText,
        mkText({ x: p(612 - 46.8 - 180), y: laborY + p(106), w: p(170), h: p(22), text: `Total Labor: ${tok("labor_total")}`, fontSize: 12, fontWeight: 700, textAlign: "right", color: "#111827" }),
        partsText,
        mkText({ x: p(612 - 46.8 - 180), y: partsY + p(106), w: p(170), h: p(22), text: `Total Parts: ${tok("parts_total")}`, fontSize: 12, fontWeight: 700, textAlign: "right", color: "#111827" }),
        mkText({ x: m + 12, y: p(537), w: p(612 - (46.8 * 2) - 214), h: p(124), text: `NOTES\n${tok("notes_text")}`, fontSize: 12, fontWeight: 600, color: "#111827" }),
        mkText({ x: p(612 - 46.8 - 180) + 12, y: p(537), w: p(156), h: p(136), text: summaryTextBlock, fontSize: 12, fontWeight: 600, color: "#111827" })
      );
      if (ownerHasLogo) {
        state.elements.push(mkImage({ x: m, y: p(34), w: p(78), h: p(38), src: "{{business_logo}}", borderColor: "#ffffff", fillColor: "#ffffff" }));
      }
      templateName.value = "Modern Layout Starter";
    } else if (key === "split_panel") {
      state.canvas.bg = softBg;
      const m = p(39.6);
      const railW = p(111.6);
      const railH = p(792 - (39.6 * 2));
      const contentX = p(39.6 + 111.6 + 32.4);
      const contentW = p(612 - (39.6 + 111.6 + 32.4 + 39.6));
      const cardY = p(136.8);
      const cardH = p(111.6);
      const cardW = p((313.2 - 25.2) / 2);
      const laborY = p(278);
      const partsY = p(413);
      state.elements.push(
        mkBox({ x: m, y: m, w: railW, h: railH, borderColor: dark, fillColor: dark, radius: 14 }),
        mkBox({ x: contentX, y: p(39.6), w: contentW, h: p(72), borderColor: lightBorder, fillColor: softBg, radius: 12 }),
        mkBox({ x: contentX, y: cardY, w: cardW, h: cardH, borderColor: lightBorder, fillColor: "#ffffff", radius: 12 }),
        mkBox({ x: contentX + cardW + p(25.2), y: cardY, w: cardW, h: cardH, borderColor: lightBorder, fillColor: "#ffffff", radius: 12 }),
        mkBox({ x: contentX, y: p(525), w: contentW, h: p(160), borderColor: lightBorder, fillColor: softBg, radius: 12 }),
        mkText({ x: m + 10, y: ownerHasLogo ? p(118) : p(78), w: railW - 20, h: p(120), text: businessTextBlock, fontSize: 10, fontWeight: 700, color: "#e2e8f0" }),
        mkText({ x: m + 10, y: p(525), w: railW - 20, h: p(150), text: summaryTextBlock, fontSize: 10, fontWeight: 600, color: "#e2e8f0" }),
        mkText({ x: contentX + 12, y: p(54), w: p(140), h: p(22), text: tok("doc_label"), fontSize: 18, fontWeight: 700, color: "#111827" }),
        mkText({ x: contentX + contentW - p(220), y: p(52), w: p(208), h: p(52), text: metaTextBlock, fontSize: 10, fontWeight: 500, textAlign: "right", color: "#111827" }),
        mkText({ x: contentX + 12, y: cardY + 10, w: cardW - 24, h: cardH - 20, text: billTextBlock, fontSize: 11, fontWeight: 600, color: "#111827" }),
        mkText({ x: contentX + cardW + p(25.2) + 12, y: cardY + 10, w: cardW - 24, h: cardH - 20, text: jobTextBlock, fontSize: 11, fontWeight: 600, color: "#111827" })
      );
      const laborText = mkText({
        x: contentX + 10, y: laborY + 10, w: contentW - 20, h: p(88), minH: p(88),
        text: tok("labor_table"), fontSize: 11, fontWeight: 500, autoGrow: true, color: "#111827"
      });
      const partsText = mkText({
        x: contentX + 10, y: partsY + 10, w: contentW - 20, h: p(88), minH: p(88),
        text: tok("parts_table"), fontSize: 11, fontWeight: 500, autoGrow: true, color: "#111827"
      });
      state.elements.push(
        laborText,
        mkText({ x: contentX + contentW - p(170), y: laborY + p(96), w: p(160), h: p(20), text: `Total Labor: ${tok("labor_total")}`, fontSize: 11, fontWeight: 700, textAlign: "right", color: "#111827" }),
        partsText,
        mkText({ x: contentX + contentW - p(170), y: partsY + p(96), w: p(160), h: p(20), text: `Total Parts: ${tok("parts_total")}`, fontSize: 11, fontWeight: 700, textAlign: "right", color: "#111827" }),
        mkText({ x: contentX + 12, y: p(537), w: contentW - 24, h: p(136), text: `NOTES\n${tok("notes_text")}`, fontSize: 11, fontWeight: 600, color: "#111827" })
      );
      if (ownerHasLogo) {
        state.elements.push(mkImage({ x: m + 10, y: p(52), w: railW - 20, h: p(48), src: "{{business_logo}}", borderColor: "#ffffff", fillColor: "#ffffff" }));
      }
      templateName.value = "Split Panel Layout Starter";
    } else if (key === "strip") {
      state.canvas.bg = "#ffffff";
      const m = p(50.4);
      const topY = p(139.2);
      const stripY = p(233);
      const stripH = p(39.6);
      const stripW = p(612 - (50.4 * 2));
      const boxW = stripW / 4;
      const laborY = p(319);
      const partsY = p(450);
      state.elements.push(
        mkBox({ x: 0, y: 0, w: 816, h: p(79.2), borderColor: "#ffffff", fillColor: "#ffffff", radius: 0 }),
        mkBox({ x: m, y: p(107), w: p(612 - (50.4 * 2)), h: 1, borderColor: "#e5e7eb", fillColor: "#e5e7eb", radius: 0 }),
        mkBox({ x: m, y: stripY, w: stripW, h: stripH, borderColor: "#0ea5a4", fillColor: "#0ea5a4", radius: 0 }),
        mkBox({ x: m + (2 * boxW), y: stripY, w: boxW * 2, h: stripH, borderColor: dark, fillColor: dark, radius: 0 }),
        mkText({ x: ownerHasLogo ? p(135) : m, y: p(56), w: p(250), h: p(45), text: businessTextBlock, fontSize: 10, fontWeight: 600, color: "#111827" }),
        mkText({ x: p(612 - 50.4 - 210), y: p(56), w: p(210), h: p(22), text: `${tok("doc_label")} ${tok("invoice_number")}`, fontSize: 13, fontWeight: 700, textAlign: "right", color: "#111827" }),
        mkText({ x: p(612 - 50.4 - 190), y: topY, w: p(190), h: p(52), text: `Issue date: ${tok("date")}\nDue: ${tok("due_date")}`, fontSize: 10, fontWeight: 500, color: "#111827" }),
        mkText({ x: m + 6, y: topY, w: p(240), h: p(80), text: billTextBlock, fontSize: 10, fontWeight: 600, color: "#111827" }),
        mkText({ x: m + 10, y: stripY + 8, w: boxW - 12, h: stripH - 16, text: `Invoice No.\n${tok("invoice_number")}`, fontSize: 10, fontWeight: 700, color: "#ffffff" }),
        mkText({ x: m + boxW + 10, y: stripY + 8, w: boxW - 12, h: stripH - 16, text: `Issue date\n${tok("date")}`, fontSize: 10, fontWeight: 700, color: "#ffffff" }),
        mkText({ x: m + (2 * boxW) + 10, y: stripY + 8, w: (boxW * 2) - 14, h: stripH - 16, text: `Total due\n${tok("total")}`, fontSize: 12, fontWeight: 700, color: "#ffffff" })
      );
      const laborText = mkText({
        x: m + 6, y: laborY + 10, w: p(612 - (50.4 * 2)) - 12, h: p(98), minH: p(98),
        text: tok("labor_table"), fontSize: 11, fontWeight: 500, autoGrow: true, color: "#111827"
      });
      const partsText = mkText({
        x: m + 6, y: partsY + 10, w: p(612 - (50.4 * 2)) - 12, h: p(98), minH: p(98),
        text: tok("parts_table"), fontSize: 11, fontWeight: 500, autoGrow: true, color: "#111827"
      });
      state.elements.push(
        laborText,
        mkText({ x: p(612 - 50.4 - 170), y: laborY + p(98), w: p(170), h: p(18), text: `Total Labor: ${tok("labor_total")}`, fontSize: 11, fontWeight: 700, textAlign: "right", color: "#111827" }),
        partsText,
        mkText({ x: p(612 - 50.4 - 170), y: partsY + p(98), w: p(170), h: p(18), text: `Total Parts: ${tok("parts_total")}`, fontSize: 11, fontWeight: 700, textAlign: "right", color: "#111827" }),
        mkBox({ x: m, y: p(560), w: p(240), h: p(120), borderColor: "#e5e7eb", fillColor: "#ffffff", radius: 8 }),
        mkText({ x: m + 10, y: p(572), w: p(220), h: p(96), text: `NOTES\n${tok("notes_text")}`, fontSize: 10, fontWeight: 600, color: "#111827" }),
        mkBox({ x: p(612 - 50.4 - 180), y: p(560), w: p(180), h: p(130), borderColor: "#e5e7eb", fillColor: "#ffffff", radius: 8 }),
        mkText({ x: p(612 - 50.4 - 180) + 10, y: p(572), w: p(160), h: p(110), text: summaryTextBlock, fontSize: 10, fontWeight: 600, color: "#111827" })
      );
      if (ownerHasLogo) {
        state.elements.push(mkImage({ x: m, y: p(50), w: p(70), h: p(32), src: "{{business_logo}}", borderColor: "#111827", fillColor: "#ffffff" }));
      }
      templateName.value = "Invoice Strip Layout Starter";
    } else {
      quickStart("pdf_like");
      templateName.value = "PDF-Like Starter";
    }

    selectedId = state.elements.find((el) => el && el.type === "text")?.id || null;
    history = [cloneState()];
    historyIndex = 0;
    pushHistory("Loaded InvoiceRunner layout starter");
    renderCanvas();
    setStatus("Starter layout loaded. Edit and save when ready.", "ok");
  }

  async function saveTemplate({ asNew = false, activate = false } = {}) {
    const payload = {
      template_id: asNew ? null : currentTemplateId,
      name: (templateName.value || "").trim() || "Untitled Template",
      set_active: !!activate,
      design: state,
    };
    let res;
    let data = null;
    try {
      res = await fetch(saveUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const raw = await res.text();
      try {
        data = JSON.parse(raw || "{}");
      } catch (_e) {
        data = { ok: false, error: `Unexpected server response (${res.status}).` };
      }
    } catch (err) {
      setStatus("Save failed (network error).", "error");
      alert(`Could not save template: ${err?.message || err}`);
      return false;
    }
    if (!res.ok || !data.ok) {
      setStatus("Save failed.", "error");
      alert(data.error || "Failed to save template.");
      return false;
    }
    if (asNew) {
      templates.unshift({ id: data.id, name: data.name, is_active: !!data.is_active, design: JSON.parse(JSON.stringify(state)) });
      currentTemplateId = data.id;
    } else {
      const t = templates.find(x => Number(x.id) === Number(currentTemplateId));
      if (t) {
        t.name = payload.name;
        t.design = JSON.parse(JSON.stringify(state));
      }
    }
    if (activate) {
      templates.forEach(t => t.is_active = Number(t.id) === Number(currentTemplateId));
    }
    renderTemplateList();
    setStatus(`Saved at ${new Date().toLocaleTimeString()}`, "ok");
    return true;
  }

  async function activateTemplate(id) {
    let res;
    let data = null;
    try {
      res = await fetch(`${activateBase}${id}/activate`, { method: "POST" });
      const raw = await res.text();
      try {
        data = JSON.parse(raw || "{}");
      } catch (_e) {
        data = { ok: false, error: `Unexpected server response (${res.status}).` };
      }
    } catch (err) {
      setStatus("Activate failed (network error).", "error");
      alert(`Could not activate template: ${err?.message || err}`);
      return;
    }
    if (!res.ok || !data.ok) {
      setStatus("Activate failed.", "error");
      return alert(data.error || "Failed to activate template.");
    }
    templates.forEach(t => t.is_active = Number(t.id) === Number(id));
    currentTemplateId = Number(id);
    renderTemplateList();
    setStatus("Template is now active.", "ok");
  }

  async function deleteTemplate(id) {
    if (!confirm("Delete this template?")) return;
    const res = await fetch(`${activateBase}${id}/delete`, { method: "POST" });
    const data = await res.json();
    if (!res.ok || !data.ok) return alert(data.error || "Failed to delete template.");
    const idx = templates.findIndex(t => Number(t.id) === Number(id));
    if (idx >= 0) templates.splice(idx, 1);
    if (Number(currentTemplateId) === Number(id)) {
      resetToBlank("Untitled Template");
    } else {
      renderTemplateList();
    }
    if (!templates.length) {
      setStatus("Template deleted. Blank canvas ready.", "ok");
      return;
    }
    renderTemplateList();
  }

  canvas.addEventListener("mousedown", (e) => {
    const node = e.target.closest(".node");
    if (!node) { selectedId = null; renderCanvas(); return; }
    const isResizeHandle = !!e.target.classList?.contains("resize");
    let id = node.dataset.id;
    const clickedType = String(node.dataset.type || "text").toLowerCase();
    if (exactPreviewEnabled) {
      const rect = canvas.getBoundingClientRect();
      const z = Math.max(0.01, Number(zoomPct || 100) / 100);
      const px = (e.clientX - rect.left) / z;
      const py = (e.clientY - rect.top) / z;
      const textHits = state.elements
        .filter((elx) => String(elx.type || "").toLowerCase() !== "box")
        .filter((tx) => {
          const x = Number(tx.x || 0);
          const y = Number(tx.y || 0);
          const w = Number(tx.w || 0);
          const h = Number(tx.h || 0);
          return px >= x && px <= (x + w) && py >= y && py <= (y + h);
        });
      const boxHits = state.elements
        .filter((elx) => String(elx.type || "").toLowerCase() === "box")
        .filter((bx) => {
          const x = Number(bx.x || 0);
          const y = Number(bx.y || 0);
          const w = Number(bx.w || 0);
          const h = Number(bx.h || 0);
          return px >= x && px <= (x + w) && py >= y && py <= (y + h);
        })
        .sort((a, b) => (Number(a.w || 0) * Number(a.h || 0)) - (Number(b.w || 0) * Number(b.h || 0)));

      if (isResizeHandle && selectedId) {
        id = String(selectedId);
      } else if (e.altKey) {
        if (textHits.length) id = String(textHits[textHits.length - 1].id);
        else if (boxHits.length) id = String(boxHits[0].id);
      } else if (clickedType !== "box") {
        if (textHits.length) id = String(textHits[textHits.length - 1].id);
        else if (boxHits.length) id = String(boxHits[0].id);
      } else {
        if (boxHits.length) id = String(boxHits[0].id);
        else if (textHits.length) id = String(textHits[textHits.length - 1].id);
      }
    }
    selectedId = id;
    const el = nodeById(id);
    if (!el) return;
    const startX = e.clientX;
    const startY = e.clientY;
    const originX = Number(el.x || 0);
    const originY = Number(el.y || 0);
    const originW = Number(el.w || 80);
    const originH = Number(el.h || 30);
    const isResize = e.target.classList.contains("resize");
    drag = { id, startX, startY, originX, originY, originW, originH, isResize };
    renderCanvas();
  });

  window.addEventListener("mousemove", (e) => {
    if (!drag) return;
    const el = nodeById(drag.id);
    if (!el) return;
    const dx = e.clientX - drag.startX;
    const dy = e.clientY - drag.startY;
    const roundSnap = (val) => snapEnabled ? Math.round(val / SNAP) * SNAP : Math.round(val);
    if (drag.isResize) {
      el.w = Math.max(30, roundSnap(drag.originW + dx));
      el.h = Math.max(24, roundSnap(drag.originH + dy));
    } else {
      el.x = Math.max(0, Math.min((state.canvas.width || 816) - 20, roundSnap(drag.originX + dx)));
      el.y = Math.max(0, Math.min((state.canvas.height || 1056) - 20, roundSnap(drag.originY + dy)));
    }
    renderCanvas();
  });
  window.addEventListener("mouseup", () => {
    if (drag) pushHistory("Element moved");
    drag = null;
  });

  canvasBg.addEventListener("input", () => {
    state.canvas.bg = canvasBg.value;
    pushHistory("Canvas updated");
    renderCanvas();
  });
  if (showSampleData) {
    showSampleData.addEventListener("change", renderCanvas);
  }
  if (snapToggle) {
    snapToggle.addEventListener("change", () => {
      snapEnabled = !!snapToggle.checked;
      setStatus(snapEnabled ? "Snap enabled" : "Snap disabled", "info");
    });
  }
  if (gridToggle) {
    gridToggle.addEventListener("change", () => {
      showGridEnabled = !!gridToggle.checked;
      renderCanvas();
    });
  }
  if (exactPreviewToggle) {
    exactPreviewToggle.addEventListener("change", () => {
      exactPreviewEnabled = !!exactPreviewToggle.checked;
      if (livePreviewFrame) livePreviewFrame.style.display = exactPreviewEnabled ? "block" : "none";
      renderCanvas();
      if (exactPreviewEnabled) refreshExactPreviewNow();
    });
  }
  if (zoomRange) {
    zoomRange.addEventListener("input", () => {
      zoomPct = Number(zoomRange.value || 100);
      updateZoom();
    });
  }
  if (fitWidthBtn) fitWidthBtn.addEventListener("click", fitWidth);
  if (fitPageBtn) fitPageBtn.addEventListener("click", fitPage);
  if (zoom100Btn) zoom100Btn.addEventListener("click", () => {
    zoomPct = 100;
    updateZoom();
  });
  if (undoBtn) undoBtn.addEventListener("click", undo);
  if (redoBtn) redoBtn.addEventListener("click", redo);
  if (undoBtnTop) undoBtnTop.addEventListener("click", undo);
  if (redoBtnTop) redoBtnTop.addEventListener("click", redo);
  if (duplicateSelectedBtn) duplicateSelectedBtn.addEventListener("click", duplicateSelected);
  if (deleteSelectedBtn) deleteSelectedBtn.addEventListener("click", deleteSelected);
  if (alignLeftBtn) alignLeftBtn.addEventListener("click", () => alignSelected("left"));
  if (alignCenterBtn) alignCenterBtn.addEventListener("click", () => alignSelected("center"));
  if (alignRightBtn) alignRightBtn.addEventListener("click", () => alignSelected("right"));
  if (alignTopBtn) alignTopBtn.addEventListener("click", () => alignSelected("top"));
  if (alignMiddleBtn) alignMiddleBtn.addEventListener("click", () => alignSelected("middle"));
  if (alignBottomBtn) alignBottomBtn.addEventListener("click", () => alignSelected("bottom"));
  if (toggleLeftPanelBtn) {
    toggleLeftPanelBtn.addEventListener("click", () => {
      builderShell?.classList.toggle("left-collapsed");
      setTimeout(fitWidth, 0);
    });
  }
  if (toggleRightPanelBtn) {
    toggleRightPanelBtn.addEventListener("click", () => {
      builderShell?.classList.toggle("right-collapsed");
      setTimeout(fitWidth, 0);
    });
  }
  if (previewOffsetXInput) {
    previewOffsetXInput.addEventListener("input", () => {
      previewOffsetX = Number(previewOffsetXInput.value || 0);
      applyPreviewOffset();
    });
  }
  if (previewOffsetYInput) {
    previewOffsetYInput.addEventListener("input", () => {
      previewOffsetY = Number(previewOffsetYInput.value || 0);
      applyPreviewOffset();
    });
  }
  if (previewScaleInput) {
    previewScaleInput.addEventListener("input", () => {
      previewScale = Number(previewScaleInput.value || 1);
      applyPreviewOffset();
    });
  }
  if (autoAlignPreviewBtn) {
    autoAlignPreviewBtn.addEventListener("click", autoAlignPreview);
  }

  document.querySelectorAll("[data-add]").forEach(btn => {
    btn.addEventListener("click", () => addPreset(btn.dataset.add));
  });
  document.querySelectorAll("[data-quick]").forEach(btn => {
    btn.addEventListener("click", () => quickStart(btn.dataset.quick));
  });
  document.querySelectorAll("[data-layout]").forEach(btn => {
    btn.addEventListener("click", () => loadExistingLayout(btn.dataset.layout));
  });

  templateList.addEventListener("click", (e) => {
    const load = e.target.getAttribute("data-load");
    const activate = e.target.getAttribute("data-activate");
    const del = e.target.getAttribute("data-delete");
    if (load) return loadTemplate(Number(load));
    if (activate) return activateTemplate(Number(activate));
    if (del) return deleteTemplate(Number(del));
  });

  saveAsNewBtn.addEventListener("click", async () => {
    setStatus("Saving as new template...");
    await saveTemplate({ asNew: true, activate: false });
  });
  if (newBlankBtn) {
    newBlankBtn.addEventListener("click", () => {
      resetToBlank("Untitled Template");
      setStatus("Blank template ready. Build and save when ready.", "ok");
    });
  }
  saveActiveBtn.addEventListener("click", async () => {
    setStatus("Saving current template...");
    await saveTemplate({ asNew: false, activate: false });
  });
  setActiveBtn.addEventListener("click", async () => {
    if (!currentTemplateId) {
      alert("Please load a template first.");
      return;
    }
    const ok = await saveTemplate({ asNew: false, activate: false });
    if (!ok) return;
    await activateTemplate(Number(currentTemplateId));
  });

  window.addEventListener("keydown", (e) => {
    const mod = e.metaKey || e.ctrlKey;
    if (mod && e.key.toLowerCase() === "z") {
      e.preventDefault();
      if (e.shiftKey) redo(); else undo();
      return;
    }
    if (mod && e.key.toLowerCase() === "d") {
      if (isTypingContext()) return;
      e.preventDefault();
      duplicateSelected();
      return;
    }
    if (isTypingContext()) return;
    const el = nodeById(selectedId);
    if (!el) return;
    const step = e.shiftKey ? 10 : 1;
    if (e.key === "Delete" || e.key === "Backspace") {
      e.preventDefault();
      deleteSelected();
      return;
    }
    if (e.key === "ArrowLeft") { e.preventDefault(); el.x = Math.max(0, Number(el.x || 0) - step); renderCanvas(); pushHistory("Nudge"); }
    if (e.key === "ArrowRight") { e.preventDefault(); el.x = Math.min((state.canvas.width || 816) - 20, Number(el.x || 0) + step); renderCanvas(); pushHistory("Nudge"); }
    if (e.key === "ArrowUp") { e.preventDefault(); el.y = Math.max(0, Number(el.y || 0) - step); renderCanvas(); pushHistory("Nudge"); }
    if (e.key === "ArrowDown") { e.preventDefault(); el.y = Math.min((state.canvas.height || 1056) - 20, Number(el.y || 0) + step); renderCanvas(); pushHistory("Nudge"); }
  });

  renderTemplateList();
  loadPreviewOffsetDefaults();
  loadTemplate(currentTemplateId);
  fitPage();
  refreshExactPreviewNow();
  if (!templates || !templates.length) {
    quickStart("pdf_like");
  }
})();
</script>
{% endblock %}
