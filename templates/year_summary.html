{% extends "base.html" %}
{% set title = "Financial Summary" %}

{% block content %}
<div class="page-header">
  <div>
    <h1 class="h3 fw-bold mb-1">Financial Summary</h1>
    <div class="small-muted">Totals for invoices where “Date” falls within the selected range.</div>
  </div>
</div>

<form class="card shadow-sm mb-3" method="get" action="{{ url_for('year_summary') }}">
  <div class="card-body">
    <div class="row g-2 align-items-end">
      <div class="col-6 col-md-3">
        <label class="form-label">Month (optional)</label>
        <select class="form-select" name="month">
          <option value="" {% if not month %}selected{% endif %}>Year Summary</option>
          {% for m in range(1, 13) %}
            <option value="{{ m }}" {% if month and month|int == m %}selected{% endif %}>
              {{ ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][m-1] }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-6 col-md-3">
        <label class="form-label">Year (e.g. 2025)</label>
        <input class="form-control" name="year" value="{{ year }}" />
      </div>
      <div class="col-12 col-md-3 d-grid">
        <button class="btn btn-dark" type="submit">Calculate</button>
      </div>
      <div class="col-12 col-md-3 text-md-end">
        <a class="btn btn-outline-secondary" href="{{ url_for('pdfs_download_all', year=year, month=month) }}">
          Download PDFs (ZIP) for {{ month and (["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][month|int-1] ~ " ") or "" }}{{ year }}
        </a>
      </div>
    </div>
  </div>
</form>

<div class="card shadow-sm mb-3">
  <div class="card-body">
    <div class="row g-2">
      <div class="col-12 col-md-6">
        <div class="small-muted">Invoices included</div>
        <div class="h5 fw-bold mb-0">{{ count }}</div>
      </div>
      <div class="col-12 col-md-6">
        <div class="small-muted">Total Invoice Amount (expenses + supplies + income)</div>
        <div class="h5 fw-bold mb-0">{{ money(total_invoice_amount) }}</div>
      </div>

      <div class="col-12"><hr class="my-2"></div>

      <div class="col-6 col-md-3">
        <div class="small-muted">Total Invoiced Profit</div>
        <div class="fw-semibold">{{ money(total_labor) }}</div>
      </div>
      <div class="col-6 col-md-3">
        <div class="small-muted">Parts Markup Profit</div>
        <div class="fw-semibold">{{ money(total_parts_markup_profit) }}</div>
      </div>
      <div class="col-6 col-md-3">
        <div class="small-muted">Total Supplies</div>
        <div class="fw-semibold">{{ money(total_supplies) }}</div>
      </div>
      <div class="col-6 col-md-3">
        <div class="small-muted">Total Taxes Collected</div>
        <div class="fw-semibold">{{ money(total_tax_collected) }}</div>
      </div>
      <div class="col-6 col-md-3">
        <div class="small-muted">Total Invoiced Expenses</div>
        <div class="fw-semibold">{{ money(total_invoice_amount - total_labor) }}</div>
      </div>
      <div class="col-6 col-md-3">
        <div class="small-muted">
          {% if pro_features_enabled %}
            Total Paid Invoices (incl. Late Fees)
          {% else %}
            Total Paid Invoices
          {% endif %}
        </div>
        <div class="fw-semibold">{{ money(total_paid_invoices_amount) }}</div>
      </div>
      {% if pro_features_enabled %}
        <div class="col-6 col-md-3">
          <div class="small-muted">Late Fee Income (Paid Invoices)</div>
          <div class="fw-semibold">{{ money(total_late_fee_income) }}</div>
        </div>
      {% endif %}

      <div class="col-12"><hr class="my-2"></div>

      <div class="col-6 col-md-6">
        <div class="small-muted">Total Outstanding (Unpaid)</div>
        <div class="fw-semibold text-warning">{{ money(total_outstanding_unpaid) }}</div>
      </div>
      <div class="col-6 col-md-6">
        <div class="small-muted">Unpaid invoices</div>
        <div class="fw-semibold">{{ unpaid_count }}</div>
      </div>
      <div class="col-6 col-md-6">
        <div class="small-muted">Total Expenses</div>
        <div class="fw-semibold">{{ money(total_parts + total_supplies) }}</div>
      </div>
      <div class="col-6 col-md-6">
        <div class="small-muted">Total Paid Labor Income</div>
        <div class="fw-bold">{{ money(profit_paid_labor_only) }}</div>
      </div>

      <div class="col-6 col-md-6">
        <div class="small-muted">Total Business Expenses</div>
        <div class="fw-semibold">{{ money(total_business_expenses) }}</div>
        <a class="btn btn-sm btn-outline-primary mt-2" href="{{ url_for('profit_loss', year=year, month=month) }}">
          Show Breakdown
        </a>
      </div>

    </div>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <h2 class="h5 fw-bold mb-2">Unpaid invoices</h2>
    {% if unpaid %}
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Invoice #</th>
              <th>Name</th>
              <th>Vehicle</th>
              <th>Date</th>
              <th class="text-end">Outstanding</th>
              <th class="text-end">Open</th>
            </tr>
          </thead>
          <tbody>
            {% for u in unpaid %}
              <tr>
                <td class="mono fw-semibold">{{ u.display_number or u.invoice_number }}</td>
                <td>{{ u.name }}</td>
                <td>{{ u.vehicle }}</td>
                <td>{{ u.date_in }}</td>
                <td class="text-end">{{ money(u.outstanding) }}</td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-primary" href="{{ url_for('invoice_view', invoice_id=u.id) }}">Open</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="small-muted">No unpaid invoices found for {{ month and (["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][month|int-1] ~ " ") or "" }}{{ year }}.</div>
    {% endif %}
  </div>
</div>
{% endblock %}
