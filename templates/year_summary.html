{% extends "base.html" %}
{% set title = "Financial Summary" %}

{% block content %}
<div class="page-header">
  <div>
    <h1 class="h3 fw-bold mb-1">Financial Summary</h1>
    <div class="small-muted">Totals for invoices where “Date” falls within the selected range.</div>
  </div>
</div>

<form class="card shadow-sm mb-3" method="get" action="{{ url_for('year_summary') }}">
  <div class="card-body">
    <div class="row g-2 align-items-end">
      <div class="col-6 col-md-3">
        <label class="form-label">Month (optional)</label>
        <select class="form-select" name="month">
          <option value="" {% if not month %}selected{% endif %}>Year Summary</option>
          {% for m in range(1, 13) %}
            <option value="{{ m }}" {% if month and month|int == m %}selected{% endif %}>
              {{ ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][m-1] }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-6 col-md-3">
        <label class="form-label">Year (ex. 2025)</label>
        <input class="form-control" name="year" value="{{ year }}" />
      </div>
      <div class="col-12 col-md-3 d-grid">
        <button class="btn btn-dark" type="submit">Calculate</button>
      </div>
      <div class="col-12 col-md-3 text-md-end">
        <a class="btn btn-outline-secondary" href="{{ url_for('pdfs_download_all', year=year, month=month) }}">
          Download PDFs (ZIP) for {{ month and (["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][month|int-1] ~ " ") or "" }}{{ year }}
        </a>
      </div>
    </div>
  </div>
</form>

<div class="card shadow-sm mb-3">
  <div class="card-body">
    <div class="row g-2">
      <div class="col-12 col-md-6">
        <div class="small-muted">Invoices included</div>
        <div class="h5 fw-bold mb-0">{{ count }}</div>
      </div>
      <div class="col-12 col-md-6">
        <div class="small-muted">Total Invoice Amount (expenses + supplies + income)</div>
        <div class="h5 fw-bold mb-0">{{ money(total_invoice_amount) }}</div>
      </div>

      <div class="col-12"><hr class="my-2"></div>

      <div class="col-6 col-md-3">
        <div class="small-muted">Total Invoiced Profit</div>
        <div class="fw-semibold">{{ money(total_labor) }}</div>
      </div>
      <div class="col-6 col-md-3">
        <div class="small-muted">Parts Markup Profit</div>
        <div class="fw-semibold">{{ money(total_parts_markup_profit) }}</div>
      </div>
      <div class="col-6 col-md-3">
        <div class="small-muted">Total Supplies</div>
        <div class="fw-semibold">{{ money(total_supplies) }}</div>
      </div>
      <div class="col-6 col-md-3">
        <div class="small-muted">Total Taxes Collected</div>
        <div class="fw-semibold">{{ money(total_tax_collected) }}</div>
      </div>
      <div class="col-6 col-md-3">
        <div class="small-muted">Total Invoiced Expenses</div>
        <div class="fw-semibold">{{ money(total_invoice_amount - total_labor) }}</div>
      </div>
      <div class="col-6 col-md-3">
        <div class="small-muted">
          {% if pro_features_enabled %}
            Total Paid Invoices (incl. Late Fees)
          {% else %}
            Total Paid Invoices
          {% endif %}
        </div>
        <div class="fw-semibold">{{ money(total_paid_invoices_amount) }}</div>
      </div>
      {% if pro_features_enabled %}
        <div class="col-6 col-md-3">
          <div class="small-muted">Late Fee Income (Paid Invoices)</div>
          <div class="fw-semibold">{{ money(total_late_fee_income) }}</div>
        </div>
        <div class="col-6 col-md-3">
          <div class="small-muted">Stripe Credit Card Processing Fee (Client-Paid)</div>
          <div class="fw-semibold">{{ money(total_stripe_processing_fees) }}</div>
          <div class="small-muted mt-1">
            These fees are not collected by you, they go straight to Stripe. This is just for visual reference.
          </div>
        </div>
      {% endif %}

      <div class="col-12"><hr class="my-2"></div>

      <div class="col-6 col-md-6">
        <div class="small-muted">Total Outstanding (Unpaid)</div>
        <div class="fw-semibold text-warning">{{ money(total_outstanding_unpaid) }}</div>
      </div>
      <div class="col-6 col-md-6">
        <div class="small-muted">Unpaid invoices</div>
        <div class="fw-semibold">{{ unpaid_count }}</div>
      </div>
      <div class="col-6 col-md-6">
        <div class="small-muted">Total Expenses</div>
        <div class="fw-semibold">{{ money(total_parts + total_supplies) }}</div>
      </div>
      <div class="col-6 col-md-6">
        <div class="small-muted">Total Paid Labor Income</div>
        <div class="fw-bold">{{ money(profit_paid_labor_only) }}</div>
      </div>

      <div class="col-6 col-md-6">
        <div class="small-muted">Total Business Expenses</div>
        <div class="fw-semibold">{{ money(total_business_expenses) }}</div>
        <a class="btn btn-sm btn-outline-primary mt-2" href="{{ url_for('profit_loss', year=year, month=month) }}">
          Show Breakdown
        </a>
      </div>
      <div class="col-6 col-md-6">
        <div class="small-muted">Other Income (Manual)</div>
        <div class="fw-semibold text-success">{{ money(total_other_income) }}</div>
      </div>
      <div class="col-6 col-md-6">
        <div class="small-muted">Interest Income (Manual)</div>
        <div class="fw-semibold text-success">{{ money(total_interest_income) }}</div>
      </div>
      <div class="col-6 col-md-6">
        <div class="small-muted">Total Income (Paid Invoices + Other Income + Interest Income)</div>
        <div class="fw-bold text-success">{{ money(total_income_with_manual) }}</div>
      </div>

    </div>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <h2 class="h5 fw-bold mb-2">Unpaid invoices</h2>
    {% if unpaid %}
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Invoice #</th>
              <th>Name</th>
              <th>Vehicle</th>
              <th>Date</th>
              <th class="text-end">Outstanding</th>
              <th class="text-end">Open</th>
            </tr>
          </thead>
          <tbody>
            {% for u in unpaid %}
              <tr>
                <td class="mono fw-semibold">{{ u.display_number or u.invoice_number }}</td>
                <td>{{ u.name }}</td>
                <td>{{ u.vehicle }}</td>
                <td>{{ u.date_in }}</td>
                <td class="text-end">{{ money(u.outstanding) }}</td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-primary" href="{{ url_for('invoice_view', invoice_id=u.id) }}">Open</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="small-muted">No unpaid invoices found for {{ month and (["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][month|int-1] ~ " ") or "" }}{{ year }}.</div>
    {% endif %}
  </div>
</div>

<div class="card shadow-sm mt-3 mb-3">
  <div class="card-body">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-2">
      <h2 class="h5 fw-bold mb-0">Income & Expense Charts</h2>
      <div class="btn-group btn-group-sm" role="group" aria-label="Chart period">
        <button type="button" class="btn btn-outline-primary active" data-chart-scope="daily">Daily</button>
        <button type="button" class="btn btn-outline-primary" data-chart-scope="monthly">Monthly</button>
        <button type="button" class="btn btn-outline-primary" data-chart-scope="yearly">Yearly</button>
      </div>
    </div>
    <div class="small-muted mb-3">
      Compare paid income, invoiced totals, expenses, and outstanding balances.
      <span id="chartScopeLabel" class="fw-semibold"></span>
    </div>

    <div class="row g-3">
      <div class="col-12 col-xl-8">
        <div class="border rounded p-2 bg-white">
          <canvas id="incomeExpenseTrendChart" height="180"></canvas>
        </div>
      </div>
      <div class="col-12 col-xl-4">
        <div class="border rounded p-2 bg-white">
          <canvas id="expenseBreakdownChart" height="180"></canvas>
        </div>
      </div>
      <div class="col-12">
        <div class="border rounded p-2 bg-white">
          <canvas id="invoicedOutstandingChart" height="145"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  (function () {
    const chartData = {{ chart_data|tojson }};
    const scopeButtons = document.querySelectorAll("[data-chart-scope]");
    const scopeLabel = document.getElementById("chartScopeLabel");

    function money(v) {
      const n = Number(v || 0);
      return new Intl.NumberFormat("en-US", { style: "currency", currency: "USD" }).format(n);
    }

    function scopeNet(scope) {
      const income = scope.paid_income || [];
      const expenses = scope.expenses || [];
      return income.map((v, i) => Number(v || 0) - Number(expenses[i] || 0));
    }

    const trendCtx = document.getElementById("incomeExpenseTrendChart");
    const barsCtx = document.getElementById("invoicedOutstandingChart");
    const expenseCtx = document.getElementById("expenseBreakdownChart");
    if (!trendCtx || !barsCtx || !expenseCtx || !window.Chart) return;

    const trendChart = new Chart(trendCtx, {
      type: "line",
      data: {
        labels: [],
        datasets: [
          { label: "Paid Income", data: [], borderColor: "#0f766e", backgroundColor: "rgba(15,118,110,0.15)", tension: 0.25, fill: true },
          { label: "Expenses", data: [], borderColor: "#b45309", backgroundColor: "rgba(180,83,9,0.12)", tension: 0.25, fill: true },
          { label: "Net", data: [], borderColor: "#1d4ed8", backgroundColor: "rgba(29,78,216,0.1)", tension: 0.25, fill: false },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${money(ctx.parsed.y)}` } },
          legend: { position: "top" },
        },
        scales: { y: { ticks: { callback: (v) => money(v) } } },
      },
    });

    const invoicedOutstandingChart = new Chart(barsCtx, {
      type: "bar",
      data: {
        labels: [],
        datasets: [
          { label: "Invoiced Total", data: [], backgroundColor: "rgba(29,78,216,0.65)", borderColor: "#1d4ed8", borderWidth: 1 },
          { label: "Outstanding", data: [], backgroundColor: "rgba(217,119,6,0.65)", borderColor: "#d97706", borderWidth: 1 },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${money(ctx.parsed.y)}` } },
          legend: { position: "top" },
        },
        scales: { y: { ticks: { callback: (v) => money(v) } } },
      },
    });

    const expenseBreakdownChart = new Chart(expenseCtx, {
      type: "doughnut",
      data: {
        labels: chartData.expense_breakdown.labels || ["No expense data"],
        datasets: [{
          data: (chartData.expense_breakdown.values && chartData.expense_breakdown.values.length)
            ? chartData.expense_breakdown.values
            : [1],
          backgroundColor: (chartData.expense_breakdown.values && chartData.expense_breakdown.values.length)
            ? ["#1d4ed8", "#0f766e", "#b45309", "#7c3aed", "#dc2626", "#0891b2", "#65a30d", "#374151"]
            : ["#cbd5e1"],
        }],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: "bottom" },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const v = Number(ctx.parsed || 0);
                if (!(chartData.expense_breakdown.values && chartData.expense_breakdown.values.length)) {
                  return "No expense data";
                }
                return `${ctx.label}: ${money(v)}`;
              },
            },
          },
        },
      },
    });

    function setScope(scopeKey) {
      const scope = chartData[scopeKey] || chartData.monthly;
      scopeButtons.forEach((btn) => {
        btn.classList.toggle("active", btn.dataset.chartScope === scopeKey);
      });
      scopeLabel.textContent = `(${scope.scope_label || ""})`;

      trendChart.data.labels = scope.labels || [];
      trendChart.data.datasets[0].data = scope.paid_income || [];
      trendChart.data.datasets[1].data = scope.expenses || [];
      trendChart.data.datasets[2].data = scopeNet(scope);
      trendChart.update();

      invoicedOutstandingChart.data.labels = scope.labels || [];
      invoicedOutstandingChart.data.datasets[0].data = scope.invoiced || [];
      invoicedOutstandingChart.data.datasets[1].data = scope.outstanding || [];
      invoicedOutstandingChart.update();
    }

    scopeButtons.forEach((btn) => {
      btn.addEventListener("click", () => setScope(btn.dataset.chartScope || "monthly"));
    });
    setScope("daily");
  })();
</script>
{% endblock %}
