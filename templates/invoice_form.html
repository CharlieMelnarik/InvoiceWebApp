{% extends "base.html" %}
{% set doc_type = doc_type if doc_type is defined and doc_type else "invoice" %}
{% set title = ("New Estimate" if mode == "new" else "Edit Estimate") if doc_type == "estimate" else ("New Invoice" if mode == "new" else "Edit Invoice") %}

{% block content %}

{% set _tmpl = tmpl if tmpl is defined and tmpl else {} %}
{% set tmpl_key = (tmpl_key if tmpl_key is defined and tmpl_key else "auto_repair") %}

{% set job_label = _tmpl.get('job_label', 'Vehicle') %}
{% set labor_title = _tmpl.get('labor_title', 'Labor') %}
{% set labor_desc_label = _tmpl.get('labor_desc_label', 'Labor Description') %}
{% set parts_title = _tmpl.get('parts_title', 'Parts') %}
{% set parts_name_label = _tmpl.get('parts_name_label', 'Part Name') %}
{% set shop_supplies_label = _tmpl.get('shop_supplies_label', 'Shop Supplies') %}

{% set job_placeholder = _tmpl.get('job_placeholder', '') %}
{% set part_placeholder = _tmpl.get('parts_placeholder', 'e.g. Item') %}
{% set labor_placeholder = _tmpl.get('labor_placeholder', 'e.g. Service performed') %}

{% if mode == "edit" %}
  {% set _cust_id = (inv.customer_id|string) %}
  {% set _cust_name = (inv.name or "") %}
{% else %}
  {% set _cust_id = (form.customer_id if form else "") %}
  {% set _cust_name = (form.customer_name if form else "") %}
  {% if (not _cust_id and not _cust_name) and pre_customer is defined and pre_customer %}
    {% set _cust_id = (pre_customer.id|string) %}
    {% set _cust_name = (pre_customer.name or "") %}
  {% endif %}
{% endif %}

<div class="page-header">
  <div>
    <h1 class="h3 fw-bold mb-1">
      {% if doc_type == "estimate" %}
        {% if mode == "new" %}New Estimate{% else %}Edit Estimate{% endif %}
      {% else %}
        {% if mode == "new" %}New Invoice{% else %}Edit Invoice{% endif %}
      {% endif %}
    </h1>
    <div class="subtitle">
      {% if mode == "new" %}
        Creates a new {{ "estimate" if doc_type == "estimate" else "invoice" }} number automatically.
      {% else %}
        Editing {{ "estimate" if doc_type == "estimate" else "invoice" }} <span class="mono">{{ inv.display_number or inv.invoice_number }}</span>
      {% endif %}
    </div>
  </div>
  <div class="action-group">
    <a class="btn btn-outline-secondary" href="{{ url_for('customers_list') }}">Customers</a>
    <a class="btn btn-outline-secondary"
       href="{{ url_for('estimates') if doc_type == 'estimate' else url_for('invoices') }}">
      {{ "All Estimates" if doc_type == "estimate" else "Invoices" }}
    </a>
  </div>
</div>

{# JS customer data (id/name/email/phone) #}
<script>
  const CUSTOMERS = {{ (customers_for_js if customers_for_js is defined else [])|tojson|safe }};
</script>

<form method="post" class="card shadow-sm" id="invoiceForm">
  <input type="hidden" id="clientTzOffsetMinutes" name="client_tz_offset_minutes" value="">
  <div class="card-body">

    <div class="row g-3">

      <!-- Customer selection: type-to-search -->
      <div class="col-12 col-md-6">
        <label class="form-label req">Customer</label>

        <input
          class="form-control"
          id="customer_name"
          name="customer_name"
          list="customers_datalist"
          value="{{ _cust_name }}"
          placeholder="Start typing a customer name…"
          autocomplete="off"
          required
        />

        <input type="hidden" id="customer_id" name="customer_id" value="{{ _cust_id }}">

        <datalist id="customers_datalist">
          {% for c in customers %}
            <option value="{{ c.name }}" data-id="{{ c.id }}"></option>
          {% endfor %}
        </datalist>

        <div class="small-muted mt-1">
          Need a new customer? <a href="{{ url_for('customer_new') }}">Create one</a>.
        </div>
      </div>

      <!-- Job / Vehicle -->
      <div class="col-12 col-md-6">
        <label class="form-label {% if tmpl_key=='auto_repair' %}req{% endif %}">{{ job_label }}</label>
        <input class="form-control" name="vehicle"
               {% if tmpl_key=='auto_repair' %}required{% endif %}
               placeholder="{{ job_placeholder }}"
               value="{% if mode=='edit' %}{{ inv.vehicle }}{% else %}{{ (form.vehicle if form else '') }}{% endif %}">
      </div>

      <!-- Customer contact (invoice-level override) -->
      <div class="col-12 col-md-6">
        <label class="form-label">Customer Email (override)</label>
        <input class="form-control" type="email" id="customer_email" name="customer_email"
               value="{% if mode=='edit' %}{{ inv.customer_email or '' }}{% else %}{{ (form.customer_email if form else '') }}{% endif %}"
               placeholder="customer@example.com">
        <div class="small-muted mt-1">If blank, we’ll use the customer profile email automatically.</div>
      </div>

      <div class="col-12 col-md-6">
        <label class="form-label">Customer Phone (override)</label>
        <input class="form-control" id="customer_phone" name="customer_phone"
               value="{% if mode=='edit' %}{{ format_phone(inv.customer_phone) }}{% else %}{{ (form.customer_phone if form else '') }}{% endif %}"
               placeholder="(406) 555-1234">
        <div class="small-muted mt-1">If blank, we’ll use the customer profile phone automatically.</div>
      </div>

      {% if tmpl_key == "flipping_items" %}
        <div class="col-12 col-md-6">
          <label class="form-label">Profit</label>
          <div class="small-muted">
            Profit is calculated as <span class="mono">Sold for - Costs - Other Expenses</span>.
          </div>
        </div>
        <input type="hidden" name="price_per_hour" value="1">
        <input type="hidden" name="hours" value="0">
      {% else %}
        <div class="col-6 col-md-3">
          <label class="form-label">Hours (Total)</label>
          <input class="form-control" id="laborHoursTotal" inputmode="decimal" disabled>
          <input type="hidden" name="hours" id="laborHoursHidden"
                 value="{% if mode=='edit' %}{{ inv.hours }}{% else %}{{ (form.hours if form else '') }}{% endif %}">
          <div class="small-muted mt-1">Calculated from labor line items.</div>
        </div>
        <div class="col-6 col-md-3">
          <label class="form-label">Rate / Hour</label>
          <input class="form-control" name="price_per_hour" inputmode="decimal"
                 value="{% if mode=='edit' %}{{ inv.price_per_hour }}{% else %}{{ (form.price_per_hour if form else (user_default_hourly_rate if user_default_hourly_rate is defined else '')) }}{% endif %}">
        </div>
      {% endif %}

      <div class="col-6 col-md-3">
        <label class="form-label">{{ shop_supplies_label }}</label>
        <input class="form-control" name="shop_supplies" inputmode="decimal"
               value="{% if mode=='edit' %}{{ inv.shop_supplies }}{% else %}{{ (form.shop_supplies if form else '0') }}{% endif %}">
      </div>

      <div class="col-6 col-md-3">
        <label class="form-label">Parts Markup (%)</label>
        <input class="form-control" name="parts_markup_percent" inputmode="decimal"
               value="{% if mode=='edit' %}{{ inv.parts_markup_percent }}{% else %}{{ (form.parts_markup_percent if form else (user_default_parts_markup if user_default_parts_markup is defined else '0')) }}{% endif %}">
        <div class="small-muted mt-1">Applies to each part price (shown on web only).</div>
      </div>

      <div class="col-6 col-md-3">
        <label class="form-label">Tax (%)</label>
        <input class="form-control" name="tax_rate" inputmode="decimal"
               value="{% if mode=='edit' %}{{ inv.tax_rate if inv.tax_rate is not none else '0' }}{% else %}{{ (form.tax_rate if form else (user_tax_rate if user_tax_rate is defined else '0')) }}{% endif %}">
      </div>

      {% if doc_type != "estimate" %}
        <div class="col-6 col-md-3">
          <label class="form-label">
            {% if tmpl_key == "flipping_items" %}Sold for{% else %}Paid{% endif %}
          </label>
          <input class="form-control" name="paid" inputmode="decimal"
                 value="{% if mode=='edit' %}{{ inv.paid }}{% else %}{{ (form.paid if form else '0') }}{% endif %}">
        </div>
      {% endif %}

      <div class="col-12 col-md-4">
        <label class="form-label">Date In (text)</label>
        <input class="form-control" id="dateInInput" name="date_in"
               data-initial-default="{% if mode=='new' %}{{ (form.date_in if form else default_date) }}{% endif %}"
               value="{% if mode=='edit' %}{{ inv.date_in }}{% else %}{{ (form.date_in if form else default_date) }}{% endif %}">
      </div>

    </div>

    <hr class="my-4">

    <!-- Parts / Materials -->
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h5 fw-bold mb-0">{{ parts_title }}</h2>
      <div class="d-flex gap-2">
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addPartRow()">
          Add Item
        </button>
        <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#receiptModal">
          Scan Receipt
        </button>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-sm align-middle" id="partsTable">
        <thead class="table-light">
          <tr>
            <th style="min-width: 280px;">{{ parts_name_label }}</th>
            <th style="width: 160px;">Price</th>
            <th style="width: 80px;"></th>
          </tr>
        </thead>
        <tbody>
          {% if mode == "edit" %}
            {% for p in inv.parts %}
              <tr>
                <td><input class="form-control" name="part_name" value="{{ p.part_name }}"></td>
                <td><input class="form-control" name="part_price" inputmode="decimal" value="{{ p.part_price }}"></td>
                <td class="text-end">
                  <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">Remove</button>
                </td>
              </tr>
            {% endfor %}
          {% endif %}

          <tr>
            <td><input class="form-control" name="part_name" placeholder="{{ part_placeholder }}"></td>
            <td><input class="form-control" name="part_price" inputmode="decimal" placeholder="0.00"></td>
            <td class="text-end">
              <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">Remove</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <hr class="my-4">

    <!-- Labor / Services -->
    {% if tmpl_key != "flipping_items" %}
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h5 fw-bold mb-0">{{ labor_title }}</h2>
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addLaborRow()">
          Add Item
        </button>
      </div>

      <div class="table-responsive">
        <table class="table table-sm align-middle" id="laborTable">
          <thead class="table-light">
            <tr>
              <th style="min-width: 280px;">{{ labor_desc_label }}</th>
              <th style="width: 180px;">Time (hrs)</th>
              <th style="width: 80px;"></th>
            </tr>
          </thead>
          <tbody>
            {% if mode == "edit" %}
              {% for li in inv.labor_items %}
                <tr>
                  <td><input class="form-control" name="labor_desc" value="{{ li.labor_desc }}"></td>
                  <td><input class="form-control" name="labor_time_hours" inputmode="decimal" value="{{ li.labor_time_hours }}"></td>
                  <td class="text-end">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">Remove</button>
                  </td>
                </tr>
              {% endfor %}
            {% endif %}

            <tr>
              <td><input class="form-control" name="labor_desc" placeholder="{{ labor_placeholder }}"></td>
              <td><input class="form-control" name="labor_time_hours" inputmode="decimal" placeholder="0.0"></td>
              <td class="text-end">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">Remove</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    {% endif %}

    <hr class="my-4">

    <!-- Notes -->
    <div class="mb-3">
      <label class="form-label">Notes</label>
      <textarea class="form-control" name="notes" rows="6"
        placeholder="One note per line (recommended).">{% if mode=='edit' %}{{ inv.notes }}{% else %}{{ (form.notes if form else '') }}{% endif %}</textarea>
      <div class="small-muted mt-1">These notes will wrap nicely in the PDF.</div>
    </div>

    <div class="mb-3">
      <label class="form-label">Useful Information</label>
      <textarea class="form-control" name="useful_info" id="usefulInfo" rows="4"
        placeholder="Links or notes to help you keep track.">{% if mode=='edit' %}{{ inv.useful_info or '' }}{% else %}{{ (form.useful_info if form else '') }}{% endif %}</textarea>
      <div class="small-muted mt-1">This will not appear on the PDF.</div>
      <div class="mt-2" id="usefulInfoLinks" style="display:none;"></div>
    </div>

    <div class="d-flex gap-2">
      <button class="btn btn-primary" type="submit">
        {% if doc_type == "estimate" %}
          {% if mode == "new" %}Create Estimate{% else %}Save Estimate{% endif %}
        {% else %}
          {% if mode == "new" %}Create Invoice{% else %}Save Changes{% endif %}
        {% endif %}
      </button>
      <a class="btn btn-outline-secondary"
         href="{{ url_for('estimates') if doc_type == 'estimate' else url_for('customers_list') }}">
        Cancel
      </a>
    </div>

  </div>
</form>

<!-- Receipt Scan Modal -->
<div class="modal fade" id="receiptModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Scan Receipt</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label class="form-label">Receipt Image</label>
            <input class="form-control" type="file" id="receiptFile" accept="image/*" capture="environment">
            <div class="small-muted mt-2">
              You can upload an image or use your device camera.
            </div>
            <button class="btn btn-outline-primary mt-3 w-100" id="btnScanReceipt" type="button" disabled>
              Scan Receipt
            </button>
          </div>
          <div class="col-12 col-md-6">
            <div class="small-muted mb-2">Preview</div>
            <div class="border rounded p-2 bg-light" style="min-height: 200px;">
              <img id="receiptPreview" alt="Receipt preview" style="max-width:100%; display:none;">
              <div id="receiptPreviewEmpty" class="small-muted">No image selected.</div>
            </div>
          </div>
        </div>

        <hr class="my-3">

        <div>
          <div class="fw-semibold mb-2">Detected Items</div>
          <div id="receiptItemsEmpty" class="small-muted">No items detected yet.</div>
          <div id="receiptItemsList" class="list-group" style="display:none;"></div>
          <details class="mt-3">
            <summary class="small-muted">Show raw OCR text</summary>
            <pre id="receiptOcrText" class="mt-2 p-2 bg-light border rounded" style="white-space: pre-wrap; max-height: 220px; overflow:auto;"></pre>
          </details>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal" type="button">Close</button>
        <button class="btn btn-primary" id="btnAddReceiptItems" type="button" disabled>
          Add Selected Items
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    const form = document.getElementById("invoiceForm");
    const tzInput = document.getElementById("clientTzOffsetMinutes");
    const dateInput = document.getElementById("dateInInput");
    if (!tzInput) return;

    function currentOffsetMinutes() {
      return -new Date().getTimezoneOffset();
    }

    function formatLongDateLocal(d) {
      return new Intl.DateTimeFormat("en-US", {
        month: "long",
        day: "2-digit",
        year: "numeric",
      }).format(d);
    }

    tzInput.value = String(currentOffsetMinutes());

    if (dateInput && "{{ mode }}" === "new") {
      const currentVal = (dateInput.value || "").trim();
      const initialDefault = (dateInput.dataset.initialDefault || "").trim();
      if (!currentVal || (initialDefault && currentVal === initialDefault)) {
        dateInput.value = formatLongDateLocal(new Date());
      }
    }

    if (form) {
      form.addEventListener("submit", () => {
        tzInput.value = String(currentOffsetMinutes());
      });
    }
  })();

  function removeRow(btn) {
    const tr = btn.closest("tr");
    if (!tr) return;
    tr.remove();
  }

  function titleCaseWords(value) {
    const acronyms = new Set([
      "OEM", "ACD", "ACDELCO", "GM", "FORD", "MOPAR", "VW", "BMW", "AUDI", "NAPA",
      "O2", "OBD", "OBD2", "ABS", "TPMS", "HVAC", "CV", "ATF", "DOT", "PS", "DIY",
      "LED", "HID", "DRL", "AWD", "RWD", "FWD", "4WD", "2WD", "12V", "24V", "EV",
      "AGM", "EGR", "PCV", "MAF", "MAP", "TPS", "IAC", "IAT", "ECU", "PCM", "TCM"
    ]);
    return (value || "")
      .toLowerCase()
      .replace(/\b([a-z])([a-z]*)/g, (m, first, rest) => first.toUpperCase() + rest)
      .replace(/\b([A-Za-z0-9]+)\b/g, (m) => {
        const key = m.toUpperCase();
        return acronyms.has(key) ? key : m;
      });
  }

  function addPartRow() {
    const tbody = document.querySelector("#partsTable tbody");
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input class="form-control" name="part_name" placeholder="{{ parts_name_label|e }}"></td>
      <td><input class="form-control" name="part_price" inputmode="decimal" placeholder="0.00"></td>
      <td class="text-end">
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">Remove</button>
      </td>
    `;
    tbody.appendChild(tr);
  }

  function addPartRowWithValues(name, price) {
    const tbody = document.querySelector("#partsTable tbody");
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input class="form-control" name="part_name" value="${titleCaseWords(name || "")}"></td>
      <td><input class="form-control" name="part_price" inputmode="decimal" value="${price || ""}"></td>
      <td class="text-end">
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">Remove</button>
      </td>
    `;
    tbody.appendChild(tr);
  }

  function addLaborRow() {
    const tbody = document.querySelector("#laborTable tbody");
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input class="form-control" name="labor_desc" placeholder="{{ labor_desc_label|e }}"></td>
      <td><input class="form-control" name="labor_time_hours" inputmode="decimal" placeholder="0.0"></td>
      <td class="text-end">
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">Remove</button>
      </td>
    `;
    tbody.appendChild(tr);
  }

  // -----------------------------
  // Customer typeahead → set hidden customer_id
  // AND auto-fill email/phone from customer profile (if override fields are blank)
  // -----------------------------
  (function () {
    const nameInput = document.getElementById("customer_name");
    const idInput = document.getElementById("customer_id");
    const dl = document.getElementById("customers_datalist");
    const emailInput = document.getElementById("customer_email");
    const phoneInput = document.getElementById("customer_phone");
    const formatPhone = (value) => {
      const digits = (value || "").replace(/\D/g, "").slice(0, 10);
      if (!digits) return "";
      let formatted = `(${digits.slice(0, Math.min(3, digits.length))}`;
      if (digits.length >= 4) {
        formatted += `) ${digits.slice(3, Math.min(6, digits.length))}`;
      }
      if (digits.length >= 7) {
        formatted += `-${digits.slice(6, 10)}`;
      }
      return formatted;
    };

    const nameToId = {};
    if (dl) {
      const opts = dl.querySelectorAll("option");
      opts.forEach(opt => {
        const n = (opt.value || "").trim();
        const id = (opt.getAttribute("data-id") || "").trim();
        if (n && id && !nameToId[n.toLowerCase()]) {
          nameToId[n.toLowerCase()] = id;
        }
      });
    }

    const idToCustomer = {};
    if (Array.isArray(CUSTOMERS)) {
      CUSTOMERS.forEach(c => {
        if (c && c.id != null) idToCustomer[String(c.id)] = c;
      });
    }

    function fillContactFromCustomerId() {
      if (!idInput.value) return;
      const c = idToCustomer[String(idInput.value)];
      if (!c) return;

      if (emailInput && !(emailInput.value || "").trim()) {
        emailInput.value = (c.email || "").trim();
      }
      if (phoneInput && !(phoneInput.value || "").trim()) {
        phoneInput.value = formatPhone((c.phone || "").trim());
      }
    }

    function syncCustomerId() {
      const v = (nameInput.value || "").trim().toLowerCase();
      if (!v) {
        idInput.value = "";
        return;
      }
      if (nameToId[v]) {
        idInput.value = nameToId[v];
        fillContactFromCustomerId();
      } else {
        idInput.value = "";
      }
    }

    if (nameInput) {
      nameInput.addEventListener("input", syncCustomerId);
      nameInput.addEventListener("change", syncCustomerId);
      nameInput.addEventListener("blur", syncCustomerId);
    }
    if (phoneInput) {
      phoneInput.value = formatPhone(phoneInput.value);
      phoneInput.addEventListener("input", () => {
        phoneInput.value = formatPhone(phoneInput.value);
      });
    }

    const form = document.getElementById("invoiceForm");
    if (form) {
      form.addEventListener("submit", function (e) {
        syncCustomerId();
        if (!idInput.value) {
          e.preventDefault();
          alert("Please select an existing customer (choose one from the suggestions).");
          nameInput.focus();
        }
      });
    }

    syncCustomerId();
    fillContactFromCustomerId();
  })();

  (function () {
    const input = document.getElementById("usefulInfo");
    const linkWrap = document.getElementById("usefulInfoLinks");
    if (!input || !linkWrap) return;

    function normalizeUrl(raw) {
      const trimmed = raw.trim();
      if (!trimmed) return null;
      if (/^https?:\/\//i.test(trimmed)) return trimmed;
      if (/^www\./i.test(trimmed)) return `https://${trimmed}`;
      return null;
    }

    function updateLinks() {
      const text = input.value || "";
      const urls = text.match(/\b(https?:\/\/[^\s]+|www\.[^\s]+)\b/gi) || [];
      const links = urls.map(normalizeUrl).filter(Boolean);
      if (!links.length) {
        linkWrap.innerHTML = "";
        linkWrap.style.display = "none";
        return;
      }
      linkWrap.style.display = "block";
      linkWrap.innerHTML = `
        <div class="small-muted mb-1">Detected links:</div>
        ${links.map((url) => `<div><a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a></div>`).join("")}
      `;
    }

    input.addEventListener("input", updateLinks);
    updateLinks();
  })();

  (function () {
    const fileInput = document.getElementById("receiptFile");
    const preview = document.getElementById("receiptPreview");
    const previewEmpty = document.getElementById("receiptPreviewEmpty");
    const scanBtn = document.getElementById("btnScanReceipt");
    const itemsList = document.getElementById("receiptItemsList");
    const itemsEmpty = document.getElementById("receiptItemsEmpty");
    const addBtn = document.getElementById("btnAddReceiptItems");
    const ocrTextEl = document.getElementById("receiptOcrText");

    if (!fileInput || !scanBtn) return;

    let parsedItems = [];

    function normalizeReceiptItem(item) {
      const name = String(item && item.name ? item.name : "").trim();
      const priceNum = Number.parseFloat(String(item && item.price ? item.price : "").replace(",", "."));
      if (!name || !Number.isFinite(priceNum) || priceNum <= 0) return null;
      return { name, price: priceNum.toFixed(2) };
    }

    function aggregateReceiptItems(items) {
      const map = new Map();
      (Array.isArray(items) ? items : []).forEach((raw) => {
        const normalized = normalizeReceiptItem(raw);
        if (!normalized) return;
        const key = `${normalized.name.toLowerCase()}|${normalized.price}`;
        const existing = map.get(key);
        if (existing) {
          existing.qty += 1;
          return;
        }
        map.set(key, { name: normalized.name, price: normalized.price, qty: 1 });
      });
      return Array.from(map.values());
    }

    fileInput.addEventListener("change", () => {
      const file = fileInput.files && fileInput.files[0];
      parsedItems = [];
      itemsList.style.display = "none";
      itemsList.innerHTML = "";
      itemsEmpty.style.display = "";
      addBtn.disabled = true;

      if (!file) {
        preview.style.display = "none";
        previewEmpty.style.display = "";
        scanBtn.disabled = true;
        return;
      }

      preview.src = URL.createObjectURL(file);
      preview.style.display = "";
      previewEmpty.style.display = "none";
      scanBtn.disabled = false;
    });

    scanBtn.addEventListener("click", async () => {
      const file = fileInput.files && fileInput.files[0];
      if (!file) return;
      scanBtn.disabled = true;
      scanBtn.textContent = "Scanning...";

      try {
        const fd = new FormData();
        fd.append("image", file);
        const res = await fetch("/api/receipts/scan", { method: "POST", body: fd });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          alert(data.error || "Receipt scan failed.");
          return;
        }

        parsedItems = aggregateReceiptItems(data.items);
        if (ocrTextEl) {
          ocrTextEl.textContent = (data.text || "").trim();
        }
        itemsList.innerHTML = "";

        if (!parsedItems.length) {
          itemsEmpty.textContent = "No items detected. Try a clearer image.";
          itemsEmpty.style.display = "";
          itemsList.style.display = "none";
          addBtn.disabled = true;
          return;
        }

        parsedItems.forEach((item, idx) => {
          const row = document.createElement("label");
          row.className = "list-group-item d-flex align-items-center gap-2";
          const checkbox = document.createElement("input");
          checkbox.className = "form-check-input me-1";
          checkbox.type = "checkbox";
          checkbox.checked = true;
          checkbox.dataset.index = String(idx);

          const text = document.createElement("span");
          text.className = "flex-grow-1";
          text.textContent = `${item.name} - $${item.price}`;

          const qty = document.createElement("input");
          qty.type = "number";
          qty.min = "1";
          qty.step = "1";
          qty.value = String(item.qty || 1);
          qty.className = "form-control form-control-sm";
          qty.style.width = "88px";
          qty.dataset.index = String(idx);
          qty.dataset.kind = "qty";

          row.appendChild(checkbox);
          row.appendChild(text);
          row.appendChild(qty);
          itemsList.appendChild(row);
        });

        itemsEmpty.style.display = "none";
        itemsList.style.display = "";
        addBtn.disabled = false;
      } finally {
        scanBtn.disabled = false;
        scanBtn.textContent = "Scan Receipt";
      }
    });

    addBtn.addEventListener("click", () => {
      const checks = itemsList.querySelectorAll("input[type='checkbox']");
      let added = 0;
      checks.forEach((chk) => {
        if (!chk.checked) return;
        const idx = Number(chk.dataset.index || "-1");
        if (!Number.isNaN(idx) && parsedItems[idx]) {
          const item = parsedItems[idx];
          const qtyInput = itemsList.querySelector(`input[data-kind='qty'][data-index='${idx}']`);
          const qty = Math.max(1, Number.parseInt(qtyInput && qtyInput.value ? qtyInput.value : "1", 10) || 1);
          for (let i = 0; i < qty; i += 1) {
            addPartRowWithValues(item.name, item.price);
            added += 1;
          }
        }
      });

      if (added > 0) {
        const modalEl = document.getElementById("receiptModal");
        const modal = bootstrap.Modal.getInstance(modalEl);
        if (modal) modal.hide();
      }
    });
  })();

  (function () {
    const totalInput = document.getElementById("laborHoursTotal");
    const hiddenInput = document.getElementById("laborHoursHidden");
    if (!totalInput || !hiddenInput) return;

    function parseHours(val) {
      const n = parseFloat(String(val || "").replace(",", "."));
      return Number.isFinite(n) ? n : 0;
    }

    function recalcLaborHours() {
      const inputs = document.querySelectorAll("input[name='labor_time_hours']");
      let sum = 0;
      inputs.forEach((inp) => {
        sum += parseHours(inp.value);
      });
      const rounded = Math.round(sum * 100) / 100;
      totalInput.value = rounded ? String(rounded) : "0";
      hiddenInput.value = String(rounded);
    }

    document.addEventListener("input", (e) => {
      if (e.target && e.target.name === "labor_time_hours") {
        recalcLaborHours();
      }
    });

    recalcLaborHours();
  })();

  (function () {
    function applyTitleCaseInput(e) {
      if (!e.target || e.target.name !== "part_name") return;
      const start = e.target.selectionStart;
      const end = e.target.selectionEnd;
      const updated = titleCaseWords(e.target.value);
      if (updated !== e.target.value) {
        e.target.value = updated;
        if (typeof start === "number" && typeof end === "number") {
          e.target.setSelectionRange(start, end);
        }
      }
    }

    document.addEventListener("input", applyTitleCaseInput);
  })();
</script>

{% endblock %}
