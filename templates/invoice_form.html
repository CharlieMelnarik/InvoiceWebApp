{% extends "base.html" %}
{% set doc_type = doc_type if doc_type is defined and doc_type else "invoice" %}
{% set title = ("New Estimate" if mode == "new" else "Edit Estimate") if doc_type == "estimate" else ("New Invoice" if mode == "new" else "Edit Invoice") %}

{% block content %}

{% set _tmpl = tmpl if tmpl is defined and tmpl else {} %}
{% set tmpl_key = (tmpl_key if tmpl_key is defined and tmpl_key else "auto_repair") %}

{% set job_label = _tmpl.get('job_label', 'Vehicle') %}
{% set labor_title = _tmpl.get('labor_title', 'Labor') %}
{% set labor_desc_label = _tmpl.get('labor_desc_label', 'Labor Description') %}
{% set parts_title = _tmpl.get('parts_title', 'Parts') %}
{% set parts_name_label = _tmpl.get('parts_name_label', 'Part Name') %}
{% set shop_supplies_label = _tmpl.get('shop_supplies_label', 'Shop Supplies') %}

{% set job_placeholder = _tmpl.get('job_placeholder', '') %}
{% set part_placeholder = _tmpl.get('parts_placeholder', 'e.g. Item') %}
{% set labor_placeholder = _tmpl.get('labor_placeholder', 'e.g. Service performed') %}

{% if mode == "edit" %}
  {% set _cust_id = (inv.customer_id|string) %}
  {% set _cust_name = (inv.name or "") %}
{% else %}
  {% set _cust_id = (form.customer_id if form else "") %}
  {% set _cust_name = (form.customer_name if form else "") %}
  {% if (not _cust_id and not _cust_name) and pre_customer is defined and pre_customer %}
    {% set _cust_id = (pre_customer.id|string) %}
    {% set _cust_name = (pre_customer.name or "") %}
  {% endif %}
{% endif %}

<div class="d-flex justify-content-between align-items-end mb-3">
  <div>
    <h1 class="h3 fw-bold mb-1">
      {% if doc_type == "estimate" %}
        {% if mode == "new" %}New Estimate{% else %}Edit Estimate{% endif %}
      {% else %}
        {% if mode == "new" %}New Invoice{% else %}Edit Invoice{% endif %}
      {% endif %}
    </h1>
    <div class="small-muted">
      {% if mode == "new" %}
        Creates a new {{ "estimate" if doc_type == "estimate" else "invoice" }} number automatically.
      {% else %}
        Editing {{ "estimate" if doc_type == "estimate" else "invoice" }} <span class="mono">{{ inv.display_number or inv.invoice_number }}</span>
      {% endif %}
    </div>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{{ url_for('customers_list') }}">Customers</a>
    <a class="btn btn-outline-secondary"
       href="{{ url_for('estimates') if doc_type == 'estimate' else url_for('invoices') }}">
      {{ "All Estimates" if doc_type == "estimate" else "Invoices" }}
    </a>
  </div>
</div>

{# JS customer data (id/name/email/phone) #}
<script>
  const CUSTOMERS = {{ (customers_for_js if customers_for_js is defined else [])|tojson|safe }};
</script>

<form method="post" class="card shadow-sm" id="invoiceForm">
  <div class="card-body">

    <div class="row g-3">

      <!-- Customer selection: type-to-search -->
      <div class="col-12 col-md-6">
        <label class="form-label req">Customer</label>

        <input
          class="form-control"
          id="customer_name"
          name="customer_name"
          list="customers_datalist"
          value="{{ _cust_name }}"
          placeholder="Start typing a customer name…"
          autocomplete="off"
          required
        />

        <input type="hidden" id="customer_id" name="customer_id" value="{{ _cust_id }}">

        <datalist id="customers_datalist">
          {% for c in customers %}
            <option value="{{ c.name }}" data-id="{{ c.id }}"></option>
          {% endfor %}
        </datalist>

        <div class="small-muted mt-1">
          Need a new customer? <a href="{{ url_for('customer_new') }}">Create one</a>.
        </div>
      </div>

      <!-- Job / Vehicle -->
      <div class="col-12 col-md-6">
        <label class="form-label {% if tmpl_key=='auto_repair' %}req{% endif %}">{{ job_label }}</label>
        <input class="form-control" name="vehicle"
               {% if tmpl_key=='auto_repair' %}required{% endif %}
               placeholder="{{ job_placeholder }}"
               value="{% if mode=='edit' %}{{ inv.vehicle }}{% else %}{{ (form.vehicle if form else '') }}{% endif %}">
      </div>

      <!-- Customer contact (invoice-level override) -->
      <div class="col-12 col-md-6">
        <label class="form-label">Customer Email (override)</label>
        <input class="form-control" type="email" id="customer_email" name="customer_email"
               value="{% if mode=='edit' %}{{ inv.customer_email or '' }}{% else %}{{ (form.customer_email if form else '') }}{% endif %}"
               placeholder="customer@example.com">
        <div class="small-muted mt-1">If blank, we’ll use the customer profile email automatically.</div>
      </div>

      <div class="col-12 col-md-6">
        <label class="form-label">Customer Phone (override)</label>
        <input class="form-control" id="customer_phone" name="customer_phone"
               value="{% if mode=='edit' %}{{ inv.customer_phone or '' }}{% else %}{{ (form.customer_phone if form else '') }}{% endif %}"
               placeholder="(406) 555-1234">
        <div class="small-muted mt-1">If blank, we’ll use the customer profile phone automatically.</div>
      </div>

      {% if tmpl_key == "flipping_items" %}
        <div class="col-12 col-md-6">
          <label class="form-label">Profit</label>
          <div class="small-muted">
            Profit is calculated as <span class="mono">Sold for - Costs - Other Expenses</span>.
          </div>
        </div>
        <input type="hidden" name="price_per_hour" value="1">
        <input type="hidden" name="hours" value="0">
      {% else %}
        <div class="col-6 col-md-3">
          <label class="form-label">Hours (Total)</label>
          <input class="form-control" name="hours" inputmode="decimal"
                 value="{% if mode=='edit' %}{{ inv.hours }}{% else %}{{ (form.hours if form else '') }}{% endif %}">
        </div>
        <div class="col-6 col-md-3">
          <label class="form-label">Rate / Hour</label>
          <input class="form-control" name="price_per_hour" inputmode="decimal"
                 value="{% if mode=='edit' %}{{ inv.price_per_hour }}{% else %}{{ (form.price_per_hour if form else '') }}{% endif %}">
        </div>
      {% endif %}

      <div class="col-6 col-md-3">
        <label class="form-label">{{ shop_supplies_label }}</label>
        <input class="form-control" name="shop_supplies" inputmode="decimal"
               value="{% if mode=='edit' %}{{ inv.shop_supplies }}{% else %}{{ (form.shop_supplies if form else '0') }}{% endif %}">
      </div>

      <div class="col-6 col-md-3">
        <label class="form-label">Parts Markup (%)</label>
        <input class="form-control" name="parts_markup_percent" inputmode="decimal"
               value="{% if mode=='edit' %}{{ inv.parts_markup_percent }}{% else %}{{ (form.parts_markup_percent if form else '0') }}{% endif %}">
        <div class="small-muted mt-1">Applies to each part price (shown on web only).</div>
      </div>

      {% if doc_type != "estimate" %}
        <div class="col-6 col-md-3">
          <label class="form-label">
            {% if tmpl_key == "flipping_items" %}Sold for{% else %}Paid{% endif %}
          </label>
          <input class="form-control" name="paid" inputmode="decimal"
                 value="{% if mode=='edit' %}{{ inv.paid }}{% else %}{{ (form.paid if form else '0') }}{% endif %}">
        </div>
      {% endif %}

      <div class="col-12 col-md-4">
        <label class="form-label">Date In (text)</label>
        <input class="form-control" name="date_in"
               value="{% if mode=='edit' %}{{ inv.date_in }}{% else %}{{ (form.date_in if form else default_date) }}{% endif %}">
      </div>

    </div>

    <hr class="my-4">

    <!-- Parts / Materials -->
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h5 fw-bold mb-0">{{ parts_title }}</h2>
      <button type="button" class="btn btn-sm btn-outline-primary" onclick="addPartRow()">
        Add Item
      </button>
    </div>

    <div class="table-responsive">
      <table class="table table-sm align-middle" id="partsTable">
        <thead class="table-light">
          <tr>
            <th style="min-width: 280px;">{{ parts_name_label }}</th>
            <th style="width: 160px;">Price</th>
            <th style="width: 80px;"></th>
          </tr>
        </thead>
        <tbody>
          {% if mode == "edit" %}
            {% for p in inv.parts %}
              <tr>
                <td><input class="form-control" name="part_name" value="{{ p.part_name }}"></td>
                <td><input class="form-control" name="part_price" inputmode="decimal" value="{{ p.part_price }}"></td>
                <td class="text-end">
                  <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">Remove</button>
                </td>
              </tr>
            {% endfor %}
          {% endif %}

          <tr>
            <td><input class="form-control" name="part_name" placeholder="{{ part_placeholder }}"></td>
            <td><input class="form-control" name="part_price" inputmode="decimal" placeholder="0.00"></td>
            <td class="text-end">
              <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">Remove</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <hr class="my-4">

    <!-- Labor / Services -->
    {% if tmpl_key != "flipping_items" %}
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h5 fw-bold mb-0">{{ labor_title }}</h2>
        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addLaborRow()">
          Add Item
        </button>
      </div>

      <div class="table-responsive">
        <table class="table table-sm align-middle" id="laborTable">
          <thead class="table-light">
            <tr>
              <th style="min-width: 280px;">{{ labor_desc_label }}</th>
              <th style="width: 180px;">Time (hrs)</th>
              <th style="width: 80px;"></th>
            </tr>
          </thead>
          <tbody>
            {% if mode == "edit" %}
              {% for li in inv.labor_items %}
                <tr>
                  <td><input class="form-control" name="labor_desc" value="{{ li.labor_desc }}"></td>
                  <td><input class="form-control" name="labor_time_hours" inputmode="decimal" value="{{ li.labor_time_hours }}"></td>
                  <td class="text-end">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">Remove</button>
                  </td>
                </tr>
              {% endfor %}
            {% endif %}

            <tr>
              <td><input class="form-control" name="labor_desc" placeholder="{{ labor_placeholder }}"></td>
              <td><input class="form-control" name="labor_time_hours" inputmode="decimal" placeholder="0.0"></td>
              <td class="text-end">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">Remove</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    {% endif %}

    <hr class="my-4">

    <!-- Notes -->
    <div class="mb-3">
      <label class="form-label">Notes</label>
      <textarea class="form-control" name="notes" rows="6"
        placeholder="One note per line (recommended).">{% if mode=='edit' %}{{ inv.notes }}{% else %}{{ (form.notes if form else '') }}{% endif %}</textarea>
      <div class="small-muted mt-1">These notes will wrap nicely in the PDF.</div>
    </div>

    <div class="mb-3">
      <label class="form-label">Useful Information</label>
      <textarea class="form-control" name="useful_info" id="usefulInfo" rows="4"
        placeholder="Links or notes to help you keep track.">{% if mode=='edit' %}{{ inv.useful_info or '' }}{% else %}{{ (form.useful_info if form else '') }}{% endif %}</textarea>
      <div class="small-muted mt-1">This will not appear on the PDF.</div>
      <div class="mt-2" id="usefulInfoLinks" style="display:none;"></div>
    </div>

    <div class="d-flex gap-2">
      <button class="btn btn-primary" type="submit">
        {% if doc_type == "estimate" %}
          {% if mode == "new" %}Create Estimate{% else %}Save Estimate{% endif %}
        {% else %}
          {% if mode == "new" %}Create Invoice{% else %}Save Changes{% endif %}
        {% endif %}
      </button>
      <a class="btn btn-outline-secondary"
         href="{{ url_for('estimates') if doc_type == 'estimate' else url_for('customers_list') }}">
        Cancel
      </a>
    </div>

  </div>
</form>

<script>
  function removeRow(btn) {
    const tr = btn.closest("tr");
    if (!tr) return;
    tr.remove();
  }

  function addPartRow() {
    const tbody = document.querySelector("#partsTable tbody");
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input class="form-control" name="part_name" placeholder="{{ parts_name_label|e }}"></td>
      <td><input class="form-control" name="part_price" inputmode="decimal" placeholder="0.00"></td>
      <td class="text-end">
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">Remove</button>
      </td>
    `;
    tbody.appendChild(tr);
  }

  function addLaborRow() {
    const tbody = document.querySelector("#laborTable tbody");
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input class="form-control" name="labor_desc" placeholder="{{ labor_desc_label|e }}"></td>
      <td><input class="form-control" name="labor_time_hours" inputmode="decimal" placeholder="0.0"></td>
      <td class="text-end">
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">Remove</button>
      </td>
    `;
    tbody.appendChild(tr);
  }

  // -----------------------------
  // Customer typeahead → set hidden customer_id
  // AND auto-fill email/phone from customer profile (if override fields are blank)
  // -----------------------------
  (function () {
    const nameInput = document.getElementById("customer_name");
    const idInput = document.getElementById("customer_id");
    const dl = document.getElementById("customers_datalist");
    const emailInput = document.getElementById("customer_email");
    const phoneInput = document.getElementById("customer_phone");

    const nameToId = {};
    if (dl) {
      const opts = dl.querySelectorAll("option");
      opts.forEach(opt => {
        const n = (opt.value || "").trim();
        const id = (opt.getAttribute("data-id") || "").trim();
        if (n && id && !nameToId[n.toLowerCase()]) {
          nameToId[n.toLowerCase()] = id;
        }
      });
    }

    const idToCustomer = {};
    if (Array.isArray(CUSTOMERS)) {
      CUSTOMERS.forEach(c => {
        if (c && c.id != null) idToCustomer[String(c.id)] = c;
      });
    }

    function fillContactFromCustomerId() {
      if (!idInput.value) return;
      const c = idToCustomer[String(idInput.value)];
      if (!c) return;

      if (emailInput && !(emailInput.value || "").trim()) {
        emailInput.value = (c.email || "").trim();
      }
      if (phoneInput && !(phoneInput.value || "").trim()) {
        phoneInput.value = (c.phone || "").trim();
      }
    }

    function syncCustomerId() {
      const v = (nameInput.value || "").trim().toLowerCase();
      if (!v) {
        idInput.value = "";
        return;
      }
      if (nameToId[v]) {
        idInput.value = nameToId[v];
        fillContactFromCustomerId();
      } else {
        idInput.value = "";
      }
    }

    if (nameInput) {
      nameInput.addEventListener("input", syncCustomerId);
      nameInput.addEventListener("change", syncCustomerId);
      nameInput.addEventListener("blur", syncCustomerId);
    }

    const form = document.getElementById("invoiceForm");
    if (form) {
      form.addEventListener("submit", function (e) {
        syncCustomerId();
        if (!idInput.value) {
          e.preventDefault();
          alert("Please select an existing customer (choose one from the suggestions).");
          nameInput.focus();
        }
      });
    }

    syncCustomerId();
    fillContactFromCustomerId();
  })();

  (function () {
    const input = document.getElementById("usefulInfo");
    const linkWrap = document.getElementById("usefulInfoLinks");
    if (!input || !linkWrap) return;

    function normalizeUrl(raw) {
      const trimmed = raw.trim();
      if (!trimmed) return null;
      if (/^https?:\/\//i.test(trimmed)) return trimmed;
      if (/^www\./i.test(trimmed)) return `https://${trimmed}`;
      return null;
    }

    function updateLinks() {
      const text = input.value || "";
      const urls = text.match(/\b(https?:\/\/[^\s]+|www\.[^\s]+)\b/gi) || [];
      const links = urls.map(normalizeUrl).filter(Boolean);
      if (!links.length) {
        linkWrap.innerHTML = "";
        linkWrap.style.display = "none";
        return;
      }
      linkWrap.style.display = "block";
      linkWrap.innerHTML = `
        <div class="small-muted mb-1">Detected links:</div>
        ${links.map((url) => `<div><a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a></div>`).join("")}
      `;
    }

    input.addEventListener("input", updateLinks);
    updateLinks();
  })();
</script>

{% endblock %}
