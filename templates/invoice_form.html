{% extends "base.html" %}
{% set title = "New Invoice" if mode == "new" else "Edit Invoice" %}

{% block content %}

{# --------------------------------------------------------------------
  Profession-aware labels.
  app.py passes:
    - tmpl: dict config for the invoice template
    - tmpl_key: key string, like "auto_repair"
    - customers: list of Customer objects
    - customers_for_js: [{id, name}, ...] for autocomplete
    - pre_customer (optional) for GET /invoices/new?customer_id=
--------------------------------------------------------------------- #}
{% set _tmpl = tmpl if tmpl is defined and tmpl else {} %}
{% set tmpl_key = (tmpl_key if tmpl_key is defined and tmpl_key else "auto_repair") %}

{% set job_label = _tmpl.get('job_label', 'Vehicle') %}
{% set labor_title = _tmpl.get('labor_title', 'Labor') %}
{% set labor_desc_label = _tmpl.get('labor_desc_label', 'Labor Description') %}
{% set parts_title = _tmpl.get('parts_title', 'Parts') %}
{% set parts_name_label = _tmpl.get('parts_name_label', 'Part Name') %}
{% set shop_supplies_label = _tmpl.get('shop_supplies_label', 'Shop Supplies') %}

{% set job_placeholder = _tmpl.get('job_placeholder', '') %}
{% set part_placeholder = _tmpl.get('parts_placeholder', 'e.g. Item') %}
{% set labor_placeholder = _tmpl.get('labor_placeholder', 'e.g. Service performed') %}

{# ---------------------------------------------------------
   Customer prefill logic (works for new/edit + failed POST)
---------------------------------------------------------- #}
{% if mode == "edit" %}
  {% set _cust_id = ( (form.customer_id if form else inv.customer_id) | string ) %}
  {% set _cust_name = (form.customer_name if form else "") %}
  {# If form.customer_name empty on edit, fall back to customer list lookup via JS by id #}
{% else %}
  {% set _cust_id = (form.customer_id if form else (pre_customer.id|string if pre_customer else "")) %}
  {% set _cust_name = (form.customer_name if form else (pre_customer.name if pre_customer else "")) %}
{% endif %}

<div class="d-flex justify-content-between align-items-end mb-3">
  <div>
    <h1 class="h3 fw-bold mb-1">
      {% if mode == "new" %}New Invoice{% else %}Edit Invoice{% endif %}
    </h1>
    <div class="small-muted">
      {% if mode == "new" %}
        Creates a new invoice number automatically.
      {% else %}
        Editing invoice <span class="mono">{{ inv.invoice_number }}</span>
      {% endif %}
    </div>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{{ url_for('customers_list') }}">Customers</a>
    <a class="btn btn-outline-secondary" href="{{ url_for('invoices') }}">All Invoices</a>
  </div>
</div>

<form method="post" class="card shadow-sm" id="invoiceForm" novalidate>
  <div class="card-body">

    <div class="row g-3">

      <!-- Customer selection: real typeahead -->
      <div class="col-12 col-md-6">
        <label class="form-label req">Customer</label>

        <div class="position-relative">
          <input
            class="form-control"
            id="customer_name"
            name="customer_name"
            value="{{ _cust_name }}"
            placeholder="Start typing a customer nameâ€¦"
            autocomplete="off"
            required
          />

          <!-- Hidden actual selected id -->
          <input type="hidden" id="customer_id" name="customer_id" value="{{ _cust_id }}">

          <!-- Suggestions dropdown -->
          <div
            id="customerSuggestions"
            class="list-group position-absolute w-100 shadow-sm d-none"
            style="z-index: 1000; max-height: 240px; overflow:auto;"
            role="listbox"
            aria-label="Customer suggestions"
          ></div>
        </div>

        <div class="small-muted mt-1">
          Need a new customer? <a href="{{ url_for('customer_new') }}">Create one</a>.
        </div>
      </div>

      <!-- Job / Vehicle -->
      <div class="col-12 col-md-6">
        <label class="form-label {% if tmpl_key=='auto_repair' %}req{% endif %}">{{ job_label }}</label>
        <input class="form-control" name="vehicle"
               {% if tmpl_key=='auto_repair' %}required{% endif %}
               placeholder="{{ job_placeholder }}"
               value="{% if mode=='edit' %}{{ (form.vehicle if form else inv.vehicle) }}{% else %}{{ (form.vehicle if form else '') }}{% endif %}">
      </div>

      <!-- Customer contact (invoice-level override) -->
      <div class="col-12 col-md-6">
        <label class="form-label">Customer Email (override)</label>
        <input class="form-control" type="email" name="customer_email"
               value="{% if mode=='edit' %}{{ (form.customer_email if form else (inv.customer_email or '')) }}{% else %}{{ (form.customer_email if form else '') }}{% endif %}"
               placeholder="customer@example.com">
        <div class="small-muted mt-1">If blank, emailing can fall back to the customer profile email.</div>
      </div>

      <div class="col-12 col-md-6">
        <label class="form-label">Customer Phone (override)</label>
        <input class="form-control" name="customer_phone"
               value="{% if mode=='edit' %}{{ (form.customer_phone if form else (inv.customer_phone or '')) }}{% else %}{{ (form.customer_phone if form else '') }}{% endif %}"
               placeholder="(406) 555-1234">
      </div>

      <div class="col-6 col-md-3">
        <label class="form-label">Hours (Total)</label>
        <input class="form-control" name="hours" inputmode="decimal"
               value="{% if mode=='edit' %}{{ (form.hours if form else inv.hours) }}{% else %}{{ (form.hours if form else '') }}{% endif %}">
      </div>

      <div class="col-6 col-md-3">
        <label class="form-label">Rate / Hour</label>
        <input class="form-control" name="price_per_hour" inputmode="decimal"
               value="{% if mode=='edit' %}{{ (form.price_per_hour if form else inv.price_per_hour) }}{% else %}{{ (form.price_per_hour if form else '') }}{% endif %}">
      </div>

      <div class="col-6 col-md-3">
        <label class="form-label">{{ shop_supplies_label }}</label>
        <input class="form-control" name="shop_supplies" inputmode="decimal"
               value="{% if mode=='edit' %}{{ (form.shop_supplies if form else inv.shop_supplies) }}{% else %}{{ (form.shop_supplies if form else '0') }}{% endif %}">
      </div>

      <div class="col-6 col-md-3">
        <label class="form-label">Paid</label>
        <input class="form-control" name="paid" inputmode="decimal"
               value="{% if mode=='edit' %}{{ (form.paid if form else inv.paid) }}{% else %}{{ (form.paid if form else '0') }}{% endif %}">
      </div>

      <div class="col-12 col-md-4">
        <label class="form-label">Date In (text)</label>
        <input class="form-control" name="date_in"
               value="{% if mode=='edit' %}{{ (form.date_in if form else inv.date_in) }}{% else %}{{ (form.date_in if form else default_date) }}{% endif %}">
      </div>

    </div>

    <hr class="my-4">

    <!-- Parts / Materials -->
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h5 fw-bold mb-0">{{ parts_title }}</h2>
      <button type="button" class="btn btn-sm btn-outline-primary" onclick="addPartRow()">
        Add Item
      </button>
    </div>

    <div class="table-responsive">
      <table class="table table-sm align-middle" id="partsTable">
        <thead class="table-light">
          <tr>
            <th style="min-width: 280px;">{{ parts_name_label }}</th>
            <th style="width: 160px;">Price</th>
            <th style="width: 80px;"></th>
          </tr>
        </thead>
        <tbody>
          {% if mode == "edit" %}
            {% for p in inv.parts %}
              <tr>
                <td><input class="form-control" name="part_name" value="{{ p.part_name }}"></td>
                <td><input class="form-control" name="part_price" inputmode="decimal" value="{{ p.part_price }}"></td>
                <td class="text-end">
                  <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">Remove</button>
                </td>
              </tr>
            {% endfor %}
          {% endif %}

          <tr>
            <td><input class="form-control" name="part_name" placeholder="{{ part_placeholder }}"></td>
            <td><input class="form-control" name="part_price" inputmode="decimal" placeholder="0.00"></td>
            <td class="text-end">
              <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">Remove</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <hr class="my-4">

    <!-- Labor / Services -->
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h5 fw-bold mb-0">{{ labor_title }}</h2>
      <button type="button" class="btn btn-sm btn-outline-primary" onclick="addLaborRow()">
        Add Item
      </button>
    </div>

    <div class="table-responsive">
      <table class="table table-sm align-middle" id="laborTable">
        <thead class="table-light">
          <tr>
            <th style="min-width: 280px;">{{ labor_desc_label }}</th>
            <th style="width: 180px;">Time (hrs)</th>
            <th style="width: 80px;"></th>
          </tr>
        </thead>
        <tbody>
          {% if mode == "edit" %}
            {% for li in inv.labor_items %}
              <tr>
                <td><input class="form-control" name="labor_desc" value="{{ li.labor_desc }}"></td>
                <td><input class="form-control" name="labor_time_hours" inputmode="decimal" value="{{ li.labor_time_hours }}"></td>
                <td class="text-end">
                  <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">Remove</button>
                </td>
              </tr>
            {% endfor %}
          {% endif %}

          <tr>
            <td><input class="form-control" name="labor_desc" placeholder="{{ labor_placeholder }}"></td>
            <td><input class="form-control" name="labor_time_hours" inputmode="decimal" placeholder="0.0"></td>
            <td class="text-end">
              <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">Remove</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <hr class="my-4">

    <!-- Notes -->
    <div class="mb-3">
      <label class="form-label">Notes</label>
      <textarea class="form-control" name="notes" rows="6"
        placeholder="One note per line (recommended).">{% if mode=='edit' %}{{ (form.notes if form else inv.notes) }}{% else %}{{ (form.notes if form else '') }}{% endif %}</textarea>
      <div class="small-muted mt-1">These notes will wrap nicely in the PDF.</div>
    </div>

    <div class="d-flex gap-2">
      <button class="btn btn-primary" type="submit">
        {% if mode == "new" %}Create Invoice{% else %}Save Changes{% endif %}
      </button>
      <a class="btn btn-outline-secondary" href="{{ url_for('customers_list') }}">Cancel</a>
    </div>

  </div>
</form>

<script>
  function removeRow(btn) {
    const tr = btn.closest("tr");
    if (!tr) return;
    tr.remove();
  }

  function addPartRow() {
    const tbody = document.querySelector("#partsTable tbody");
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input class="form-control" name="part_name" placeholder="{{ part_placeholder|e }}"></td>
      <td><input class="form-control" name="part_price" inputmode="decimal" placeholder="0.00"></td>
      <td class="text-end">
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">Remove</button>
      </td>
    `;
    tbody.appendChild(tr);
  }

  function addLaborRow() {
    const tbody = document.querySelector("#laborTable tbody");
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input class="form-control" name="labor_desc" placeholder="{{ labor_placeholder|e }}"></td>
      <td><input class="form-control" name="labor_time_hours" inputmode="decimal" placeholder="0.0"></td>
      <td class="text-end">
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">Remove</button>
      </td>
    `;
    tbody.appendChild(tr);
  }

  // -----------------------------
  // Customer typeahead (reliable)
  // Uses customers_for_js from app.py: [{id, name}, ...]
  // -----------------------------
  (function () {
    const customers = {{ (customers_for_js if customers_for_js is defined else []) | tojson }};
    const nameInput = document.getElementById("customer_name");
    const idInput = document.getElementById("customer_id");
    const box = document.getElementById("customerSuggestions");
    const form = document.getElementById("invoiceForm");

    let activeIndex = -1;
    let currentItems = [];

    function norm(s) {
      return (s || "").trim().toLowerCase();
    }

    function setSelected(cust) {
      if (!cust) return;
      nameInput.value = cust.name;
      idInput.value = String(cust.id);
      hide();
    }

    function clearSelectionIfMismatch() {
      const v = norm(nameInput.value);
      const exact = customers.find(c => norm(c.name) === v);
      if (exact) {
        idInput.value = String(exact.id);
      } else {
        idInput.value = "";
      }
    }

    function hide() {
      box.classList.add("d-none");
      box.innerHTML = "";
      activeIndex = -1;
      currentItems = [];
    }

    function show(items) {
      box.innerHTML = "";
      activeIndex = -1;
      currentItems = items;

      if (!items.length) {
        hide();
        return;
      }

      items.forEach((c, idx) => {
        const a = document.createElement("button");
        a.type = "button";
        a.className = "list-group-item list-group-item-action";
        a.textContent = c.name;
        a.setAttribute("role", "option");
        a.addEventListener("mousedown", (e) => {
          // mousedown so it fires before input blur
          e.preventDefault();
          setSelected(c);
        });
        box.appendChild(a);
      });

      box.classList.remove("d-none");
    }

    function highlight(index) {
      const children = Array.from(box.children);
      children.forEach((el, i) => {
        if (i === index) el.classList.add("active");
        else el.classList.remove("active");
      });
    }

    function getMatches(q) {
      const n = norm(q);
      if (!n) return [];
      const starts = [];
      const contains = [];
      for (const c of customers) {
        const cn = norm(c.name);
        if (!cn) continue;
        if (cn.startsWith(n)) starts.push(c);
        else if (cn.includes(n)) contains.push(c);
      }
      return starts.concat(contains).slice(0, 10);
    }

    function onInput() {
      // User typed -> selection no longer guaranteed
      idInput.value = "";
      const items = getMatches(nameInput.value);
      show(items);
    }

    function onKeyDown(e) {
      if (box.classList.contains("d-none")) {
        // If Enter pressed without dropdown, attempt autocomplete to first match
        if (e.key === "Enter") {
          clearSelectionIfMismatch();
          if (!idInput.value) {
            const items = getMatches(nameInput.value);
            if (items.length) {
              e.preventDefault();
              setSelected(items[0]); // Enter autocompletes best match
            }
          }
        }
        return;
      }

      if (e.key === "ArrowDown") {
        e.preventDefault();
        activeIndex = Math.min(activeIndex + 1, currentItems.length - 1);
        highlight(activeIndex);
      } else if (e.key === "ArrowUp") {
        e.preventDefault();
        activeIndex = Math.max(activeIndex - 1, 0);
        highlight(activeIndex);
      } else if (e.key === "Escape") {
        hide();
      } else if (e.key === "Enter") {
        // If user hasn't arrowed to anything, pick first match
        const pick = (activeIndex >= 0 ? currentItems[activeIndex] : currentItems[0]);
        if (pick) {
          e.preventDefault();
          setSelected(pick);
        }
      }
    }

    function onBlur() {
      // Give click selection time (mousedown already handles it)
      setTimeout(() => {
        clearSelectionIfMismatch();
        hide();
      }, 120);
    }

    // Prefill: if we have a customer_id but empty name (common on edit),
    // fill name from list so the user sees it.
    function prefillFromId() {
      const id = (idInput.value || "").trim();
      if (!id) return;
      if (nameInput.value && nameInput.value.trim()) return;
      const found = customers.find(c => String(c.id) === id);
      if (found) nameInput.value = found.name;
    }

    if (nameInput) {
      nameInput.addEventListener("input", onInput);
      nameInput.addEventListener("keydown", onKeyDown);
      nameInput.addEventListener("blur", onBlur);
      nameInput.addEventListener("change", clearSelectionIfMismatch);
    }

    document.addEventListener("click", (e) => {
      if (!box.contains(e.target) && e.target !== nameInput) hide();
    });

    if (form) {
      form.addEventListener("submit", function (e) {
        clearSelectionIfMismatch();

        if (!idInput.value) {
          e.preventDefault();
          alert("Please select a customer from the suggestions (existing customer).");
          nameInput.focus();
          return;
        }
      });
    }

    prefillFromId();
    clearSelectionIfMismatch();
  })();
</script>

{% endblock %}





