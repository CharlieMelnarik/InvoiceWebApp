{% extends "base.html" %}
{% set doc_type = doc_type if doc_type is defined and doc_type else "invoice" %}
{% set title = ("New Estimate" if mode == "new" else "Edit Estimate") if doc_type == "estimate" else ("New Invoice" if mode == "new" else "Edit Invoice") %}

{% block content %}

{% set _tmpl = tmpl if tmpl is defined and tmpl else {} %}
{% set tmpl_key = (tmpl_key if tmpl_key is defined and tmpl_key else "auto_repair") %}

{% set job_label = _tmpl.get('job_label', 'Vehicle') %}
{% set labor_title = _tmpl.get('labor_title', 'Labor') %}
{% set labor_desc_label = _tmpl.get('labor_desc_label', 'Labor Description') %}
{% set parts_title = _tmpl.get('parts_title', 'Parts') %}
{% set parts_name_label = _tmpl.get('parts_name_label', 'Part Name') %}
{% set shop_supplies_label = _tmpl.get('shop_supplies_label', 'Shop Supplies') %}
{% set show_job = _tmpl.get('show_job', True) %}
{% set show_labor = _tmpl.get('show_labor', True) %}
{% set show_parts = _tmpl.get('show_parts', True) %}
{% set show_shop_supplies = _tmpl.get('show_shop_supplies', True) %}

{% set job_placeholder = _tmpl.get('job_placeholder', '') %}
{% set part_placeholder = _tmpl.get('parts_placeholder', 'ex. Item') %}
{% set labor_placeholder = _tmpl.get('labor_placeholder', 'ex. Service performed') %}
{% set _picker_invoice_id = inv.id if mode == "edit" and doc_type == "invoice" else "" %}
{% set _picker_estimate_id = inv.id if mode == "edit" and doc_type == "estimate" else "" %}
{% set _default_hourly_rate = (user_default_hourly_rate if user_default_hourly_rate is defined and (user_default_hourly_rate|float) != 0 else '') %}
{% set _default_parts_markup = (user_default_parts_markup if user_default_parts_markup is defined and (user_default_parts_markup|float) != 0 else '') %}
{% set _default_tax_rate = (user_tax_rate if user_tax_rate is defined and (user_tax_rate|float) != 0 else '') %}

{% if mode == "edit" %}
  {% set _cust_id = (inv.customer_id|string) %}
  {% set _cust_name = (inv.name or "") %}
{% else %}
  {% set _cust_id = (form.customer_id if form else "") %}
  {% set _cust_name = (form.customer_name if form else "") %}
  {% if (not _cust_id and not _cust_name) and pre_customer is defined and pre_customer %}
    {% set _cust_id = (pre_customer.id|string) %}
    {% set _cust_name = (pre_customer.name or "") %}
  {% endif %}
{% endif %}

<div class="page-header">
  <div>
    <h1 class="h3 fw-bold mb-1">
      {% if doc_type == "estimate" %}
        {% if mode == "new" %}New Estimate{% else %}Edit Estimate{% endif %}
      {% else %}
        {% if mode == "new" %}New Invoice{% else %}Edit Invoice{% endif %}
      {% endif %}
    </h1>
    <div class="subtitle">
      {% if mode == "new" %}
        Creates a new {{ "estimate" if doc_type == "estimate" else "invoice" }} number automatically.
      {% else %}
        Editing {{ "estimate" if doc_type == "estimate" else "invoice" }} <span class="mono">{{ inv.display_number or inv.invoice_number }}</span>
      {% endif %}
    </div>
  </div>
  <div class="action-group">
    <a class="btn btn-outline-secondary" href="{{ url_for('customers_list') }}">Clients</a>
    <a class="btn btn-outline-secondary"
       href="{{ url_for('estimates') if doc_type == 'estimate' else url_for('invoices') }}">
      {{ "All Estimates" if doc_type == "estimate" else "Invoices" }}
    </a>
  </div>
</div>

{# JS client data (id/name/email/phone) #}
<script>
  const CUSTOMERS = {{ (customers_for_js if customers_for_js is defined else [])|tojson|safe }};
</script>

<form method="post" class="card shadow-sm" id="invoiceForm">
  <input type="hidden" id="clientTzOffsetMinutes" name="client_tz_offset_minutes" value="">
  <div class="card-body">

    <div class="row g-3">

      <!-- Client selection: type-to-search -->
      <div class="col-12 col-md-6">
        <label class="form-label req">Client</label>

        <input
          class="form-control"
          id="customer_name"
          name="customer_name"
          list="customers_datalist"
          value="{{ _cust_name }}"
          placeholder="Start typing a client name…"
          autocomplete="off"
          required
        />

        <input type="hidden" id="customer_id" name="customer_id" value="{{ _cust_id }}">

        <datalist id="customers_datalist">
          {% for c in customers %}
            <option value="{{ c.name }}" data-id="{{ c.id }}"></option>
          {% endfor %}
        </datalist>

        <div class="small-muted mt-1">
          Need a new client? <a href="{{ url_for('customer_new') }}">Create one</a>.
        </div>
      </div>

      <!-- Job / Vehicle -->
      {% if show_job %}
      <div class="col-12 col-md-6">
        <label class="form-label {% if tmpl_key=='auto_repair' %}req{% endif %}">{{ job_label }}</label>
        <input class="form-control" name="vehicle"
               {% if tmpl_key=='auto_repair' %}required{% endif %}
               placeholder="{{ job_placeholder }}"
               value="{% if mode=='edit' %}{{ inv.vehicle }}{% else %}{{ (form.vehicle if form else '') }}{% endif %}">
      </div>
      {% endif %}

      <!-- Client contact (invoice-level override) -->
      <div class="col-12 col-md-6">
        <label class="form-label">Client Email (override)</label>
        <input class="form-control" type="email" id="customer_email" name="customer_email"
               value="{% if mode=='edit' %}{{ inv.customer_email or '' }}{% else %}{{ (form.customer_email if form else '') }}{% endif %}"
               placeholder="client@example.com">
        <div class="small-muted mt-1">If blank, we’ll use the client profile email automatically.</div>
      </div>

      <div class="col-12 col-md-6">
        <label class="form-label">Client Phone (override)</label>
        <input class="form-control" id="customer_phone" name="customer_phone"
               value="{% if mode=='edit' %}{{ format_phone(inv.customer_phone) }}{% else %}{{ (form.customer_phone if form else '') }}{% endif %}"
               placeholder="(406) 555-1234">
        <div class="small-muted mt-1">If blank, we’ll use the client profile phone automatically.</div>
      </div>

      {% if tmpl_key == "flipping_items" %}
        <div class="col-12 col-md-6">
          <label class="form-label">Profit</label>
          <div class="small-muted">
            Profit is calculated as <span class="mono">Sold for - Costs - Other Expenses</span>.
          </div>
        </div>
        <input type="hidden" name="price_per_hour" value="1">
        <input type="hidden" name="hours" value="0">
      {% else %}
        <div class="col-6 col-md-3">
          <label class="form-label">Hours (Total)</label>
          <input class="form-control" id="laborHoursTotal" inputmode="decimal" disabled>
          <input type="hidden" name="hours" id="laborHoursHidden"
                 value="{% if mode=='edit' %}{{ inv.hours }}{% else %}{{ (form.hours if form else '') }}{% endif %}">
          <div class="small-muted mt-1">Calculated from labor line items.</div>
        </div>
        <div class="col-6 col-md-3">
          <label class="form-label">Rate / Hour</label>
          <input class="form-control" name="price_per_hour" inputmode="decimal"
                 value="{% if mode=='edit' %}{{ inv.price_per_hour }}{% else %}{{ (form.price_per_hour if form else _default_hourly_rate) }}{% endif %}"
                 placeholder="ex. 95.00">
        </div>
      {% endif %}

      {% if show_shop_supplies %}
      <div class="col-6 col-md-3">
        <label class="form-label">{{ shop_supplies_label }}</label>
        <input class="form-control" name="shop_supplies" inputmode="decimal"
               value="{% if mode=='edit' %}{{ inv.shop_supplies }}{% else %}{{ (form.shop_supplies if form else '') }}{% endif %}"
               placeholder="ex. 12.00">
      </div>
      {% endif %}

      <div class="col-6 col-md-3">
        <label class="form-label">Parts Markup (%)</label>
        <input class="form-control" name="parts_markup_percent" inputmode="decimal"
               value="{% if mode=='edit' %}{{ inv.parts_markup_percent }}{% else %}{{ (form.parts_markup_percent if form else _default_parts_markup) }}{% endif %}"
               placeholder="ex. 10.0">
        <div class="small-muted mt-1">Applies to each part price (shown on web only).</div>
      </div>

      <div class="col-6 col-md-3">
        <label class="form-label">Tax (%)</label>
        <input class="form-control" name="tax_rate" inputmode="decimal"
               value="{% if mode=='edit' %}{{ inv.tax_rate if (inv.tax_rate is not none and (inv.tax_rate|float) != 0) else '' }}{% else %}{{ (form.tax_rate if form else _default_tax_rate) }}{% endif %}"
               placeholder="ex. 8.25">
      </div>

      {% if doc_type != "estimate" %}
        <div class="col-6 col-md-3">
          <label class="form-label">
            {% if tmpl_key == "flipping_items" %}Sold for{% else %}Paid{% endif %}
          </label>
          <input class="form-control" name="paid" inputmode="decimal"
                 value="{% if mode=='edit' %}{{ inv.paid }}{% else %}{{ (form.paid if form else '') }}{% endif %}"
                 placeholder="ex. 250.00">
        </div>
      {% endif %}

      <div class="col-12 col-md-4">
        <label class="form-label">Date In (text)</label>
        <input class="form-control" id="dateInInput" name="date_in"
               data-initial-default="{% if mode=='new' %}{{ (form.date_in if form else default_date) }}{% endif %}"
               value="{% if mode=='edit' %}{{ inv.date_in }}{% else %}{{ (form.date_in if form else default_date) }}{% endif %}">
      </div>

    </div>

    {% if show_parts %}
    <hr class="my-4">

    <!-- Parts / Materials -->
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h5 fw-bold mb-0">{{ parts_title }}</h2>
      <div class="d-flex gap-2">
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addPartRow()">
          Add Item
        </button>
        <a
          class="btn btn-sm btn-outline-secondary"
          href="{{ url_for('expense_items_picker', doc_type=doc_type, mode=mode, invoice_id=_picker_invoice_id, estimate_id=_picker_estimate_id) }}"
        >
          Add From Business Expenses
        </a>
        {% if mode == "edit" %}
          <a
            class="btn btn-sm btn-outline-secondary"
            href="{{ url_for('expense_items_to_business_expenses', doc_type=doc_type, mode=mode, invoice_id=_picker_invoice_id, estimate_id=_picker_estimate_id) }}"
          >
            Add Items To Business Expenses
          </a>
        {% else %}
          <button type="button" class="btn btn-sm btn-outline-secondary" disabled title="Save first to export items.">
            Add Items To Business Expenses
          </button>
        {% endif %}
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-sm align-middle" id="partsTable">
        <thead class="table-light">
          <tr>
            <th style="min-width: 280px;">{{ parts_name_label }}</th>
            <th style="width: 160px;">Price</th>
            <th style="width: 80px;"></th>
          </tr>
        </thead>
        <tbody>
          {% if mode == "edit" %}
            {% for p in inv.parts %}
              <tr>
                <td><input class="form-control" name="part_name" value="{{ p.part_name }}"></td>
                <td><input class="form-control" name="part_price" inputmode="decimal" value="{{ p.part_price }}"></td>
                <td class="text-end">
                  <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">Remove</button>
                </td>
              </tr>
            {% endfor %}
          {% endif %}

          <tr>
            <td><input class="form-control" name="part_name" placeholder="{{ part_placeholder }}"></td>
            <td><input class="form-control" name="part_price" inputmode="decimal" placeholder="ex. 24.99"></td>
            <td class="text-end">
              <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">Remove</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    {% endif %}

    {% if tmpl_key != "flipping_items" and show_labor %}
    <hr class="my-4">

    <!-- Labor / Services -->
    {% if tmpl_key != "flipping_items" %}
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h5 fw-bold mb-0">{{ labor_title }}</h2>
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addLaborRow()">
          Add Item
        </button>
      </div>

      <div class="table-responsive">
        <table class="table table-sm align-middle" id="laborTable">
          <thead class="table-light">
            <tr>
              <th style="min-width: 280px;">{{ labor_desc_label }}</th>
              <th style="width: 180px;">Time (hrs)</th>
              <th style="width: 80px;"></th>
            </tr>
          </thead>
          <tbody>
            {% if mode == "edit" %}
              {% for li in inv.labor_items %}
                <tr>
                  <td><input class="form-control" name="labor_desc" value="{{ li.labor_desc }}"></td>
                  <td><input class="form-control" name="labor_time_hours" inputmode="decimal" value="{{ li.labor_time_hours }}"></td>
                  <td class="text-end">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">Remove</button>
                  </td>
                </tr>
              {% endfor %}
            {% endif %}

            <tr>
              <td><input class="form-control" name="labor_desc" placeholder="{{ labor_placeholder }}"></td>
              <td><input class="form-control" name="labor_time_hours" inputmode="decimal" placeholder="ex. 1.5 hrs"></td>
              <td class="text-end">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">Remove</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    {% endif %}
    {% endif %}

    <hr class="my-4">

    <!-- Notes -->
    <div class="mb-3">
      <label class="form-label">Notes</label>
      <textarea class="form-control" name="notes" rows="6"
        placeholder="One note per line (recommended).">{% if mode=='edit' %}{{ inv.notes }}{% else %}{{ (form.notes if form else '') }}{% endif %}</textarea>
      <div class="small-muted mt-1">These notes will wrap nicely in the PDF.</div>
    </div>

    <div class="mb-3">
      <label class="form-label">Useful Information</label>
      <textarea class="form-control" name="useful_info" id="usefulInfo" rows="4"
        placeholder="Links or notes to help you keep track.">{% if mode=='edit' %}{{ inv.useful_info or '' }}{% else %}{{ (form.useful_info if form else '') }}{% endif %}</textarea>
      <div class="small-muted mt-1">This will not appear on the PDF.</div>
      <div class="mt-2" id="usefulInfoLinks" style="display:none;"></div>
    </div>

    <div class="d-flex gap-2">
      <button class="btn btn-primary" type="submit">
        {% if doc_type == "estimate" %}
          {% if mode == "new" %}Create Estimate{% else %}Save Estimate{% endif %}
        {% else %}
          {% if mode == "new" %}Create Invoice{% else %}Save Changes{% endif %}
        {% endif %}
      </button>
      <a class="btn btn-outline-secondary"
         href="{{ url_for('estimates') if doc_type == 'estimate' else url_for('customers_list') }}">
        Cancel
      </a>
    </div>

  </div>
</form>

<script>
  (function () {
    const form = document.getElementById("invoiceForm");
    const tzInput = document.getElementById("clientTzOffsetMinutes");
    const dateInput = document.getElementById("dateInInput");
    if (!tzInput) return;

    function currentOffsetMinutes() {
      return -new Date().getTimezoneOffset();
    }

    function formatLongDateLocal(d) {
      return new Intl.DateTimeFormat("en-US", {
        month: "long",
        day: "2-digit",
        year: "numeric",
      }).format(d);
    }

    tzInput.value = String(currentOffsetMinutes());

    if (dateInput && "{{ mode }}" === "new") {
      const currentVal = (dateInput.value || "").trim();
      const initialDefault = (dateInput.dataset.initialDefault || "").trim();
      if (!currentVal || (initialDefault && currentVal === initialDefault)) {
        dateInput.value = formatLongDateLocal(new Date());
      }
    }

    if (form) {
      form.addEventListener("submit", () => {
        tzInput.value = String(currentOffsetMinutes());
      });
    }
  })();

  function removeRow(btn) {
    const tr = btn.closest("tr");
    if (!tr) return;
    const tbody = tr.closest("tbody");
    tr.remove();
    if (tbody && tbody.closest("#partsTable")) {
      ensurePartTrailingBlank();
    } else if (tbody && tbody.closest("#laborTable")) {
      ensureLaborTrailingBlank();
    }
  }

  function titleCaseWords(value) {
    const acronyms = new Set([
      "OEM", "ACD", "ACDELCO", "GM", "FORD", "MOPAR", "VW", "BMW", "AUDI", "NAPA",
      "O2", "OBD", "OBD2", "ABS", "TPMS", "HVAC", "CV", "ATF", "DOT", "PS", "DIY",
      "LED", "HID", "DRL", "AWD", "RWD", "FWD", "4WD", "2WD", "12V", "24V", "EV",
      "AGM", "EGR", "PCV", "MAF", "MAP", "TPS", "IAC", "IAT", "ECU", "PCM", "TCM"
    ]);
    return (value || "")
      .toLowerCase()
      .replace(/\b([a-z])([a-z]*)/g, (m, first, rest) => first.toUpperCase() + rest)
      .replace(/\b([A-Za-z0-9]+)\b/g, (m) => {
        const key = m.toUpperCase();
        return acronyms.has(key) ? key : m;
      });
  }

  function addPartRow() {
    const tbody = document.querySelector("#partsTable tbody");
    if (!tbody) return;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input class="form-control" name="part_name" placeholder="{{ parts_name_label|e }}"></td>
      <td><input class="form-control" name="part_price" inputmode="decimal" placeholder="ex. 24.99"></td>
      <td class="text-end">
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">Remove</button>
      </td>
    `;
    tbody.appendChild(tr);
  }

  function addPartRowWithValues(name, price) {
    const tbody = document.querySelector("#partsTable tbody");
    if (!tbody) return;
    const tr = document.createElement("tr");

    const tdName = document.createElement("td");
    const nameInput = document.createElement("input");
    nameInput.className = "form-control";
    nameInput.name = "part_name";
    nameInput.value = titleCaseWords(name || "");
    tdName.appendChild(nameInput);

    const tdPrice = document.createElement("td");
    const priceInput = document.createElement("input");
    priceInput.className = "form-control";
    priceInput.name = "part_price";
    priceInput.setAttribute("inputmode", "decimal");
    priceInput.value = price || "";
    tdPrice.appendChild(priceInput);

    const tdAction = document.createElement("td");
    tdAction.className = "text-end";
    const removeBtn = document.createElement("button");
    removeBtn.type = "button";
    removeBtn.className = "btn btn-sm btn-outline-danger";
    removeBtn.textContent = "Remove";
    removeBtn.addEventListener("click", () => removeRow(removeBtn));
    tdAction.appendChild(removeBtn);

    tr.appendChild(tdName);
    tr.appendChild(tdPrice);
    tr.appendChild(tdAction);
    tbody.appendChild(tr);
  }

  function addLaborRow() {
    const tbody = document.querySelector("#laborTable tbody");
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input class="form-control" name="labor_desc" placeholder="{{ labor_desc_label|e }}"></td>
      <td><input class="form-control" name="labor_time_hours" inputmode="decimal" placeholder="ex. 1.5 hrs"></td>
      <td class="text-end">
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">Remove</button>
      </td>
    `;
    tbody.appendChild(tr);
  }

  function _isRowBlank(tr, fieldNames) {
    if (!tr) return true;
    for (const name of fieldNames) {
      const input = tr.querySelector(`input[name="${name}"]`);
      if (input && (input.value || "").trim() !== "") {
        return false;
      }
    }
    return true;
  }

  function _ensureTrailingBlankRow(tableSelector, addRowFn, fieldNames) {
    const tbody = document.querySelector(`${tableSelector} tbody`);
    if (!tbody) return;
    const rows = Array.from(tbody.querySelectorAll("tr"));
    const lastRow = rows[rows.length - 1];
    if (!lastRow || !_isRowBlank(lastRow, fieldNames)) {
      addRowFn();
    }
  }

  function ensurePartTrailingBlank() {
    _ensureTrailingBlankRow("#partsTable", addPartRow, ["part_name", "part_price"]);
  }

  function ensureLaborTrailingBlank() {
    _ensureTrailingBlankRow("#laborTable", addLaborRow, ["labor_desc", "labor_time_hours"]);
  }

  // -----------------------------
  // Client typeahead → set hidden customer_id
  // AND auto-fill email/phone from client profile (if override fields are blank)
  // -----------------------------
  (function () {
    const nameInput = document.getElementById("customer_name");
    const idInput = document.getElementById("customer_id");
    const dl = document.getElementById("customers_datalist");
    const emailInput = document.getElementById("customer_email");
    const phoneInput = document.getElementById("customer_phone");
    const formatPhone = (value) => {
      const digits = (value || "").replace(/\D/g, "").slice(0, 10);
      if (!digits) return "";
      let formatted = `(${digits.slice(0, Math.min(3, digits.length))}`;
      if (digits.length >= 4) {
        formatted += `) ${digits.slice(3, Math.min(6, digits.length))}`;
      }
      if (digits.length >= 7) {
        formatted += `-${digits.slice(6, 10)}`;
      }
      return formatted;
    };

    const nameToId = {};
    if (dl) {
      const opts = dl.querySelectorAll("option");
      opts.forEach(opt => {
        const n = (opt.value || "").trim();
        const id = (opt.getAttribute("data-id") || "").trim();
        if (n && id && !nameToId[n.toLowerCase()]) {
          nameToId[n.toLowerCase()] = id;
        }
      });
    }

    const idToClient = {};
    if (Array.isArray(CUSTOMERS)) {
      CUSTOMERS.forEach(c => {
        if (c && c.id != null) idToClient[String(c.id)] = c;
      });
    }

    function fillContactFromClientId() {
      if (!idInput.value) return;
      const c = idToClient[String(idInput.value)];
      if (!c) return;

      if (emailInput && !(emailInput.value || "").trim()) {
        emailInput.value = (c.email || "").trim();
      }
      if (phoneInput && !(phoneInput.value || "").trim()) {
        phoneInput.value = formatPhone((c.phone || "").trim());
      }
    }

    function syncClientId() {
      const v = (nameInput.value || "").trim().toLowerCase();
      if (!v) {
        idInput.value = "";
        return;
      }
      if (nameToId[v]) {
        idInput.value = nameToId[v];
        fillContactFromClientId();
      } else {
        idInput.value = "";
      }
    }

    if (nameInput) {
      nameInput.addEventListener("input", syncClientId);
      nameInput.addEventListener("change", syncClientId);
      nameInput.addEventListener("blur", syncClientId);
    }
    if (phoneInput) {
      phoneInput.value = formatPhone(phoneInput.value);
      phoneInput.addEventListener("input", () => {
        phoneInput.value = formatPhone(phoneInput.value);
      });
    }

    const form = document.getElementById("invoiceForm");
    if (form) {
      form.addEventListener("submit", function (e) {
        syncClientId();
        if (!idInput.value) {
          e.preventDefault();
          alert("Please select an existing client (choose one from the suggestions).");
          nameInput.focus();
        }
      });
    }

    syncClientId();
    fillContactFromClientId();
  })();

  (function () {
    document.addEventListener("input", (e) => {
      if (!e.target || !e.target.name) return;
      if (e.target.name === "part_name" || e.target.name === "part_price") {
        ensurePartTrailingBlank();
      } else if (e.target.name === "labor_desc" || e.target.name === "labor_time_hours") {
        ensureLaborTrailingBlank();
      }
    });

    ensurePartTrailingBlank();
    ensureLaborTrailingBlank();
  })();

  (function () {
    const params = new URLSearchParams(window.location.search);
    const ids = (params.get("add_expense_ids") || "").trim();
    if (!ids) return;

    fetch(`/api/business-expense-entries?ids=${encodeURIComponent(ids)}`)
      .then((r) => r.json())
      .then((data) => {
        const items = (data && Array.isArray(data.items)) ? data.items : [];
        items.forEach((it) => {
          const name = (it && it.name) ? String(it.name) : "";
          const price = (it && typeof it.price !== "undefined") ? String(Number(it.price).toFixed(2)) : "";
          addPartRowWithValues(name, price);
        });
        ensurePartTrailingBlank();
        if (items.length) {
          params.delete("add_expense_ids");
          const qs = params.toString();
          const clean = `${window.location.pathname}${qs ? ("?" + qs) : ""}`;
          window.history.replaceState({}, "", clean);
        }
      })
      .catch(() => {});
  })();

  (function () {
    const input = document.getElementById("usefulInfo");
    const linkWrap = document.getElementById("usefulInfoLinks");
    if (!input || !linkWrap) return;

    function normalizeUrl(raw) {
      const trimmed = raw.trim();
      if (!trimmed) return null;
      if (/^https?:\/\//i.test(trimmed)) return trimmed;
      if (/^www\./i.test(trimmed)) return `https://${trimmed}`;
      return null;
    }

    function updateLinks() {
      const text = input.value || "";
      const urls = text.match(/\b(https?:\/\/[^\s]+|www\.[^\s]+)\b/gi) || [];
      const links = urls.map(normalizeUrl).filter(Boolean);
      if (!links.length) {
        linkWrap.innerHTML = "";
        linkWrap.style.display = "none";
        return;
      }
      linkWrap.style.display = "block";
      linkWrap.innerHTML = `
        <div class="small-muted mb-1">Detected links:</div>
        ${links.map((url) => `<div><a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a></div>`).join("")}
      `;
    }

    input.addEventListener("input", updateLinks);
    updateLinks();
  })();

  (function () {
    const totalInput = document.getElementById("laborHoursTotal");
    const hiddenInput = document.getElementById("laborHoursHidden");
    if (!totalInput || !hiddenInput) return;

    function parseHours(val) {
      const n = parseFloat(String(val || "").replace(",", "."));
      return Number.isFinite(n) ? n : 0;
    }

    function recalcLaborHours() {
      const inputs = document.querySelectorAll("input[name='labor_time_hours']");
      let sum = 0;
      inputs.forEach((inp) => {
        sum += parseHours(inp.value);
      });
      const rounded = Math.round(sum * 100) / 100;
      totalInput.value = rounded ? String(rounded) : "0";
      hiddenInput.value = String(rounded);
    }

    document.addEventListener("input", (e) => {
      if (e.target && e.target.name === "labor_time_hours") {
        recalcLaborHours();
      }
    });

    recalcLaborHours();
  })();

  (function () {
    function applyTitleCaseInput(e) {
      if (!e.target || e.target.name !== "part_name") return;
      const start = e.target.selectionStart;
      const end = e.target.selectionEnd;
      const updated = titleCaseWords(e.target.value);
      if (updated !== e.target.value) {
        e.target.value = updated;
        if (typeof start === "number" && typeof end === "number") {
          e.target.setSelectionRange(start, end);
        }
      }
    }

    document.addEventListener("input", applyTitleCaseInput);
  })();
</script>

{% endblock %}
